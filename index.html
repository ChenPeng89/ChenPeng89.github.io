<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="ChenPeng's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="ChenPeng's Blog">
<meta property="og:url" content="http://chenpeng89.github.io/index.html">
<meta property="og:site_name" content="ChenPeng's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ChenPeng's Blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6332319628039030000,
      author: '����'
    }
  };
</script>

  <title> ChenPeng's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">ChenPeng's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/07/Elasticsearch学习笔记：五、Indices-APIs/" itemprop="url">
                  Elasticsearch学习笔记：五、Indices APIs
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-07T10:03:53+08:00" content="2017-02-07">
              2017-02-07
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/Elasticsearch学习笔记：四、Search-APIs/" itemprop="url">
                  Elasticsearch学习笔记：四、Search-APIs
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-11-21T10:30:17+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>当执行搜索时，将会对所有索引分片进行广播（轮询所有备份）。这个可以通过设置 routing 参数来指定搜索的分片。<br>例如，在创建索引时可以指定routing：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ curl -XPOST &apos;http://localhost:9200/twitter/tweet?routing=kimchy&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;postDate&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure></p>
<p>然后我们在后面查询时指定相应routing：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ curl -XGET &apos;http://localhost:9200/twitter/tweet/_search?routing=kimchy&apos; -d &apos;&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;bool&quot; : &#123;</div><div class="line">            &quot;must&quot; : &#123;</div><div class="line">                &quot;query_string&quot; : &#123;</div><div class="line">                    &quot;query&quot; : &quot;some query string here&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;filter&quot; : &#123;</div><div class="line">                &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure></p>
<p>routing参数可以设置为多个，用 , 隔开。</p>
<h3 id="Stats-Group"><a href="#Stats-Group" class="headerlink" title="Stats Group"></a>Stats Group</h3><p>还可以关联数据组，数据组可以通过后面index API中的indices stats API 来设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match_all&quot; : &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;stats&quot; : [&quot;group1&quot;, &quot;group2&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Global-Search-Timeout"><a href="#Global-Search-Timeout" class="headerlink" title="Global Search Timeout"></a>Global Search Timeout</h3><p>es可以设置一个集群级的超时时间，在<code>search.default_search_timeout</code> 中，设为-1 的话表示没有超时时间。</p>
<h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><h3 id="Multi-Index，Multi-Type"><a href="#Multi-Index，Multi-Type" class="headerlink" title="Multi-Index，Multi-Type"></a>Multi-Index，Multi-Type</h3><p>所有search APIs 都可以跨 index和type来进行查询。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /twitter/_search?q=user:kimchy</div></pre></td></tr></table></figure></p>
<p>也可以指定多个type:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /twitter/tweet,user/_search?q=user:kimchy</div></pre></td></tr></table></figure></p>
<p>还可以通过一个tag来搜索相关的几个index:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /kimchy,elasticsearch/tweet/_search?q=tag:wow</div></pre></td></tr></table></figure></p>
<p>或者搜索所有index，使用_all：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_all/tweet/_search?q=tag:wow</div></pre></td></tr></table></figure></p>
<p>甚至所有index和type：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_search?q=tag:wow</div></pre></td></tr></table></figure></p>
<p>默认情况下，es会拒绝搜索超过1000个分片的查询。因为这会严重影响es的性能。通常的做法是，将分片设置的更大，数量更少，可以通过<code>action.search.shard_count.limit</code>来设置。</p>
<h2 id="URI-Search"><a href="#URI-Search" class="headerlink" title="URI Search"></a>URI Search</h2><p>一个搜索请求可以通过URI中带有参数来实现，当然，并不是所有搜索都能使用这个模式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_search?q=user:kimchy</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 38,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 1.4054651,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AViEvWlRDD544hrngUp_&quot;,</div><div class="line">        &quot;_score&quot;: 1.4054651,</div><div class="line">        &quot;_routing&quot;: &quot;kimchy&quot;,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;user&quot;: &quot;kimchy&quot;,</div><div class="line">          &quot;postDate&quot;: &quot;2009-11-15T14:12:12&quot;,</div><div class="line">          &quot;message&quot;: &quot;trying out Elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul>
<li>q: 查询字符串。</li>
<li>df: 在查询中没定义字段时默认使用的字段。</li>
<li>analyzer ： 指定使用的查询分析器。</li>
<li>lowercase_expanded_terms ： 瓷套是否自动变成小写。默认是true。</li>
<li>analyze_wildcard ： 通配符和前缀查询是否要被分析器分析。默认是false。</li>
<li>default_operator ： 默认的操作符，AND /OR ，默认是OR。</li>
<li>lenient : 如果设置为true，则会忽略类型错误，比如向数字字段传文本数据。</li>
<li>explain : 对于所有命中的数据，计算命中分数。</li>
<li>_source： 返回的结果中是否包含source。还可以设置source中的字段。</li>
<li>stored_fields ： 选择命中后返回的字段，使用 ， 分隔。</li>
<li>sort ： 排序。</li>
<li>track_scores : 当设置sort时，将它设为true，将会返回track score。</li>
<li>timeout： 超时时间。默认是没有超时时间。</li>
<li>terminate_after :  一个Shard可以在获取到多少条数据后，停止查询。</li>
<li>from/size : 分页参数。</li>
<li>search_type : search的类型：dfs_query_then_fetch和query_then_fetch。默认是后者。</li>
</ul>
<h2 id="Request-Body-Search"><a href="#Request-Body-Search" class="headerlink" title="Request Body Search"></a>Request Body Search</h2><p>search请求可以通过search DSL ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /twitter/tweet/_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 856,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 1.4054651,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AViEvWlRDD544hrngUp_&quot;,</div><div class="line">        &quot;_score&quot;: 1.4054651,</div><div class="line">        &quot;_routing&quot;: &quot;kimchy&quot;,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;user&quot;: &quot;kimchy&quot;,</div><div class="line">          &quot;postDate&quot;: &quot;2009-11-15T14:12:12&quot;,</div><div class="line">          &quot;message&quot;: &quot;trying out Elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="快速确定是否有匹配的文档"><a href="#快速确定是否有匹配的文档" class="headerlink" title="快速确定是否有匹配的文档"></a>快速确定是否有匹配的文档</h3><p>如果我们只是想查看是否有匹配的文档，而不在乎返回的数据，可以将size设为0。还可以将termnate_after设为1。在查找到第一条后不再进行搜索。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_search?q=message:elasticsearch&amp;size=0&amp;terminate_after=1</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 846,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;terminated_early&quot;: true,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 36,</div><div class="line">    &quot;successful&quot;: 36,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: []</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><p>在request body中可以使用query DSL定义查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="From-Size"><a href="#From-Size" class="headerlink" title="From/Size"></a>From/Size</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;from&quot; : 0, &quot;size&quot; : 10,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Sort"><a href="#Sort" class="headerlink" title="Sort"></a>Sort</h3><p>可以将一个或者多个字段进行排序。每个排序都可以正序倒序。排序定义在字段级别，可以通过指定字段名进行评分_score，并根据评分进行排序。或者_doc来根据索引顺序排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">PUT  localhost:9200/my_index</div><div class="line">&#123;</div><div class="line">    &quot;mappings&quot;: &#123;</div><div class="line">        &quot;my_type&quot;: &#123;</div><div class="line">            &quot;properties&quot;: &#123;</div><div class="line">                &quot;post_date&quot;: &#123; &quot;type&quot;: &quot;date&quot; &#125;,</div><div class="line">                &quot;user&quot;: &#123;</div><div class="line">                    &quot;type&quot;: &quot;string&quot;</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot;: &#123;</div><div class="line">                    &quot;type&quot;: &quot;string&quot;</div><div class="line">                &#125;,</div><div class="line">                &quot;age&quot;: &#123; &quot;type&quot;: &quot;integer&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查询时，可以设置每个字段的排序方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">POST localhost:9200/my_index/my_type/_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123; &quot;post_date&quot; : &#123;&quot;order&quot; : &quot;asc&quot;&#125;&#125;,</div><div class="line">        &quot;user&quot;,</div><div class="line">        &#123; &quot;name&quot; : &quot;desc&quot; &#125;,</div><div class="line">        &#123; &quot;age&quot; : &quot;desc&quot; &#125;,</div><div class="line">        &quot;_score&quot;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一般来说，_doc没有实际的用处。但是，如果你不需要进行排序的话，按_doc排序是会增加处理效率的，因此，如果你不关心文档的返回顺序，你可以指定按_doc来排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST localhost:9200/my_index/my_type/_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        </div><div class="line">        &quot;_doc&quot;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="排序参数"><a href="#排序参数" class="headerlink" title="排序参数"></a>排序参数</h4><p>es支持按照数组排序或者多个值进行排序。mode 选项控制了选择类型为数组的字段中的哪个值来进行排序。有以下值：</p>
<ul>
<li>min 最小值</li>
<li>max 最大值</li>
<li>sum 总和</li>
<li>avg 平均值</li>
<li>median 中间值</li>
</ul>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PUT /my_index/my_type/1?refresh</div><div class="line">&#123;</div><div class="line">   &quot;product&quot;: &quot;chocolate&quot;,</div><div class="line">    &quot;price&quot;: [20, 4]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>排序操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST /_search</div><div class="line">&#123;</div><div class="line">   &quot;query&quot; : &#123;</div><div class="line">      &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</div><div class="line">   &#125;,</div><div class="line">   &quot;sort&quot; : [</div><div class="line">      &#123;&quot;price&quot; : &#123;&quot;order&quot; : &quot;asc&quot;, &quot;mode&quot; : &quot;avg&quot;&#125;&#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="对内嵌对象进行排序"><a href="#对内嵌对象进行排序" class="headerlink" title="对内嵌对象进行排序"></a>对内嵌对象进行排序</h4><p>es也支持对内嵌对象的字段进行排序。</p>
<ul>
<li>nested_path 定义进行排序的内嵌对象的路径。进行排序的字段必须在这个对象中。</li>
<li>nested_filter 针对内嵌对象的一个过滤器。</li>
</ul>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">POST /_search</div><div class="line">&#123;</div><div class="line">   &quot;query&quot; : &#123;</div><div class="line">      &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</div><div class="line">   &#125;,</div><div class="line">   &quot;sort&quot; : [</div><div class="line">       &#123;</div><div class="line">          &quot;offer.price&quot; : &#123;</div><div class="line">             &quot;mode&quot; :  &quot;avg&quot;,</div><div class="line">             &quot;order&quot; : &quot;asc&quot;,</div><div class="line">             &quot;nested_path&quot; : &quot;offer&quot;,</div><div class="line">             &quot;nested_filter&quot; : &#123;</div><div class="line">                &quot;term&quot; : &#123; &quot;offer.color&quot; : &quot;blue&quot; &#125;</div><div class="line">             &#125;</div><div class="line">          &#125;</div><div class="line">       &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面针对offer里面的price的平均值进行升序排序，并限定了offer的color字段为blue。</p>
<h4 id="针对字段为空的文档的处理"><a href="#针对字段为空的文档的处理" class="headerlink" title="针对字段为空的文档的处理"></a>针对字段为空的文档的处理</h4><p>missing参数可以设置当某个字段为空时，在排序时怎么控制文档的位置。它有以下参数：_last和_first或者自定义的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123; &quot;price&quot; : &#123;&quot;missing&quot; : &quot;_last&quot;&#125; &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面将没有price字段的文档放到最后。</p>
<font color="red"><strong>注意：如果内嵌对象不满足nested_filter时，也将使用missing 参数的值。</strong></font>

<h4 id="忽略UnMapped-字段"><a href="#忽略UnMapped-字段" class="headerlink" title="忽略UnMapped 字段"></a>忽略UnMapped 字段</h4><p>默认情况下，如果相关的字段没有进行mapping，那么search请求将会失败。unmapped-type参数用来决定使用什么值来进行排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123; &quot;price&quot; : &#123;&quot;unmapped_type&quot; : &quot;long&quot;&#125; &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子的意思是，如果当price没有进行mapping操作，那么，将会把它视为 long 来进行处理。</p>
<h4 id="经纬度距离排序"><a href="#经纬度距离排序" class="headerlink" title="经纬度距离排序"></a>经纬度距离排序</h4><p>可以根据经纬度位置上的距离来排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : [-70, 40],</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;,</div><div class="line">                &quot;mode&quot; : &quot;min&quot;,</div><div class="line">                &quot;distance_type&quot; : &quot;sloppy_arc&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参数：</p>
<ul>
<li>distance_type：如何计算距离，包括sloppy（默认的），arc（更精准但是更慢）和plane（很快，但是对于长距离和接近两极的计算不准确）。</li>
<li>mode：当一个字段有多个经纬度的时候怎么办。默认的话，升序排序的时候考虑最近的，降序排序的时候考虑最远的。有min，max，median和avg等。</li>
<li>unit：用来计算的单位。默认是m（米）。</li>
</ul>
<h4 id="经纬度作为参数"><a href="#经纬度作为参数" class="headerlink" title="经纬度作为参数"></a>经纬度作为参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : &#123;</div><div class="line">                    &quot;lat&quot; : 40,</div><div class="line">                    &quot;lon&quot; : -70</div><div class="line">                &#125;,</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="经纬度是string"><a href="#经纬度是string" class="headerlink" title="经纬度是string"></a>经纬度是string</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : &quot;40,-70&quot;,</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="地理位置是hash值"><a href="#地理位置是hash值" class="headerlink" title="地理位置是hash值"></a>地理位置是hash值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : &quot;drm3btev3e86&quot;,</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="经纬度是数组"><a href="#经纬度是数组" class="headerlink" title="经纬度是数组"></a>经纬度是数组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : [-70, 40],</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="多个参考点"><a href="#多个参考点" class="headerlink" title="多个参考点"></a>多个参考点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_geo_distance&quot; : &#123;</div><div class="line">                &quot;pin.location&quot; : [[-70, 40], [-71, 42]],</div><div class="line">                &quot;order&quot; : &quot;asc&quot;,</div><div class="line">                &quot;unit&quot; : &quot;km&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终，这个经纬度的排序会按mode的那几个参数来进行。</p>
<h4 id="基于脚本的排序"><a href="#基于脚本的排序" class="headerlink" title="基于脚本的排序"></a>基于脚本的排序</h4><p>可以基于脚本进行排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;sort&quot; : &#123;</div><div class="line">        &quot;_script&quot; : &#123;</div><div class="line">            &quot;type&quot; : &quot;number&quot;,</div><div class="line">            &quot;script&quot; : &#123;</div><div class="line">                &quot;lang&quot;: &quot;painless&quot;,</div><div class="line">                &quot;inline&quot;: &quot;doc[&apos;field_name&apos;].value * params.factor&quot;,</div><div class="line">                &quot;params&quot; : &#123;</div><div class="line">                    &quot;factor&quot; : 1.1</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;order&quot; : &quot;asc&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="计算得分"><a href="#计算得分" class="headerlink" title="计算得分"></a>计算得分</h4><p>当按照字段来排序时，分数是不会被计算的。可以设置 track_scores为true来计算分数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;track_scores&quot;: true,</div><div class="line">    &quot;sort&quot; : [</div><div class="line">        &#123; &quot;post_date&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;,</div><div class="line">        &#123; &quot;name&quot; : &quot;desc&quot; &#125;,</div><div class="line">        &#123; &quot;age&quot; : &quot;desc&quot; &#125;</div><div class="line">    ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="针对内存方面的考虑"><a href="#针对内存方面的考虑" class="headerlink" title="针对内存方面的考虑"></a>针对内存方面的考虑</h4><p>当执行排序时，排序相关的字段都会被加载到内存中。这就意味着，每个分片都应该有足够的内存来容纳它们。对于string类型，字段排序不应该进行 analyzed/tokenized 操作。对于数字类型，如果可能，尽量将它们设置为具体的类型（short、integer和float等）。</p>
<h3 id="Source-filtering"><a href="#Source-filtering" class="headerlink" title="Source filtering"></a>Source filtering</h3><p>允许控制_source的命中返回。<br>一般操作都将返回_source，除非你使用stored_fields 或者将_source设为false。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;_source&quot;: false,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以设置哪些字段返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;_source&quot;: &quot;obj.*&quot;,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;_source&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终，为了完全控制，还可以通过 includes 和excludes来设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;_source&quot;: &#123;</div><div class="line">        &quot;includes&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</div><div class="line">        &quot;excludes&quot;: [ &quot;*.description&quot; ]</div><div class="line">    &#125;,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><p>stored_fields参数是针对已经明确mapping过的，一般不体检使用。可以使用 source filtering来代替。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;stored_fields&quot; : [&quot;user&quot;, &quot;postDate&quot;],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果想加载所有的字段，可以用 * 。<br>如果设置为空数组，那么如果命中，将只返回_id 和 _type。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;stored_fields&quot; : [],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果没有需要的字段，它将会被忽略。</p>
<h4 id="不使用存储的字段"><a href="#不使用存储的字段" class="headerlink" title="不使用存储的字段"></a>不使用存储的字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;stored_fields&quot;: &quot;_none_&quot;,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不使用存储的字段，可以使用<em>none</em></p>
<h3 id="Script-Fields"><a href="#Script-Fields" class="headerlink" title="Script Fields"></a>Script Fields</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match_all&quot;: &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;script_fields&quot; : &#123;</div><div class="line">        &quot;test1&quot; : &#123;</div><div class="line">            &quot;script&quot; : &#123;</div><div class="line">             </div><div class="line">                &quot;inline&quot;: &quot;doc[&apos;my_field_name&apos;].value * 2&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;test2&quot; : &#123;</div><div class="line">            &quot;script&quot; : &#123;</div><div class="line">               </div><div class="line">                &quot;inline&quot;: &quot;doc[&apos;my_field_name&apos;].value * factor&quot;,</div><div class="line">                &quot;params&quot; : &#123;</div><div class="line">                    &quot;factor&quot;  : 2.0</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>script_fields 能够操作没存储的字段，并且允许人为定义其返回值。<br>script_fields 还可以访问年实际存在的 _source 文档，并且指定返回的元素：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">    &#123;</div><div class="line">        &quot;query&quot; : &#123;</div><div class="line">            &quot;match_all&quot;: &#123;&#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;script_fields&quot; : &#123;</div><div class="line">            &quot;test1&quot; : &#123;</div><div class="line">                &quot;script&quot; : &quot;_source.obj1.obj2&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>理解doc[‘my_field’].value 和 _source.my_field 的区别是很重要的。首先，使用doc，将会导致字段加载进内存，需要更多的内存消耗，但是会获得更快的响应速度。另外，doc[…]符号只允许简单的值的字段，不允许json object类型。<br>_source只返回json相关的部分。</p>
<h3 id="Doc-value-Fields"><a href="#Doc-value-Fields" class="headerlink" title="Doc value Fields"></a>Doc value Fields</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match_all&quot;: &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;docvalue_fields&quot; : [&quot;test1&quot;, &quot;test2&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>docvalue_fields 能够用于没有存储的字段上。<br>值得注意的是，如果字段的参数制定了没有docvalues的字段，将会从字段数据的缓存中加载值并导致字段中的所有词条加载到内存中，造成更多的内存消耗。</p>
<h3 id="Post-filter"><a href="#Post-filter" class="headerlink" title="Post filter"></a>Post filter</h3><p>post_filter 用来搜索每个hits，在聚合运算之后。下面是一个解释的例子：</p>
<p>加入你卖衬衫：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">PUT /shirts</div><div class="line">&#123;</div><div class="line">    &quot;mappings&quot;: &#123;</div><div class="line">        &quot;item&quot;: &#123;</div><div class="line">            &quot;properties&quot;: &#123;</div><div class="line">                &quot;brand&quot;: &#123; &quot;type&quot;: &quot;string&quot;&#125;,</div><div class="line">                &quot;color&quot;: &#123; &quot;type&quot;: &quot;string&quot;&#125;,</div><div class="line">                &quot;model&quot;: &#123; &quot;type&quot;: &quot;string&quot;&#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PUT /shirts/item/1?refresh</div><div class="line">&#123;</div><div class="line">    &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">    &quot;color&quot;: &quot;red&quot;,</div><div class="line">    &quot;model&quot;: &quot;slim&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>想象一下，一个用户制定了两个搜索条件：<br>color:red 和 brand:gucci 。通常，你可以使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET /shirts/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;filter&quot;: [</div><div class="line">        &#123; &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot;   &#125;&#125;,</div><div class="line">        &#123; &quot;term&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125;&#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果时这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 120,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然而，你还想要展示一系列的选项来让用户点击查询。例如，你有一个model 字段来希望用户进一步查询是 red gucci 的t-shirts 还是dress-shirts，这可以使用terms aggregation来实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">GET /shirts/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;filter&quot;: [</div><div class="line">        &#123; &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot;   &#125;&#125;,</div><div class="line">        &#123; &quot;term&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125;&#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;models&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;model&quot; &#125; </div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 73,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;models&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;slim&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是，有可能你邮箱告诉user还有多少其他颜色的gucci shirts。如果你仅仅添加一个terms 的aggregation在color字段，你只能得到color为red的，因为你的查询只返回了red gucci shirts。</p>
<p>解决方法是，你想要查询所有color的shirts，先通过聚合，然后使用color的filter来对查询结果进一步过滤，这就是post_filter的用处：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">GET /shirts/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;term&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;color&quot; &#125; </div><div class="line">    &#125;,</div><div class="line">    &quot;color_red&quot;: &#123;</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125; </div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;models&quot;: &#123;</div><div class="line">          &quot;terms&quot;: &#123; &quot;field&quot;: &quot;model&quot; &#125; </div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;post_filter&quot;: &#123; </div><div class="line">    &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 20,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;color_red&quot;: &#123;</div><div class="line">      &quot;doc_count&quot;: 1,</div><div class="line">      &quot;models&quot;: &#123;</div><div class="line">        &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">        &quot;sum_other_doc_count&quot;: 0,</div><div class="line">        &quot;buckets&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;key&quot;: &quot;slim&quot;,</div><div class="line">            &quot;doc_count&quot;: 1</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;colors&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;red&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Highlighting"><a href="#Highlighting" class="headerlink" title="Highlighting"></a>Highlighting</h3><p>可以对搜索结果的一个或多个字段进行高亮处理。具体是使用Lucene的plain highlighter ， fast vector highting 和 posting highlighter实现的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;user&quot;: &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;content&quot; : &#123;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的例子中，content字段就是对于每个命中的结果进行高亮的字段。</p>
<h4 id="Plain-highlighter"><a href="#Plain-highlighter" class="headerlink" title="Plain highlighter"></a>Plain highlighter</h4><p>默认的高亮方式是通过plain，也就是使用的Lucene的highlighter。它力图反映查询匹配的逻辑中单词理解的重要性和短语查询中单词的定位标准。</p>
<p>如果你想要通过复杂的查询来高亮很多文档中的很多字段，那么它不会很快。因为在执行时，它会创建一个小的内存空间并使用Lucene的查询重新搜索一遍将要被高亮的字段。</p>
<h4 id="Postings-highlighter"><a href="#Postings-highlighter" class="headerlink" title="Postings highlighter"></a>Postings highlighter</h4><p>如果在mapping中将 index_options 设置为 offsets，那么将会使用postings highlighter 来代替 plain highlighter。postings highlighter有以下特点：</p>
<ul>
<li>响应比较快，因为他不需要重新分析将被高亮的文本，越大的文件响应速度越快。</li>
<li>比term_vectors 需要更少的硬盘空间，需要fast vector highlighter。</li>
<li>可以将文本分成句子并高亮他们。对于自然语言发挥得很好,但是不包含例如html标记的字段。</li>
<li>将文档视为整个文章，使用BM25算法score每个单独的句子。</li>
</ul>
<p>Elasticsearch中需要在建立索引的时候映射字段类型，才可以实现postings-highlighter高亮显示，例如对content字段采用postings高亮类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;type_name&quot; : &#123;</div><div class="line">        &quot;content&quot; : &#123;&quot;type&quot;:&quot;string&quot;,&quot;index_options&quot; : &quot;offsets&quot;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>值得注意的是，postings highlighter 意味着针对简单查询的词条高亮，而不管它们的位置。这意味着，当与短语查询结合使用时，它将高亮构成查询的所有词条，而不管它们是否实际上是查询匹配的一部分，从而有效地忽略了它们的位置。</p>
<p>postings highlighter 不支持高亮一些复杂的查询，比如将type设置match_phrase_prefix的match查询。这种情况下没有被高亮的段落返回。</p>
<h4 id="Fast-vector-highlighter"><a href="#Fast-vector-highlighter" class="headerlink" title="Fast vector highlighter"></a>Fast vector highlighter</h4><p>当mapping中设置term_vector为with_positions_offsets，将会用fast vector highlighter 代替 plain highlighter。<br>特点：</p>
<ul>
<li>快，尤其对于大于1M的字段。</li>
<li>可定制的boundary_chars，boundary_max_scan，和fragment_offset。</li>
<li>需要设置term_vector的值为with_positions_offsets，这会增加索引的大小。</li>
<li>可以将多个字段的匹配组合成一个结果。</li>
<li>可以为不同位置的短语分配不同的权重。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;type_name&quot; : &#123;</div><div class="line">        &quot;content&quot; : &#123;&quot;term_vector&quot; : &quot;with_positions_offsets&quot;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Force-highlighter-type"><a href="#Force-highlighter-type" class="headerlink" title="Force highlighter type"></a>Force highlighter type</h4><p>可以对指定的字段类型进行高亮。这对于要使用term_vectors对字段进行高亮非常有用。可以允许的类型为：plain，postings和fvh。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;brand&quot; : &#123;&quot;type&quot; : &quot;plain&quot;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>响应：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 18,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0.30685282,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0.30685282,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;highlight&quot;: &#123;</div><div class="line">          &quot;brand&quot;: [</div><div class="line">            &quot;&lt;em&gt;gucci&lt;/em&gt;&quot;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Force-highlighter-on-source"><a href="#Force-highlighter-on-source" class="headerlink" title="Force highlighter on source"></a>Force highlighter on source</h4><p>强制高亮source中的字段，即使字段被分开存储。默认是false。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;brand&quot; : &#123;&quot;force_source&quot; : true&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样返回的内容是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 130,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0.30685282,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0.30685282,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;highlight&quot;: &#123;</div><div class="line">          &quot;brand&quot;: [</div><div class="line">            &quot;&lt;em&gt;gucci&lt;/em&gt;&quot;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Highlighting-tags"><a href="#Highlighting-tags" class="headerlink" title="Highlighting tags"></a>Highlighting tags</h4><p>默认情况下，被高亮的文本的包围标签是<em></em>，这个可以自定义设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;pre_tags&quot; : [&quot;&lt;tag1&gt;&quot;],</div><div class="line">        &quot;post_tags&quot; : [&quot;&lt;/tag1&gt;&quot;],</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;brand&quot; : &#123;&quot;force_source&quot; : true&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>响应：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 3,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0.30685282,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0.30685282,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;highlight&quot;: &#123;</div><div class="line">          &quot;brand&quot;: [</div><div class="line">            &quot;&lt;tag1&gt;gucci&lt;/tag1&gt;&quot;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用fast vector highlighter 能够使用更多的tag。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;user&quot;: &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;pre_tags&quot; : [&quot;&lt;tag1&gt;&quot;, &quot;&lt;tag2&gt;&quot;],</div><div class="line">        &quot;post_tags&quot; : [&quot;&lt;/tag1&gt;&quot;, &quot;&lt;/tag2&gt;&quot;],</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;_all&quot; : &#123;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以使用样式，例如想实现这样的样式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;em class=&quot;hlt1&quot;&gt;, &lt;em class=&quot;hlt2&quot;&gt;, &lt;em class=&quot;hlt3&quot;&gt;,</div><div class="line">&lt;em class=&quot;hlt4&quot;&gt;, &lt;em class=&quot;hlt5&quot;&gt;, &lt;em class=&quot;hlt6&quot;&gt;,</div><div class="line">&lt;em class=&quot;hlt7&quot;&gt;, &lt;em class=&quot;hlt8&quot;&gt;, &lt;em class=&quot;hlt9&quot;&gt;,</div><div class="line">&lt;em class=&quot;hlt10&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>可以这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;user&quot;: &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;tags_schema&quot; : &quot;styled&quot;,</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;content&quot; : &#123;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h4><p>encoder参数用于定义highlighter的文本是怎样的编码。可以是default或者html。</p>
<h4 id="Highlighted-Fragments"><a href="#Highlighted-Fragments" class="headerlink" title="Highlighted Fragments"></a>Highlighted Fragments</h4><p>可以控制高亮字段的字符数大小，默认是100，还有最大片段数，默认是5:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;color&quot; : &#123;&quot;fragment_size&quot; : 1, &quot;number_of_fragments&quot; : 1&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当使用postings highlighter时，fragment_size会被忽略。<br>可以针对评分进行排序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">        	&quot;order&quot; : &quot;score&quot;,</div><div class="line">            &quot;color&quot; : &#123;&quot;force_source&quot; : true ,&quot;fragment_size&quot; : 1, &quot;number_of_fragments&quot; : 1&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Highlight-query"><a href="#Highlight-query" class="headerlink" title="Highlight query"></a>Highlight query</h4><p>使用 highlight_query 可以针对搜索结果进行高亮内的二次搜索。这对于如果你想对没有考虑高亮的查询进行重新评分查询是非常有用的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;stored_fields&quot;: [ &quot;_id&quot; ],</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">            &quot;content&quot;: &#123;</div><div class="line">                &quot;query&quot;: &quot;foo bar&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;rescore&quot;: &#123;</div><div class="line">        &quot;window_size&quot;: 50,</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;rescore_query&quot; : &#123;</div><div class="line">                &quot;match_phrase&quot;: &#123;</div><div class="line">                    &quot;content&quot;: &#123;</div><div class="line">                        &quot;query&quot;: &quot;foo bar&quot;,</div><div class="line">                        &quot;slop&quot;: 1</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;rescore_query_weight&quot; : 10</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;order&quot; : &quot;score&quot;,</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;content&quot; : &#123;</div><div class="line">                &quot;fragment_size&quot; : 150,</div><div class="line">                &quot;number_of_fragments&quot; : 3,</div><div class="line">                &quot;highlight_query&quot;: &#123;</div><div class="line">                    &quot;bool&quot;: &#123;</div><div class="line">                        &quot;must&quot;: &#123;</div><div class="line">                            &quot;match&quot;: &#123;</div><div class="line">                                &quot;content&quot;: &#123;</div><div class="line">                                    &quot;query&quot;: &quot;foo bar&quot;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;,</div><div class="line">                        &quot;should&quot;: &#123;</div><div class="line">                            &quot;match_phrase&quot;: &#123;</div><div class="line">                                &quot;content&quot;: &#123;</div><div class="line">                                    &quot;query&quot;: &quot;foo bar&quot;,</div><div class="line">                                    &quot;slop&quot;: 1,</div><div class="line">                                    &quot;boost&quot;: 10.0</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;,</div><div class="line">                        &quot;minimum_should_match&quot;: 0</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Global-Settings"><a href="#Global-Settings" class="headerlink" title="Global Settings"></a>Global Settings</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;user&quot;: &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;number_of_fragments&quot; : 3,</div><div class="line">        &quot;fragment_size&quot; : 150,</div><div class="line">        &quot;fields&quot; : &#123;</div><div class="line">            &quot;_all&quot; : &#123; &quot;pre_tags&quot; : [&quot;&lt;em&gt;&quot;], &quot;post_tags&quot; : [&quot;&lt;/em&gt;&quot;] &#125;,</div><div class="line">            &quot;bio.title&quot; : &#123; &quot;number_of_fragments&quot; : 0 &#125;,</div><div class="line">            &quot;bio.author&quot; : &#123; &quot;number_of_fragments&quot; : 0 &#125;,</div><div class="line">            &quot;bio.content&quot; : &#123; &quot;number_of_fragments&quot; : 5, &quot;order&quot; : &quot;score&quot; &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Require-Field-Match"><a href="#Require-Field-Match" class="headerlink" title="Require Field Match"></a>Require Field Match</h4><p>将require_field_match设为false可以导致不管查询是否匹配，都会高亮显示。默认是true，意味着只有匹配的才高亮显示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot;: &#123; &quot;user&quot;: &quot;kimchy&quot; &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot; : &#123;</div><div class="line">        &quot;require_field_match&quot;: false,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">                &quot;_all&quot; : &#123; &quot;pre_tags&quot; : [&quot;&lt;em&gt;&quot;], &quot;post_tags&quot; : [&quot;&lt;/em&gt;&quot;] &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Boundary-Characters"><a href="#Boundary-Characters" class="headerlink" title="Boundary Characters"></a>Boundary Characters</h4><p>当使用fast vector highlighter 高亮一个字段时，boundary_chars 能够设置边界字符。默认是 .,!? \t\n 。<br>boundary_max_scan允许控制查找边界字符的距离，默认值为20。</p>
<h4 id="Matched-Fields"><a href="#Matched-Fields" class="headerlink" title="Matched Fields"></a>Matched Fields</h4><p>Fast Vector Highlighter 能够组合多个字段上的匹配并使用 matched_fields 突出单个字段。这对于使用不同分析器来处理同一字符串来说是最直观的。所有matched_fields 必须将 term_vector 设置为 with_positions_offsets ，但只会加载匹配的组合字段，因此只有该字段可以在store设置为yes时受益。</p>
<p>下面的例子中，content 使用 english 分析器 ， content.plain使用 standard分析器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;query_string&quot;: &#123;</div><div class="line">            &quot;query&quot;: &quot;content.plain:running scissors&quot;,</div><div class="line">            &quot;fields&quot;: [&quot;content&quot;]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot;: &#123;</div><div class="line">        &quot;order&quot;: &quot;score&quot;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">            &quot;content&quot;: &#123;</div><div class="line">                &quot;matched_fields&quot;: [&quot;content&quot;, &quot;content.plain&quot;],</div><div class="line">                &quot;type&quot; : &quot;fvh&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的查询中会匹配所有 “run with scissors” 和 “running with scissors”，而不是”run”。如果所有的词组都在一个大的文档中出现，那么”running with scissors” 会排在 “run with scissors”上面，因为在段落中它会更匹配。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;query_string&quot;: &#123;</div><div class="line">            &quot;query&quot;: &quot;running scissors&quot;,</div><div class="line">            &quot;fields&quot;: [&quot;content&quot;, &quot;content.plain^10&quot;]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;highlight&quot;: &#123;</div><div class="line">        &quot;order&quot;: &quot;score&quot;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">            &quot;content&quot;: &#123;</div><div class="line">                &quot;matched_fields&quot;: [&quot;content&quot;, &quot;content.plain&quot;],</div><div class="line">                &quot;type&quot; : &quot;fvh&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Phrase-Limit"><a href="#Phrase-Limit" class="headerlink" title="Phrase Limit"></a>Phrase Limit</h4><p>fast vector highlighter 可以通过phrase_limit 参数来防止分析过多的词组或消耗太多内存。默认是256，也就意味着只有文档前面的256个匹配的词组可以使用。你可以根据自己的需求适量提高这个限制，并且要考虑各方面平衡。<br>如果使用matched_fields，每个匹配字段的phrase_limit短语被考虑。</p>
<h4 id="Field-Highlight-Order"><a href="#Field-Highlight-Order" class="headerlink" title="Field Highlight Order"></a>Field Highlight Order</h4><p>Elasticsearch按照它们发送的顺序来高亮字段。每个json对象是无序的，但如果你需要明确的字段高亮的顺序，你可以使用数组，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;highlight&quot;: &#123;</div><div class="line">        &quot;fields&quot;: [</div><div class="line">            &#123;&quot;title&quot;:&#123; /*params*/ &#125;&#125;,</div><div class="line">            &#123;&quot;text&quot;:&#123; /*params*/ &#125;&#125;</div><div class="line">        ]</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Rescoring"><a href="#Rescoring" class="headerlink" title="Rescoring"></a>Rescoring</h3><p>Rescoring能够通过重新排序来精确query和post_filter的查询结果，使用了二次算法，而不是对整个索引进行操作。<br>rescore请求会被在每一个分片上执行，在返回被节点排序的整个查询请求结果之前。<br>当前，rescore API 只有一个实现：query rescorer–通过使用查询来调整得分。</p>
<p>注意，当使用了sort时，rescore是不会执行的。<br>当使用了分页功能时，遍历每一个页面是不应该改变window_size的（通过传不同的from的值），因为这会改变最上面的命中结果，使得用户在遍历页面时感到困惑。</p>
<h4 id="Query-rescorer"><a href="#Query-rescorer" class="headerlink" title="Query rescorer"></a>Query rescorer</h4><p>query rescorer 只会在query 和 post_filter查询返回的头N条进行二次查询。每个分片检查的文档数量可以通过window_size来控制，默认情况是 from / size。<br>默认情况下，最初查询的得分和rescore查询的得分会先行的组成最终的每个文档的_score。这两个组合的权重比例可以通过query_weight和rescore_query_weight来控制，默认都是1.</p>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;query&quot; : &#123;</div><div class="line">      &quot;match&quot; : &#123;</div><div class="line">         &quot;brand&quot; : &#123;</div><div class="line">            &quot;operator&quot; : &quot;or&quot;,</div><div class="line">            &quot;query&quot; : &quot;gucci&quot;,</div><div class="line">            &quot;type&quot; : &quot;boolean&quot;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;,</div><div class="line">   &quot;rescore&quot; : &#123;</div><div class="line">      &quot;window_size&quot; : 50,</div><div class="line">      &quot;query&quot; : &#123;</div><div class="line">         &quot;rescore_query&quot; : &#123;</div><div class="line">            &quot;match&quot; : &#123;</div><div class="line">               &quot;brand&quot; : &#123;</div><div class="line">                  &quot;query&quot; : &quot;asd&quot;,</div><div class="line">                  &quot;type&quot; : &quot;phrase&quot;,</div><div class="line">                  &quot;slop&quot; : 2</div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">         &#125;,</div><div class="line">         &quot;query_weight&quot; : 0,</div><div class="line">         &quot;rescore_query_weight&quot; : 1</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以通过score_mode来控制得分：</p>
<ul>
<li>total: 默认的设置，会将最初的得分和resscore加起来。</li>
<li>multiply：最初得分 * rescore。</li>
<li>avg： 平均分。</li>
<li>max： 最大值。</li>
<li>min： 最小值。</li>
</ul>
<h4 id="Multiple-Rescores"><a href="#Multiple-Rescores" class="headerlink" title="Multiple Rescores"></a>Multiple Rescores</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">curl -s -XPOST &apos;localhost:9200/_search&apos; -d &apos;&#123;</div><div class="line">   &quot;query&quot; : &#123;</div><div class="line">      &quot;match&quot; : &#123;</div><div class="line">         &quot;field1&quot; : &#123;</div><div class="line">            &quot;operator&quot; : &quot;or&quot;,</div><div class="line">            &quot;query&quot; : &quot;the quick brown&quot;,</div><div class="line">            &quot;type&quot; : &quot;boolean&quot;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;,</div><div class="line">   &quot;rescore&quot; : [ &#123;</div><div class="line">      &quot;window_size&quot; : 100,</div><div class="line">      &quot;query&quot; : &#123;</div><div class="line">         &quot;rescore_query&quot; : &#123;</div><div class="line">            &quot;match&quot; : &#123;</div><div class="line">               &quot;field1&quot; : &#123;</div><div class="line">                  &quot;query&quot; : &quot;the quick brown&quot;,</div><div class="line">                  &quot;type&quot; : &quot;phrase&quot;,</div><div class="line">                  &quot;slop&quot; : 2</div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">         &#125;,</div><div class="line">         &quot;query_weight&quot; : 0.7,</div><div class="line">         &quot;rescore_query_weight&quot; : 1.2</div><div class="line">      &#125;</div><div class="line">   &#125;, &#123;</div><div class="line">      &quot;window_size&quot; : 10,</div><div class="line">      &quot;query&quot; : &#123;</div><div class="line">         &quot;score_mode&quot;: &quot;multiply&quot;,</div><div class="line">         &quot;rescore_query&quot; : &#123;</div><div class="line">            &quot;function_score&quot; : &#123;</div><div class="line">               &quot;script_score&quot;: &#123;</div><div class="line">                  &quot;script&quot;: &#123;</div><div class="line">                    &quot;lang&quot;: &quot;painless&quot;,</div><div class="line">                    &quot;inline&quot;: &quot;Math.log10(doc[&apos;numeric&apos;].value + 2)&quot;</div><div class="line">                  &#125;</div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125; ]</div><div class="line">&#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure>
<p>第一个查询查询到结果，然后第二个查询通过第一个查询结果来进行查询，依次类推。第二次查询会查看第一次查询结果的排序，因此它可能会在看第一次rescore时使用一个大的window，在第二次rescore时使用小一些的window。</p>
<h3 id="Scroll"><a href="#Scroll" class="headerlink" title="Scroll"></a>Scroll</h3><p>与使用search请求一个单独的页面相比，scroll API能够用来获得更多数量的结果（甚至全部结果）通过一个请求，和数据库中的游标差不多。<br>scroll请求返回的结果反映了当时search请求返回的索引的状态，像一个当时的快照。对文档（索引，更新或删除）的后续更改只会影响以后的搜索请求。<br>为了使用scrolling，在查询字符串中应该初始化scroll参数，来告诉es要search context对象存活多久。例如：scroll=1m。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST /_search?scroll=1m</div><div class="line">&#123;</div><div class="line">    &quot;size&quot;: 100,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot; : &#123;</div><div class="line">            &quot;brand&quot; : &quot;gucci&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_scroll_id&quot;: &quot;cXVlcnlUaGVuRmV0Y2g7NTs0ODp6bnRHQVprSVMwaWJ4bGxmcG9OVFNBOzUwOnpudEdBWmtJUzBpYnhsbGZwb05UU0E7NDY6em50R0Faa0lTMGlieGxsZnBvTlRTQTs0OTp6bnRHQVprSVMwaWJ4bGxmcG9OVFNBOzQ3OnpudEdBWmtJUzBpYnhsbGZwb05UU0E7MDs=&quot;,</div><div class="line">  &quot;took&quot;: 4,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0.30685282,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;shirts&quot;,</div><div class="line">        &quot;_type&quot;: &quot;item&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 0.30685282,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;brand&quot;: &quot;gucci&quot;,</div><div class="line">          &quot;color&quot;: &quot;red&quot;,</div><div class="line">          &quot;model&quot;: &quot;slim&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>搜索结果会返回一个_scroll_id，可以用来传入scrollAPI来获得下一批数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">POST  /_search/scroll </div><div class="line">&#123;</div><div class="line">    &quot;scroll&quot; : &quot;1m&quot;, </div><div class="line">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==&quot; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>size参数可以用来配置每次命中数据的返回条数，每次请求scroll API都会返回下一批数据，直到为空。</p>
<h3 id="Preference"><a href="#Preference" class="headerlink" title="Preference"></a>Preference</h3><p>使用preference可以控制在哪个分片上执行搜索请求。默认情况下，会随机在分片的备份上执行。</p>
<p>参数：</p>
<ul>
<li>_primary: 只会在主分片上执行。</li>
<li>_primary_first: 会优先在祝分片上执行，如果主分片不可用，则在其他分片上执行。</li>
<li>_replica： 只会在副本分片上执行。</li>
<li>_replica_first： 会优先在副本分片上执行，如果分片不可用，则在其他分片上执行。</li>
<li>_local： 操作会尽可能在本地分片上执行。</li>
<li>_prefer_nodes:abc,xyz： 会在指定的节点上执行。</li>
<li>_shards:2,3： 限制操作在指定的分片上执行，这个参数可以和其他的preference参数一起执行，但是必须将它放在第一个：_shards:2,3|_primary。</li>
<li>_only_nodes： 限制操作的节点的规格。</li>
<li>Custom (string) value： 自定义的值将用来保证同一个分片会用来处理相同的自定义值。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /_search?preference=xyzabc123</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">            &quot;title&quot;: &quot;elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h3><p>开启explain可以知道所有的命中结果的score是怎么计算的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;explain&quot;: true,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h3><p>每次命中的结果返回一个版本号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;version&quot;: true,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="min-score"><a href="#min-score" class="headerlink" title="min_score"></a>min_score</h3><p>排除_score低于设置的最小值的结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;min_score&quot;: 0.5,</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Named-Queries"><a href="#Named-Queries" class="headerlink" title="Named Queries"></a>Named Queries</h3><p>每个filter和query都可以在最上面设置一个 _name 参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;bool&quot; : &#123;</div><div class="line">            &quot;should&quot; : [</div><div class="line">                &#123;&quot;match&quot; : &#123; &quot;name.first&quot; : &#123;&quot;query&quot; : &quot;shay&quot;, &quot;_name&quot; : &quot;first&quot;&#125; &#125;&#125;,</div><div class="line">                &#123;&quot;match&quot; : &#123; &quot;name.last&quot; : &#123;&quot;query&quot; : &quot;banon&quot;, &quot;_name&quot; : &quot;last&quot;&#125; &#125;&#125;</div><div class="line">            ],</div><div class="line">            &quot;filter&quot; : &#123;</div><div class="line">                &quot;terms&quot; : &#123;</div><div class="line">                    &quot;name.last&quot; : [&quot;banon&quot;, &quot;kimchy&quot;],</div><div class="line">                    &quot;_name&quot; : &quot;test&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Inner-hits"><a href="#Inner-hits" class="headerlink" title="Inner hits"></a>Inner hits</h3><p>parent/child 和 nested 功能可以允许返回匹配不同范围的文档。 在parent/child 中，parent文档可以基于child文档的匹配结果进行返回，或者child文档可以基于parent的匹配结果进行返回。在nested中，文档可以基于内嵌对象的匹配结果进行返回。</p>
<p>在所有情况下，实际的返回结果是由哪个文档引起的一般来说是隐藏的，但是，大部分情况下，知道哪个文档引起的匹配结果是很必要的。inner hits 这个功能就是做这个的。</p>
<p>结构是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;&lt;query&gt;&quot; : &#123;</div><div class="line">    &quot;inner_hits&quot; : &#123;</div><div class="line">        &lt;inner_hits_options&gt;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果在查询中定义了inner_hits，那么在每次返回的信息中都包含inner_hits这个json块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&quot;hits&quot;: [</div><div class="line">     &#123;</div><div class="line">        &quot;_index&quot;: ...,</div><div class="line">        &quot;_type&quot;: ...,</div><div class="line">        &quot;_id&quot;: ...,</div><div class="line">        &quot;inner_hits&quot;: &#123;</div><div class="line">           &quot;&lt;inner_hits_name&gt;&quot;: &#123;</div><div class="line">              &quot;hits&quot;: &#123;</div><div class="line">                 &quot;total&quot;: ...,</div><div class="line">                 &quot;hits&quot;: [</div><div class="line">                    &#123;</div><div class="line">                       &quot;_type&quot;: ...,</div><div class="line">                       &quot;_id&quot;: ...,</div><div class="line">                       ...</div><div class="line">                    &#125;,</div><div class="line">                    ...</div><div class="line">                 ]</div><div class="line">              &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">     &#125;,</div><div class="line">     ...</div><div class="line">]</div></pre></td></tr></table></figure>
<ul>
<li>from、size、sort：用于分页和排序。</li>
<li>name： 用于标识inner_hits的返回结果。当查询中有多个inner_hits时非常有用。</li>
</ul>
<p>nested的查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;nested&quot; : &#123;</div><div class="line">            &quot;path&quot; : &quot;comments&quot;,</div><div class="line">            &quot;query&quot; : &#123;</div><div class="line">                &quot;match&quot; : &#123;&quot;comments.message&quot; : &quot;[actual query]&quot;&#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;inner_hits&quot; : &#123;&#125; </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>响应结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">&quot;hits&quot;: &#123;</div><div class="line">  ...</div><div class="line">  &quot;hits&quot;: [</div><div class="line">     &#123;</div><div class="line">        &quot;_index&quot;: &quot;my-index&quot;,</div><div class="line">        &quot;_type&quot;: &quot;question&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_source&quot;: ...,</div><div class="line">        &quot;inner_hits&quot;: &#123;</div><div class="line">           &quot;comments&quot;: &#123; </div><div class="line">              &quot;hits&quot;: &#123;</div><div class="line">                 &quot;total&quot;: ...,</div><div class="line">                 &quot;hits&quot;: [</div><div class="line">                    &#123;</div><div class="line">                       &quot;_nested&quot;: &#123;</div><div class="line">                          &quot;field&quot;: &quot;comments&quot;,</div><div class="line">                          &quot;offset&quot;: 2</div><div class="line">                       &#125;,</div><div class="line">                       &quot;_source&quot;: ...</div><div class="line">                    &#125;,</div><div class="line">                    ...</div><div class="line">                 ]</div><div class="line">              &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">     &#125;,</div><div class="line">     ...</div></pre></td></tr></table></figure>
<p>parent/child 查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;has_child&quot; : &#123;</div><div class="line">            &quot;type&quot; : &quot;comment&quot;,</div><div class="line">            &quot;query&quot; : &#123;</div><div class="line">                &quot;match&quot; : &#123;&quot;message&quot; : &quot;[actual query]&quot;&#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;inner_hits&quot; : &#123;&#125; </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>响应结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">&quot;hits&quot;: &#123;</div><div class="line">  ...</div><div class="line">  &quot;hits&quot;: [</div><div class="line">     &#123;</div><div class="line">        &quot;_index&quot;: &quot;my-index&quot;,</div><div class="line">        &quot;_type&quot;: &quot;question&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_source&quot;: ...,</div><div class="line">        &quot;inner_hits&quot;: &#123;</div><div class="line">           &quot;comment&quot;: &#123;</div><div class="line">              &quot;hits&quot;: &#123;</div><div class="line">                 &quot;total&quot;: ...,</div><div class="line">                 &quot;hits&quot;: [</div><div class="line">                    &#123;</div><div class="line">                       &quot;_type&quot;: &quot;comment&quot;,</div><div class="line">                       &quot;_id&quot;: &quot;5&quot;,</div><div class="line">                       &quot;_source&quot;: ...</div><div class="line">                    &#125;,</div><div class="line">                    ...</div><div class="line">                 ]</div><div class="line">              &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">     &#125;,</div><div class="line">     ...</div></pre></td></tr></table></figure>
<h3 id="Search-After"><a href="#Search-After" class="headerlink" title="Search After"></a>Search After</h3><p>分页功能一般可以使用from/size来实现，但是当深度分页时的成本也是很大的。index-max_result_window默认安全值是10000，搜索请求的堆内存占用率和时间成本和from+size成正比。Scroll API推荐用于深度分页，但是滚动的成本高，不推荐用于实时的请求。search_after参数通过提供一个实时的游标绕过了这个问题。这个想法是通过前一页的结果来帮助下一页的检索。</p>
<p>假设查询第一页是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_search</div><div class="line">&#123;</div><div class="line">    &quot;size&quot;: 10,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot; : &#123;</div><div class="line">            &quot;title&quot; : &quot;elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;sort&quot;: [</div><div class="line">        &#123;&quot;date&quot;: &quot;asc&quot;&#125;,</div><div class="line">        &#123;&quot;_uid&quot;: &quot;desc&quot;&#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面查询的结果包括了一组 sort values。这些sort values 能用于联合search_after参数来返回任何文档后面的结果。例如，我们可以使用最后一个文档的sort values 并把它传入search_after，就可以获取下一页的文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_search</div><div class="line">&#123;</div><div class="line">    &quot;size&quot;: 10,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot; : &#123;</div><div class="line">            &quot;title&quot; : &quot;elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;search_after&quot;: [1463538857, &quot;tweet#654323&quot;],</div><div class="line">    &quot;sort&quot;: [</div><div class="line">        &#123;&quot;date&quot;: &quot;asc&quot;&#125;,</div><div class="line">        &#123;&quot;_uid&quot;: &quot;desc&quot;&#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>值得注意的是，使用search_after需要将from设置为0或-1。</p>
<p>search_after对于想要随机跳转到某页是不可用的。它和scroll API非常相似，不同的是search_after是无状态的，它总是取得的是最新版本的数据。</p>
<h2 id="Search-Template"><a href="#Search-Template" class="headerlink" title="Search Template"></a>Search Template</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">    &quot;inline&quot; : &#123;</div><div class="line">      &quot;query&quot;: &#123; &quot;match&quot; : &#123; &quot;&#123;&#123;my_field&#125;&#125;&quot; : &quot;&#123;&#123;my_value&#125;&#125;&quot; &#125; &#125;,</div><div class="line">      &quot;size&quot; : &quot;&#123;&#123;my_size&#125;&#125;&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;params&quot; : &#123;</div><div class="line">        &quot;my_field&quot; : &quot;foo&quot;,</div><div class="line">        &quot;my_value&quot; : &quot;bar&quot;,</div><div class="line">        &quot;my_size&quot; : 5</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参数为查询语句的例子"><a href="#参数为查询语句的例子" class="headerlink" title="参数为查询语句的例子"></a>参数为查询语句的例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">    &quot;inline&quot;: &#123;</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;match&quot;: &#123;</div><div class="line">                &quot;title&quot;: &quot;&#123;&#123;query_string&#125;&#125;&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;params&quot;: &#123;</div><div class="line">        &quot;query_string&quot;: &quot;search for these words&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="将参数转为json"><a href="#将参数转为json" class="headerlink" title="将参数转为json"></a>将参数转为json</h3><font color="red"><b>注意，本节中，由于蛋疼的编译器的限制，在下一行的大括号内加上了单引号，正确的语法是不加单引号的。</b></font>

<p><code>#toJson参数名/toJson</code>可以将 map 和 array 类型的参数转换为 json 格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">  &quot;inline&quot;: &quot;&#123; \&quot;query\&quot;: &#123; \&quot;terms\&quot;: &#123; \&quot;status\&quot;: &#123;&#123;#toJson&#125;&#125;status&#123;&#123;/toJson&#125;&#125; &#125;&#125;&#125;&quot;,</div><div class="line">  &quot;params&quot;: &#123;</div><div class="line">    &quot;status&quot;: [ &quot;pending&quot;, &quot;published&quot; ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的例子实际执行时是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;terms&quot;: &#123;</div><div class="line">      &quot;status&quot;: [</div><div class="line">        &quot;pending&quot;,</div><div class="line">        &quot;published&quot;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更复杂一些的例子是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;inline&quot;: &quot;&#123;\&quot;query\&quot;:&#123;\&quot;bool\&quot;:&#123;\&quot;must\&quot;: &#123;&#123;#toJson&#125;&#125;clauses&#123;&#123;/toJson&#125;&#125; &#125;&#125;&#125;&quot;,</div><div class="line">    &quot;params&quot;: &#123;</div><div class="line">        &quot;clauses&quot;: [</div><div class="line">            &#123; &quot;term&quot;: &quot;foo&quot; &#125;,</div><div class="line">            &#123; &quot;term&quot;: &quot;bar&quot; &#125;</div><div class="line">        ]</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际执行时是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">      &quot;bool&quot; : &#123;</div><div class="line">        &quot;must&quot; : [</div><div class="line">          &#123;</div><div class="line">            &quot;term&quot; : &quot;foo&quot;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;term&quot; : &quot;bar&quot;</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="连接-array-的值"><a href="#连接-array-的值" class="headerlink" title="连接 array 的值"></a>连接 array 的值</h3><p><code>#joinarray/join</code> 可以将array的值连接起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">  &quot;inline&quot;: &#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;match&quot;: &#123;</div><div class="line">        &quot;emails&quot;: &quot;&#123;&#123;#join&#125;&#125;emails&#123;&#123;/join&#125;&#125;&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;params&quot;: &#123;</div><div class="line">    &quot;emails&quot;: [ &quot;username@email.com&quot;, &quot;lastname@email.com&quot; ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这就相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot; : &#123;</div><div class="line">            &quot;emails&quot; : &quot;username@email.com,lastname@email.com&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以自定义链接的符号，比如将， 转为 || ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">  &quot;inline&quot;: &#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;range&quot;: &#123;</div><div class="line">        &quot;born&quot;: &#123;</div><div class="line">            &quot;gte&quot;   : &quot;&#123;&#123;date.min&#125;&#125;&quot;,</div><div class="line">            &quot;lte&quot;   : &quot;&#123;&#123;date.max&#125;&#125;&quot;,</div><div class="line">            &quot;format&quot;: &quot;&#123;&#123;#join delimiter=&apos;||&apos;&#125;&#125;date.formats&#123;&#123;/join delimiter=&apos;||&apos;&#125;&#125;&quot;</div><div class="line">            &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;params&quot;: &#123;</div><div class="line">    &quot;date&quot;: &#123;</div><div class="line">        &quot;min&quot;: &quot;2016&quot;,</div><div class="line">        &quot;max&quot;: &quot;31/12/2017&quot;,</div><div class="line">        &quot;formats&quot;: [&quot;dd/MM/yyyy&quot;, &quot;yyyy&quot;]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">      &quot;range&quot; : &#123;</div><div class="line">        &quot;born&quot; : &#123;</div><div class="line">          &quot;gte&quot; : &quot;2016&quot;,</div><div class="line">          &quot;lte&quot; : &quot;31/12/2017&quot;,</div><div class="line">          &quot;format&quot; : &quot;dd/MM/yyyy||yyyy&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><p><code>var^vardefault/var</code> 可以设定参数的默认值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;inline&quot;: &#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;range&quot;: &#123;</div><div class="line">        &quot;line_no&quot;: &#123;</div><div class="line">          &quot;gte&quot;: &quot;&#123;&#123;start&#125;&#125;&quot;,</div><div class="line">          &quot;lte&quot;: &quot;&#123;&#123;end&#125;&#125;&#123;&#123;&apos;^end&apos;&#125;&#125;20&#123;&#123;&apos;/end&apos;&#125;&#125;&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;params&quot;: &#123; ... &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当params是{ “start”: 10, “end”: 15 }时，搜索语句是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;range&quot;: &#123;</div><div class="line">        &quot;line_no&quot;: &#123;</div><div class="line">            &quot;gte&quot;: &quot;10&quot;,</div><div class="line">            &quot;lte&quot;: &quot;15&quot;</div><div class="line">        &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当params 是 { “start”: 10 } 时，则是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;range&quot;: &#123;</div><div class="line">        &quot;line_no&quot;: &#123;</div><div class="line">            &quot;gte&quot;: &quot;10&quot;,</div><div class="line">            &quot;lte&quot;: &quot;20&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="条件判断语句"><a href="#条件判断语句" class="headerlink" title="条件判断语句"></a>条件判断语句</h3><p>条件判断语句不能使用json作为参数，只能使用string类型。</p>
<p>参数是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;params&quot;: &#123;</div><div class="line">        &quot;text&quot;:      &quot;words to search for&quot;,</div><div class="line">        &quot;line_no&quot;: &#123; </div><div class="line">            &quot;start&quot;: 10, </div><div class="line">            &quot;end&quot;:   20  </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查询语句是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">          &quot;line&quot;: &quot;&#123;&#123;text&#125;&#125;&quot; </div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &#123;&#123;&apos;#line_no&apos;&#125;&#125; </div><div class="line">          &quot;range&quot;: &#123;</div><div class="line">            &quot;line_no&quot;: &#123;</div><div class="line">              &#123;&#123;&apos;#start&apos;&#125;&#125; </div><div class="line">                &quot;gte&quot;: &quot;&#123;&#123;start&#125;&#125;&quot; </div><div class="line">                &#123;&#123;&apos;#end&apos;&#125;&#125;,&#123;&#123;&apos;/end&apos;&#125;&#125; </div><div class="line">              &#123;&#123;&apos;/start&apos;&#125;&#125; </div><div class="line">              &#123;&#123;&apos;#end&apos;&#125;&#125; </div><div class="line">                &quot;lte&quot;: &quot;&#123;&#123;end&#125;&#125;&quot; </div><div class="line">              &#123;&#123;&apos;/end&apos;&#125;&#125; </div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#123;&#123;&apos;/line_no&apos;&#125;&#125; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#line_no ... /line_no</code> 块表示的是 当指定了 line_no 这个参数时，才会有中间的代码，依此类推，<code>#start ... /start</code>等也是如此。</p>
<h3 id="预注册模板"><a href="#预注册模板" class="headerlink" title="预注册模板"></a>预注册模板</h3><p>可以预先将查询模板存储在 config/scripts 目录下，并使用后缀为.mustache 的文件存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GET /_search/template</div><div class="line">&#123;</div><div class="line">    &quot;file&quot;: &quot;storedTemplate&quot;, </div><div class="line">    &quot;params&quot;: &#123;</div><div class="line">        &quot;query_string&quot;: &quot;search for these words&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的例子中，文件是 config/scripts/ 目录下的storedTemplate.mustache 。</p>
<p>还可以将模板存储在 cluster state 中。然后使用restAPI来管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /_search/template/&lt;templatename&gt;</div><div class="line">&#123;</div><div class="line">    &quot;template&quot;: &#123;</div><div class="line">        &quot;query&quot;: &#123;</div><div class="line">            &quot;match&quot;: &#123;</div><div class="line">                &quot;title&quot;: &quot;&#123;&#123;query_string&#125;&#125;&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后获取的时候使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_search/template/&lt;templatename&gt;</div></pre></td></tr></table></figure>
<p>删除的时候使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DELETE /_search/template/&lt;templatename&gt;</div></pre></td></tr></table></figure>
<h2 id="Multi-Search-Template"><a href="#Multi-Search-Template" class="headerlink" title="Multi Search Template"></a>Multi Search Template</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ cat requests</div><div class="line">&#123;&quot;index&quot;: &quot;test&quot;&#125;</div><div class="line">&#123;&quot;inline&quot;: &#123;&quot;query&quot;: &#123;&quot;match&quot;:  &#123;&quot;user&quot; : &quot;&#123;&#123;username&#125;&#125;&quot; &#125;&#125;&#125;, &quot;params&quot;: &#123;&quot;username&quot;: &quot;john&quot;&#125;&#125; </div><div class="line">&#123;&quot;index&quot;: &quot;_all&quot;, &quot;types&quot;: &quot;accounts&quot;&#125;</div><div class="line">&#123;&quot;inline&quot;: &#123;&quot;query&quot;: &#123;&quot;&#123;&#123;query_type&#125;&#125;&quot;: &#123;&quot;name&quot;: &quot;&#123;&#123;name&#125;&#125;&quot; &#125;&#125;&#125;, &quot;params&quot;: &#123;&quot;query_type&quot;: &quot;match_phrase_prefix&quot;, &quot;name&quot;: &quot;Smith&quot;&#125;&#125;</div><div class="line">&#123;&quot;index&quot;: &quot;_all&quot;&#125;</div><div class="line">&#123;&quot;id&quot;: &quot;template_1&quot;, &quot;params&quot;: &#123;&quot;query_string&quot;: &quot;search for these words&quot; &#125;&#125; </div><div class="line">&#123;&quot;types&quot;: &quot;users&quot;&#125;</div><div class="line">&#123;&quot;file&quot;: &quot;template_2&quot;, &quot;params&quot;: &#123;&quot;field_name&quot;: &quot;fullname&quot;, &quot;field_value&quot;: &quot;john smith&quot; &#125;&#125; </div><div class="line"></div><div class="line">$ curl -XGET localhost:9200/_msearch/template --data-binary &quot;@requests&quot;; echo</div></pre></td></tr></table></figure>
<h2 id="Search-Shards-API"><a href="#Search-Shards-API" class="headerlink" title="Search Shards API"></a>Search Shards API</h2><p>search shards API 会将执行搜索请求的分片信息返回回来。这对于查找问题和优化系统有很重要的意义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /twitter/_search_shards</div></pre></td></tr></table></figure>
<p>返回的信息是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;nodes&quot;: ...,</div><div class="line">  &quot;indices&quot; : &#123;</div><div class="line">    &quot;twitter&quot;: &#123; &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;shards&quot;: [</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 0,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;0TvkCyF7TAmM1wHP4a42-A&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 1,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;fMju3hd1QHWmWrIgFnI4Ww&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 2,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;Nwl0wbMBTHCWjEEbGYGapg&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 3,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;bU_KLGJISbW0RejwnwDPKw&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 4,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;DMs7_giNSwmdqVukF7UydA&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还可以指定routing：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /twitter/_search_shards?routing=foo,baz</div></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;nodes&quot;: ...,</div><div class="line">  &quot;indices&quot; : &#123;</div><div class="line">      &quot;twitter&quot;: &#123; &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;shards&quot;: [</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 0,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;0TvkCyF7TAmM1wHP4a42-A&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    [</div><div class="line">      &#123;</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;node&quot;: &quot;JklnKbD7Tyqi9TP3_Q_tBg&quot;,</div><div class="line">        &quot;primary&quot;: true,</div><div class="line">        &quot;shard&quot;: 1,</div><div class="line">        &quot;state&quot;: &quot;STARTED&quot;,</div><div class="line">        &quot;allocation_id&quot;: &#123;&quot;id&quot;:&quot;fMju3hd1QHWmWrIgFnI4Ww&quot;&#125;,</div><div class="line">        &quot;relocating_node&quot;: null</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于指定了routing，搜索请求将在这两个分片中执行。</p>
<ul>
<li>routing: 由逗号分隔的，指定搜索在哪些分片上执行。</li>
<li>preference： 指定搜索在分片的哪个备份上执行。默认是在随机的备份上执行。</li>
<li>local： 布尔型，是否读取本地集群状态以确定碎片分配而不是使用主节点的集群状态。</li>
</ul>
<h2 id="Suggesters"><a href="#Suggesters" class="headerlink" title="Suggesters"></a>Suggesters</h2><p>suggest功能是通过使用suggester基于所提供的文本来建议类似的术语。它可以在_search请求或_suggest中执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">POST twitter/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot; : &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;message&quot;: &quot;tring out Elasticsearch&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;suggest&quot; : &#123;</div><div class="line">    &quot;my-suggestion&quot; : &#123;</div><div class="line">      &quot;text&quot; : &quot;trying out Elasticsearch&quot;,</div><div class="line">      &quot;term&quot; : &#123;</div><div class="line">        &quot;field&quot; : &quot;message&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>suggest请求在_suggest上执行需要省略suggest元素，suggest元素仅在suggest是搜索请求一部分时才可用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST _suggest</div><div class="line">&#123;</div><div class="line">  &quot;my-suggestion&quot; : &#123;</div><div class="line">    &quot;text&quot; : &quot;tring out Elasticsearch&quot;,</div><div class="line">    &quot;term&quot; : &#123;</div><div class="line">      &quot;field&quot; : &quot;message&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个请求可以设置多个suggest。每个suggest可以设置不同的名字。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">POST _suggest</div><div class="line">&#123;</div><div class="line">  &quot;my-suggest-1&quot; : &#123;</div><div class="line">    &quot;text&quot; : &quot;tring out Elasticsearch&quot;,</div><div class="line">    &quot;term&quot; : &#123;</div><div class="line">      &quot;field&quot; : &quot;message&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;my-suggest-2&quot; : &#123;</div><div class="line">    &quot;text&quot; : &quot;kmichy&quot;,</div><div class="line">    &quot;term&quot; : &#123;</div><div class="line">      &quot;field&quot; : &quot;user&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_shards&quot;: ...</div><div class="line">  &quot;my-suggest-1&quot;: [ &#123;</div><div class="line">    &quot;text&quot;: &quot;tring&quot;,</div><div class="line">    &quot;offset&quot;: 0,</div><div class="line">    &quot;length&quot;: 5,</div><div class="line">    &quot;options&quot;: [ &#123;&quot;text&quot;: &quot;trying&quot;, &quot;score&quot;: 0.8, &quot;freq&quot;: 1 &#125; ]</div><div class="line">  &#125;, &#123;</div><div class="line">    &quot;text&quot;: &quot;out&quot;,</div><div class="line">    &quot;offset&quot;: 6,</div><div class="line">    &quot;length&quot;: 3,</div><div class="line">    &quot;options&quot;: []</div><div class="line">  &#125;, &#123;</div><div class="line">    &quot;text&quot;: &quot;elasticsearch&quot;,</div><div class="line">    &quot;offset&quot;: 10,</div><div class="line">    &quot;length&quot;: 13,</div><div class="line">    &quot;options&quot;: []</div><div class="line">  &#125; ],</div><div class="line">  &quot;my-suggest-2&quot;: ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了避免重复的text，可以定义一个全局的text。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">POST _suggest</div><div class="line">&#123;</div><div class="line">  &quot;text&quot; : &quot;tring out Elasticsearch&quot;,</div><div class="line">  &quot;my-suggest-1&quot; : &#123;</div><div class="line">    &quot;term&quot; : &#123;</div><div class="line">      &quot;field&quot; : &quot;message&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;my-suggest-2&quot; : &#123;</div><div class="line">    &quot;term&quot; : &#123;</div><div class="line">      &quot;field&quot; : &quot;user&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Term-suggester"><a href="#Term-suggester" class="headerlink" title="Term suggester"></a>Term suggester</h3><p>//TODO …</p>
<h2 id="Multi-Search-API"><a href="#Multi-Search-API" class="headerlink" title="Multi Search API"></a>Multi Search API</h2><p>multi search API 允许通过一个API执行多个搜索请求。使用_msearch。</p>
<p>请求格式和bulk API类似，结构类似于下面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">header\n</div><div class="line">body\n</div><div class="line">header\n</div><div class="line">body\n</div></pre></td></tr></table></figure>
<p>header部分包含了搜索哪些index，search_type，preference和routing是可选的。请求体是典型的搜索请求体：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ cat requests</div><div class="line">&#123;&quot;index&quot; : &quot;test&quot;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;, &quot;from&quot; : 0, &quot;size&quot; : 10&#125;</div><div class="line">&#123;&quot;index&quot; : &quot;test&quot;, &quot;search_type&quot; : &quot;dfs_query_then_fetch&quot;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line">&#123;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line"></div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line">&#123;&quot;search_type&quot; : &quot;dfs_query_then_fetch&quot;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line"></div><div class="line">$ curl -XGET localhost:9200/_msearch --data-binary &quot;@requests&quot;; echo</div></pre></td></tr></table></figure></p>
<p>看一下上面的例子，有两个地方是没有指定header或者是{}空header的，这也是支持的。</p>
<p>响应会返回一个responses数组，包含每一个搜索的响应和状态码，并且按照请求的顺序排列。</p>
<p>也可以不在header中，而在URI上设置index和type：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ cat requests</div><div class="line">&#123;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;, &quot;from&quot; : 0, &quot;size&quot; : 10&#125;</div><div class="line">&#123;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line">&#123;&quot;index&quot; : &quot;test2&quot;&#125;</div><div class="line">&#123;&quot;query&quot; : &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</div><div class="line"></div><div class="line">$ curl -XGET localhost:9200/test/_msearch --data-binary @requests; echo</div></pre></td></tr></table></figure>
<p>max_concurrent_searches 参数可以用在请求中，用来控制搜索的最大搜索数。默认的取决于搜索节点的线程池中线程数量。</p>
<h2 id="Count-API"><a href="#Count-API" class="headerlink" title="Count API"></a>Count API</h2><p>count API 可以执行搜索请求并且获得符合条件的结果数量。它能够跨多个index和type上执行。可以使用一个简单的查询字符串作为参数或者在request body中使用QueryDSL。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">PUT /twitter/tweet/1?refresh</div><div class="line">&#123;</div><div class="line">    &quot;user&quot;: &quot;kimchy&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">GET /twitter/tweet/_count?q=user:kimchy</div><div class="line"></div><div class="line">GET /twitter/tweet/_count</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;count&quot; : 1,</div><div class="line">    &quot;_shards&quot; : &#123;</div><div class="line">        &quot;total&quot; : 5,</div><div class="line">        &quot;successful&quot; : 5,</div><div class="line">        &quot;failed&quot; : 0</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Request-Parameters"><a href="#Request-Parameters" class="headerlink" title="Request Parameters"></a>Request Parameters</h3><p>当使用参数q执行count时，可以传入以下参数：</p>
<ul>
<li>df:当没传入搜索的field时，默认使用的field。</li>
<li>analyzer： 使用的分析器的名称。</li>
<li>default_operator： 默认的操作符，可以使用AND或OR，默认是OR。</li>
<li>lenient：设为true时会导致类型失败会被忽略（例如对text类型传入数字类型）。默认是false。</li>
<li>analyze_wildcard：通配符和前缀查询是否会被分析器分析。默认是false。</li>
<li>terminate_after：count到达某个值时则停止查询。如果设置了，那么在响应结果中会有一个terminated_early的boolean型来表示是否执行了terminate_after。默认是没有terminate_after的。</li>
</ul>
<h2 id="Validate-API"><a href="#Validate-API" class="headerlink" title="Validate API"></a>Validate API</h2><p>validate API 可以在不执行请求的情况下校验一个潜在的耗时的查询。我们可以使用下面的数据来验证一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PUT twitter/tweet/_bulk?refresh</div><div class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</div><div class="line">&#123;&quot;user&quot; : &quot;kimchy&quot;, &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;, &quot;message&quot; : &quot;trying out Elasticsearch&quot;&#125;</div><div class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</div><div class="line">&#123;&quot;user&quot; : &quot;kimchi&quot;, &quot;post_date&quot; : &quot;2009-11-15T14:12:13&quot;, &quot;message&quot; : &quot;My username is similar to @kimchy!&quot;&#125;</div></pre></td></tr></table></figure>
<p>接下来发送校验请求:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET twitter/_validate/query?q=user:foo</div></pre></td></tr></table></figure>
<p>响应结果是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;valid&quot;:true,&quot;_shards&quot;:&#123;&quot;total&quot;:1,&quot;successful&quot;:1,&quot;failed&quot;:0&#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h3><ul>
<li>df:当没传入搜索的field时，默认使用的field。</li>
<li>analyzer： 使用的分析器的名称。</li>
<li>default_operator： 默认的操作符，可以使用AND或OR，默认是OR。</li>
<li>lenient：设为true时会导致类型失败会被忽略（例如对text类型传入数字类型）。默认是false。</li>
<li>analyze_wildcard：通配符和前缀查询是否会被分析器分析。默认是false。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_validate/query</div><div class="line">&#123;</div><div class="line">  &quot;query&quot; : &#123;</div><div class="line">    &quot;bool&quot; : &#123;</div><div class="line">      &quot;must&quot; : &#123;</div><div class="line">        &quot;query_string&quot; : &#123;</div><div class="line">          &quot;query&quot; : &quot;*:*&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;filter&quot; : &#123;</div><div class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果查询是无效的，那么valid会为false。例如下面的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_validate/query?q=post_date:foo</div></pre></td></tr></table></figure>
<p>由于post_date是日期类型，而查询时传入的是 foo 字符串类型，所以结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;valid&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:1,&quot;successful&quot;:1,&quot;failed&quot;:0&#125;&#125;</div></pre></td></tr></table></figure>
<p>将explain设置为true将会返回为什么查询是非法的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_validate/query?q=post_date:foo&amp;explain=true</div></pre></td></tr></table></figure>
<p>响应是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;valid&quot; : false,</div><div class="line">  &quot;_shards&quot; : &#123;</div><div class="line">    &quot;total&quot; : 1,</div><div class="line">    &quot;successful&quot; : 1,</div><div class="line">    &quot;failed&quot; : 0</div><div class="line">  &#125;,</div><div class="line">  &quot;explanations&quot; : [ &#123;</div><div class="line">    &quot;index&quot; : &quot;twitter&quot;,</div><div class="line">    &quot;valid&quot; : false,</div><div class="line">    &quot;error&quot; : &quot;twitter/IAEc2nIXSSunQA_suI0MLw] QueryShardException[failed to create query:...failed to parse date field [foo]&quot;</div><div class="line">  &#125; ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当查询是有效的，explanation默认为该查询的字符串表示。当rewrite设置为true时，explanation会显示查询的更多细节。</p>
<p>对于模糊查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_validate/query?rewrite=true</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;user&quot;: &#123;</div><div class="line">        &quot;query&quot;: &quot;kimchy&quot;,</div><div class="line">        &quot;fuzziness&quot;: &quot;auto&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>响应：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;valid&quot;: true,</div><div class="line">   &quot;_shards&quot;: &#123;</div><div class="line">      &quot;total&quot;: 1,</div><div class="line">      &quot;successful&quot;: 1,</div><div class="line">      &quot;failed&quot;: 0</div><div class="line">   &#125;,</div><div class="line">   &quot;explanations&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">         &quot;valid&quot;: true,</div><div class="line">         &quot;explanation&quot;: &quot;+user:kimchy +user:kimchi^0.75 #(ConstantScore(_type:tweet))^0.0&quot;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更多的例子，像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GET twitter/tweet/_validate/query?rewrite=true</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;more_like_this&quot;: &#123;</div><div class="line">      &quot;like&quot;: &#123;</div><div class="line">        &quot;_id&quot;: &quot;2&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;boost_terms&quot;: 1</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>响应：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;valid&quot;: true,</div><div class="line">   &quot;_shards&quot;: &#123;</div><div class="line">      &quot;total&quot;: 1,</div><div class="line">      &quot;successful&quot;: 1,</div><div class="line">      &quot;failed&quot;: 0</div><div class="line">   &#125;,</div><div class="line">   &quot;explanations&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">         &quot;valid&quot;: true,</div><div class="line">         &quot;explanation&quot;: &quot;((user:terminator^3.71334 plot:future^2.763601 plot:human^2.8415773 plot:sarah^3.4193945 plot:kyle^3.8244398 plot:cyborg^3.9177752 plot:connor^4.040236 plot:reese^4.7133346 ... )~6) -ConstantScore(_uid:tweet#2)) #(ConstantScore(_type:tweet))^0.0&quot;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>请求会执行在一个随机的分片上，因此explanation的细节取决于命中的分片，因此，同一个查询在不同的分片可能在细节上差异巨大。</p>
<h2 id="Explain-API"><a href="#Explain-API" class="headerlink" title="Explain API"></a>Explain API</h2><p>explain API 可以计算出查询指定文档的分数。这个功能非常有用，它可以让我们直接知道这个查询是否和指定的文档匹配。</p>
<p>注意，此处index和type只能是唯一的，不能是多个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /twitter/tweet/0/_explain</div><div class="line">&#123;</div><div class="line">      &quot;query&quot; : &#123;</div><div class="line">        &quot;match&quot; : &#123; &quot;message&quot; : &quot;elasticsearch&quot; &#125;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查询结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">   &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">   &quot;_id&quot;: &quot;0&quot;,</div><div class="line">   &quot;matched&quot;: true,</div><div class="line">   &quot;explanation&quot;: &#123;</div><div class="line">      &quot;value&quot;: 1.55077,</div><div class="line">      &quot;description&quot;: &quot;sum of:&quot;,</div><div class="line">      &quot;details&quot;: [</div><div class="line">         &#123;</div><div class="line">            &quot;value&quot;: 1.55077,</div><div class="line">            &quot;description&quot;: &quot;weight(message:elasticsearch in 0) [PerFieldSimilarity], result of:&quot;,</div><div class="line">            &quot;details&quot;: [</div><div class="line">               &#123;</div><div class="line">                  &quot;value&quot;: 1.55077,</div><div class="line">                  &quot;description&quot;: &quot;score(doc=0,freq=1.0 = termFreq=1.0\n), product of:&quot;,</div><div class="line">                  &quot;details&quot;: [</div><div class="line">                     &#123;</div><div class="line">                        &quot;value&quot;: 1.3862944,</div><div class="line">                        &quot;description&quot;: &quot;idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:&quot;,</div><div class="line">                        &quot;details&quot;: [</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 1.0,</div><div class="line">                              &quot;description&quot;: &quot;docFreq&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;,</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 5.0,</div><div class="line">                              &quot;description&quot;: &quot;docCount&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;</div><div class="line">                        ]</div><div class="line">                     &#125;,</div><div class="line">                     &#123;</div><div class="line">                        &quot;value&quot;: 1.1186441,</div><div class="line">                        &quot;description&quot;: &quot;tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:&quot;,</div><div class="line">                        &quot;details&quot;: [</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 1.0,</div><div class="line">                              &quot;description&quot;: &quot;termFreq=1.0&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;,</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 1.2,</div><div class="line">                              &quot;description&quot;: &quot;parameter k1&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;,</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 0.75,</div><div class="line">                              &quot;description&quot;: &quot;parameter b&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;,</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 5.4,</div><div class="line">                              &quot;description&quot;: &quot;avgFieldLength&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;,</div><div class="line">                           &#123;</div><div class="line">                              &quot;value&quot;: 4.0,</div><div class="line">                              &quot;description&quot;: &quot;fieldLength&quot;,</div><div class="line">                              &quot;details&quot;: []</div><div class="line">                           &#125;</div><div class="line">                        ]</div><div class="line">                     &#125;</div><div class="line">                  ]</div><div class="line">               &#125;</div><div class="line">            ]</div><div class="line">         &#125;,</div><div class="line">         &#123;</div><div class="line">            &quot;value&quot;: 0.0,</div><div class="line">            &quot;description&quot;: &quot;match on required clause, product of:&quot;,</div><div class="line">            &quot;details&quot;: [</div><div class="line">               &#123;</div><div class="line">                  &quot;value&quot;: 0.0,</div><div class="line">                  &quot;description&quot;: &quot;# clause&quot;,</div><div class="line">                  &quot;details&quot;: []</div><div class="line">               &#125;,</div><div class="line">               &#123;</div><div class="line">                  &quot;value&quot;: 1.0,</div><div class="line">                  &quot;description&quot;: &quot;*:*, product of:&quot;,</div><div class="line">                  &quot;details&quot;: [</div><div class="line">                     &#123;</div><div class="line">                        &quot;value&quot;: 1.0,</div><div class="line">                        &quot;description&quot;: &quot;boost&quot;,</div><div class="line">                        &quot;details&quot;: []</div><div class="line">                     &#125;,</div><div class="line">                     &#123;</div><div class="line">                        &quot;value&quot;: 1.0,</div><div class="line">                        &quot;description&quot;: &quot;queryNorm&quot;,</div><div class="line">                        &quot;details&quot;: []</div><div class="line">                     &#125;</div><div class="line">                  ]</div><div class="line">               &#125;</div><div class="line">            ]</div><div class="line">         &#125;</div><div class="line">      ]</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以使用q参数来进行查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /twitter/tweet/0/_explain?q=message:search</div></pre></td></tr></table></figure>
<ul>
<li><p>source: 设为true可以返回查询到的_source文档。还可以通过_source_include和_source_exclude来决定查询哪些文档。</p>
</li>
<li><p>stored_fields： 允许控制哪些存储的字段会作为explained的文档。</p>
</li>
<li><p>routing： 控制使用哪个路由。</p>
</li>
<li><p>parent：和routing使用方式一样。</p>
</li>
<li><p>preference： 控制在哪个分片上执行explain。</p>
</li>
<li><p>source： 可以在请求体进行查询。</p>
</li>
<li><p>q： 查询字符串。</p>
</li>
<li><p>df： 默认的用来进行查询的field。默认为_all。</p>
</li>
<li><p>analyzer： 查询分析器的名称。</p>
</li>
<li><p>analyze_wildcard： 是否可以使用通配符或前缀进行查询，默认是false。</p>
</li>
<li><p>lenient： 是否忽略类型匹配异常。默认是false。</p>
</li>
<li><p>default_operator： 默认的逻辑操作符，可以是AND或OR，默认是OR。</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/16/【转】解决hexo在github-page上css-js-404问题/" itemprop="url">
                  【转】解决hexo在github page上css/js 404问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-11-16T16:51:31+08:00" content="2016-11-16">
              2016-11-16
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>最近github page更新了，GitHub Pages 过滤掉了 source/vendors 目录的访问，所以next主题下的source下的vendors目录不能够被访问到，所以就出现了本地hexo s能够正常访问，但是deploy到github就是一片空白，按f12，可以看到大量来自source/vendors的css和js提示404。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>方法一（来自github next主题issue）:</p>
<p>找到解决方案了。。 @BBBOND @monsterLin @SpadeRoy 根据作者的提示 @iissnan ，首先修改source/vendors为source/lib，然后修改_config.yml， 将 _internal: vendors修改为_internal:lib 然后修改next底下所有引用source/vendors路径为source/lib。这些地方可以通过文件查找找出来。主要集中在这几个文件中。1. Hexo\themes\next.bowerrc 2. Hexo\themes\next.gitignore 3. Hexo\themes\next.javascript_ignore 4. Hexo\themes\next\bower.json 。修改完毕后，刷新重新g一遍就ok啦。</p>
<p>方法二:更新next主题，不过听过最新的next主题对第三方例如多说删除了，具体不清楚，不敢亲易尝试，毕竟更新一次主题引来的问题太多，很多配置可能都要改，代价太高，所以推荐第一种方法<br>参考</p>
<pre><code>https://github.com/hexojs/hexo/issues/2238
https://github.com/iissnan/hexo-theme-next/issues/1214
</code></pre><p>转自： <a href="http://blog.csdn.net/zhouzixin053/article/details/53038679" target="_blank" rel="external">Hexo+Github博客css js404导致博客页面空白</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/22/Elasticsearch学习笔记：三、Document-APIs/" itemprop="url">
                  Elasticsearch学习笔记：三、Document APIs
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-22T14:02:30+08:00" content="2016-09-22">
              2016-09-22
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Index-API"><a href="#Index-API" class="headerlink" title="Index API"></a>Index API</h2><p>index API 用来向指定的index添加或更新JSON文档，并使它可被搜索。下面的例子是在名为 twitter 的index中添加一个文档，type为tweet，id=1 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT &apos;http://localhost:9200/twitter/tweet/1&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 3,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;created&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，_shards段中提供了以下信息：</p>
<ul>
<li>total - 多少个分片及其备份要被操作。</li>
<li>successful - 说明分片及其备份成功了几个。</li>
<li>failures - 一个包含了失败分片及失败原因的数组。</li>
</ul>
<h3 id="自动创建Index"><a href="#自动创建Index" class="headerlink" title="自动创建Index"></a>自动创建Index</h3><p>如果实现没创建index，那么在上面的操作中会自动创建相应的index，如果没创建type，也会为指定的type自动创建一个动态type映射。</p>
<p>这个映射非常灵活，并且模式自由。新的字段和对象会自动的被添加到指定类型的映射定义中去。</p>
<p>自动创建index可以被关闭，在节点配置文件中将 action.auto_create_index 设为 false 就可以了。自动创建type映射也可以关闭，将 index.mapper.dynamic 设为 false就可以了。</p>
<p>自动创建index也可以设置黑白名单，例如，设置 action.auto_create_index 为 +aaa*,-bbb*,+ccc*,-* ， 名字为 aaa*的是可以创建的，为 bbb*的是被禁止的，以此类推。</p>
<h3 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h3><p>每个被index的文档都会有一个版本号。version 字段会在查询时返回给客户端。如果指定了版本号，可使用它做一个乐观锁。可以使用版本号进行一个read-then-update的事务处理。在读的时候指定文档的版本号可以确保期间文档不会发生变化。如果是读而不是更新操作，可以设置为preference 来替代 _primary。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;localhost:9200/twitter/tweet/1?version=2&apos; -d &apos;&#123;</div><div class="line">    &quot;message&quot; : &quot;elasticsearch now has versioning support, double cool!&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>注意：版本操作是实时的，而且不被搜索操作的接近实时所影响。如果没设置版本号，接下来的操作将不会检查版本号。</p>
<p>默认情况下，内部的版本号会从1开始，然后随着每次更新增加。版本号也可以由外部提供。如果要开启外部版本号，需要将version_type设置为external。当设置为版本号为外部版本号时，系统不会检查版本号是否相等，而是当传入的版本号是否大于当前版本号，如果大于，则更新，如果等于或小于，则更新失败。</p>
<h4 id="版本号类型"><a href="#版本号类型" class="headerlink" title="版本号类型"></a>版本号类型</h4><p>除了上面所说的内部和外部版本号类型，es还提供了一些特殊的版本号类型：</p>
<ul>
<li>internal<br>只有在传入的版本号和系统中当前版本号相等时才更新索引。</li>
<li>external 或 external_gt<br>只有在传入的版本号大于系统当前版本号 或者 要更新的文档不存在的时候，才会更新索引。传入的版本号将作为新的版本号，并且会存储新的文档。版本号必须为一个非负的long型。</li>
<li>external_gte<br>和上面唯一不同的是，如果传入的版本号等于当前版本号也可以更新索引。</li>
<li>force<br>无视版本号或者文档是否存在，都直接更新。且传入的版本号作为新的版本号，并会存储新的文档。一般用于改正错误数据。</li>
</ul>
<h3 id="操作类型"><a href="#操作类型" class="headerlink" title="操作类型"></a>操作类型</h3><p>index操作也允许传入 on_type 参数来强制进行 create 操作。当设置为create，如果文档已经存在，index操作将会失败：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT &apos;http://localhost:9200/twitter/tweet/1?op_type=create&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>如果失败，会返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;error&quot;: &#123;</div><div class="line">    &quot;root_cause&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;type&quot;: &quot;document_already_exists_exception&quot;,</div><div class="line">        &quot;reason&quot;: &quot;[tweet][1]: document already exists&quot;,</div><div class="line">        &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">        &quot;shard&quot;: &quot;0&quot;</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;type&quot;: &quot;document_already_exists_exception&quot;,</div><div class="line">    &quot;reason&quot;: &quot;[tweet][1]: document already exists&quot;,</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">    &quot;shard&quot;: &quot;0&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;status&quot;: 409</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>另一种指定 create 的方式是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT &apos;http://localhost:9200/twitter/tweet/1/_create&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h3 id="自动生成ID"><a href="#自动生成ID" class="headerlink" title="自动生成ID"></a>自动生成ID</h3><p>index的操作可以不指定id。id可以自动生成。op_type会自动设置为create。注意，此处用的是POST而不是PUT：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPOST &apos;http://localhost:9200/twitter/tweet/&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;AVdQyYB5e-yIFmSuoS-f&quot;,</div><div class="line">  &quot;_version&quot;: 1,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;created&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>一般情况下，shard的位置是由id的hash来控制的。为了更精确地控制，可以直接在每次操作上指定用于计算hash的值。使用 routing参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPOST &apos;http://localhost:9200/twitter/tweet?routing=kimchy&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>例如上面，就是使用kimchy来计算分片hash，来决定这个文档存放在哪个shard中。</p>
<p>当显示设置了_routing字段，并设置为required，如果index操作中没传递这个参数，将会操作失败。</p>
<h3 id="Parent-amp-Children"><a href="#Parent-amp-Children" class="headerlink" title="Parent &amp; Children"></a>Parent &amp; Children</h3><p>可以在index操作时指定parent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT localhost:9200/blogs/blog_tag/1122?parent=1111 -d &apos;&#123;</div><div class="line">    &quot;tag&quot; : &quot;something&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>当index一个child文档，routing的值会自动设置为何它parent的一致，除非显式指定child的routing。</p>
<h3 id="写一致性"><a href="#写一致性" class="headerlink" title="写一致性"></a>写一致性</h3><p>默认情况下，对index的操作只有在超过半数的分片可用的情况下（quorum）才能成功返回。这个默认值可以通过 action.write_consistency参数来设置。如果想在每次操作时指定，可以使用请求参数 consistency 。参数有效值为one ， quorum和all。 index操作只有在复制组里面所有可用的分片都执行后才返回。</p>
<h3 id="刷新"><a href="#刷新" class="headerlink" title="刷新"></a>刷新</h3><p>想要在index操作后立即就能够查询到结果，需要设置refresh参数为true。将此选项设置为true应该在经过仔细思考和验证后,从索引和搜索的角度来看，它不会影响性能。注意，使用getAPI是实时的，不需要刷新。</p>
<h3 id="Noop-Updates"><a href="#Noop-Updates" class="headerlink" title="Noop Updates"></a>Noop Updates</h3><p>等待更新？。。。这个词不知道怎么翻译比较易懂。。。<br>当使用新的版本号进行index更新时，不管文档内容有没有变，都会创建一个新的文档。如果不能接受这样的操作，可以在使用_update api时将detect_noop设为true。这个选项不能用于index api因为index api不会获取旧的文档，因此，也就不会拿旧的和新的作比较。</p>
<h3 id="Timeout"><a href="#Timeout" class="headerlink" title="Timeout"></a>Timeout</h3><p>当进行index操作时，被安排用于index操作的shard可能暂时不可用。一些因素导致这个情形，比如正在搬迁或者网络异常。默认的，index操作将会等待shard一分钟，如果还不可用就会返回失败。timeout 参数可以用来显式设置等待多久：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT &apos;http://localhost:9200/twitter/tweet/1?timeout=5m&apos; -d &apos;&#123;</div><div class="line">    &quot;user&quot; : &quot;kimchy&quot;,</div><div class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>上例中，设置等待5分钟。</p>
<h2 id="Get-API"><a href="#Get-API" class="headerlink" title="Get API"></a>Get API</h2><p>get API 允许通过id来从index中查找相应的JSON文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 5,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;_source&quot;: &#123;</div><div class="line">    &quot;user&quot;: &quot;kimchy&quot;,</div><div class="line">    &quot;postDate&quot;: &quot;2009-11-15T14:12:12&quot;,</div><div class="line">    &quot;message&quot;: &quot;trying out Elasticsearch&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以通过HEAD来查询文档是否存在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XHEAD -i &apos;http://localhost:9200/twitter/tweet/1&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果可以通过 http status来判断，200 – 存在，404则不存在。</p>
<h3 id="实时性"><a href="#实时性" class="headerlink" title="实时性"></a>实时性</h3><p>一般来说，get API是实时的，它不会被index的刷新频率所影响（当数据变得可搜索后）。</p>
<p>为了关闭实时性，可以传入 realtime参数为false，或者全局设置 action.get.realtime为false。</p>
<h3 id="可选择的Type"><a href="#可选择的Type" class="headerlink" title="可选择的Type"></a>可选择的Type</h3><p>get API可以将_type作为可选项。设置为_all会获取所有符合id的type。</p>
<h3 id="Source过滤器"><a href="#Source过滤器" class="headerlink" title="Source过滤器"></a>Source过滤器</h3><p>一般情况下，get操作都会返回_source内容，除非你设置了fields参数或者关闭_source字段。<br>不返回_source字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1?_source=false&apos;</div></pre></td></tr></table></figure></p>
<p>如果你只需要一两个字段的话，你可以使用_source_include 或 _source_exclude参数来设置。这对于大文档的检索是非常有益的，它可以减少网络中的传输字节数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1?_source_include=*ser&amp;_source_exclude=message&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 5,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;_source&quot;: &#123;</div><div class="line">    &quot;user&quot;: &quot;kimchy&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果仅仅设置include，可以这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1?_source_include=*ser,message&apos;</div></pre></td></tr></table></figure></p>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><p>get操作可以通过fields参数来指定返回的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1?fields=user,message&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 5,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;fields&quot;: &#123;</div><div class="line">    &quot;message&quot;: [</div><div class="line">      &quot;trying out Elasticsearch&quot;</div><div class="line">    ],</div><div class="line">    &quot;user&quot;: [</div><div class="line">      &quot;kimchy&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了向后兼容，如果请求的字段没有存储，它们将从_source中被解析和提取。这个方法会被source过滤器的参数所覆盖。<br>被请求的字段的值将会以数组形式返回。元数据字段，像_routing或者_parent字段则永远不会以数组形式返回。</p>
<h3 id="生成的字段"><a href="#生成的字段" class="headerlink" title="生成的字段"></a>生成的字段</h3><p>如果在indexing后没有刷新，GET将会通过translog日志来查询文档。然而，一些字段只有在indexing时才生成。如果你想要获取索引中的字段，就会产生异常。可以设置来ignore_erros_on_generated_fields=true忽视异常。</p>
<p>translog是一个操作日志。每次进行索引操作后，数据变动都会先存在translog中，之后再刷新到es中。实时查询，其实是读取了translog中还未持久化的数据。</p>
<h3 id="只返回-source"><a href="#只返回-source" class="headerlink" title="只返回_source"></a>只返回_source</h3><p>使用 /{index}/{type}/{id}/_source 可以只返回_source字段。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_source&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;user&quot;: &quot;kimchy&quot;,</div><div class="line">  &quot;postDate&quot;: &quot;2009-11-15T14:12:12&quot;,</div><div class="line">  &quot;message&quot;: &quot;trying out Elasticsearch&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然，还可以指定返回的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_source?_source_include=*ser&amp;_source_exclude=message&apos;</div></pre></td></tr></table></figure></p>
<p>使用HEAD方式请求也可以判断文档是否存在:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XHEAD -i &apos;http://localhost:9200/twitter/tweet/1/_source&apos;</div></pre></td></tr></table></figure></p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>也可以使用路由查询，路由不对的话是查询不到的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1?routing=kimchy&apos;</div></pre></td></tr></table></figure></p>
<h3 id="Preference"><a href="#Preference" class="headerlink" title="Preference"></a>Preference</h3><p>使用preference控制哪个分片来执行get请求。一般情况下，get是在分片中随机执行的。</p>
<ul>
<li>primary: 这个操作仅仅会在主分片上执行。</li>
<li>local : 这个操作会尽可能的在本地分片上执行。</li>
<li>Custom (string) value： 用户可以自定义值，对于相同的分片可以设置相同的值。这样可以保证不同的刷新状态下，查询不同的分片。就像sessionid或者用户名一样。</li>
</ul>
<h3 id="刷新-1"><a href="#刷新-1" class="headerlink" title="刷新"></a>刷新</h3><p>refresh参数可以控制在get操作时，执行刷新，使数据可用。将它设为true时会导致每次查询都先进行刷新，这样会影响系统效率。</p>
<h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>get操作被散列到一个特定的分片id。然后根据分片id直接请求其中一个备份，并返回结果。这个备份是由在这个分片id组里面的主分片和它的备份所组成的。这就意味着，备份数量越多，get的扩展性越好。</p>
<h3 id="版本支持"><a href="#版本支持" class="headerlink" title="版本支持"></a>版本支持</h3><p>当指定的version参数和当前版本一致时，可以获取文档。当版本类型为FORCE的时候，所有的版本类型都可以检索文档。<br>在删除一个文档后，es在内部并不立即删除这个文档，而是将它标记起来，当然， 你也不能进行访问。es会在后台逐渐清理掉这些文档。</p>
<h2 id="Delete-API"><a href="#Delete-API" class="headerlink" title="Delete API"></a>Delete API</h2><p>delete API允许通过指定的id来删除对应的文档。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -XDELETE &apos;http://localhost:9200/twitter/tweet/1&apos;</div></pre></td></tr></table></figure></p>
<p>返回:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_shards&quot; : &#123;</div><div class="line">        &quot;total&quot; : 10,</div><div class="line">        &quot;failed&quot; : 0,</div><div class="line">        &quot;successful&quot; : 10</div><div class="line">    &#125;,</div><div class="line">    &quot;found&quot; : true,</div><div class="line">    &quot;_index&quot; : &quot;twitter&quot;,</div><div class="line">    &quot;_type&quot; : &quot;tweet&quot;,</div><div class="line">    &quot;_id&quot; : &quot;1&quot;,</div><div class="line">    &quot;_version&quot; : 2</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="版本号-1"><a href="#版本号-1" class="headerlink" title="版本号"></a>版本号</h3><p>每个文档的索引都是有版本号的。当删除文档时，需要指定文档的version，并且在我们要进行删除操作时，版本号不能被其它的程序改变，因为更新等操作都会引起版本号的改变。</p>
<h3 id="路由-1"><a href="#路由-1" class="headerlink" title="路由"></a>路由</h3><p>也可以指定路由来进行删除，路有错误的话会导致删除失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -XDELETE &apos;http://localhost:9200/twitter/tweet/1?routing=kimchy&apos;</div></pre></td></tr></table></figure></p>
<h3 id="Parent"><a href="#Parent" class="headerlink" title="Parent"></a>Parent</h3><p>删除操作也可以指定父文档。再删除父文档的时候，不会删除子文档。有一种删除子文档的方法，就是使用delete-by-query。</p>
<h3 id="自动创建索引"><a href="#自动创建索引" class="headerlink" title="自动创建索引"></a>自动创建索引</h3><p>在执行删除操作时，如果当前索引不存在，则会自动创建一个索引，同时自动创建一个指定的type。</p>
<h3 id="分布式-1"><a href="#分布式-1" class="headerlink" title="分布式"></a>分布式</h3><p>和get API中的意思差不多。</p>
<h3 id="写一致性-1"><a href="#写一致性-1" class="headerlink" title="写一致性"></a>写一致性</h3><p>操作是否能成功执行，是由对应的组里面的可用的分片备份数量决定的。这个值可以是one, quorum 和 all。可以用consistency 请求参数来设置。节点级的设置是在 action.write_consistency ， 默认是quorum。</p>
<h3 id="刷新-2"><a href="#刷新-2" class="headerlink" title="刷新"></a>刷新</h3><p>refresh参数设置为true，可以在删除操作执行后，立即刷新分片，保证其数据可以立即被查询。不过要慎用！</p>
<h3 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h3><p>当分片不可用的时候，删除操作会等待一段时间执行。可以设置其timeout。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -XDELETE &apos;http://localhost:9200/twitter/tweet/1?timeout=5m&apos;</div></pre></td></tr></table></figure></p>
<h2 id="Update-API"><a href="#Update-API" class="headerlink" title="Update API"></a>Update API</h2><p>updateAPI 允许通过脚本来更新文档。它使用版本管理来控制在get和reindex时不会有更新操作。<br>注意，update这个操作是重新索引文档，它只是减少了网络影响和版本冲突。</p>
<p>首先，创建一个索引文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPUT localhost:9200/test/type1/1 -d &apos;&#123;</div><div class="line">    &quot;counter&quot; : 1,</div><div class="line">    &quot;tags&quot; : [&quot;red&quot;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h3 id="使用脚本更新"><a href="#使用脚本更新" class="headerlink" title="使用脚本更新"></a>使用脚本更新</h3><p>可以通过执行一个脚本来增加counter：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;ctx._source.counter += count&quot;,</div><div class="line">        &quot;params&quot; : &#123;</div><div class="line">            &quot;count&quot; : 4</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或者也可以添加一个tag到tags[]中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;ctx._source.tags.add(params.tag)&quot;,</div><div class="line">        &quot;params&quot; : &#123;</div><div class="line">            &quot;tag&quot; : &quot;blue&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除了_source，还可以通过ctx来获得这些变量： _index , _type , _id, _version , _routing , _parent , 和 _now (当前时间戳)。</p>
<p>比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;ctx._source.tages.add(ctx._id)&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除此之外，我们还可以为文档添加一个新的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &quot;ctx._source.new_field = \&quot;value_of_new_field\&quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>字段为 new_field ， 且值为value_of_new_field。</p>
<p>也可以删除字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &quot;ctx._source.remove(\&quot;new_field\&quot;)&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>甚至，我们还可以通过一系列逻辑判断来改变它的操作类型，例子中，如果tags包含 green，则删除文档，否则什么都不做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;if (ctx._source.tags.contains(tag)) &#123; ctx.op = \&quot;delete\&quot; &#125; else &#123; ctx.op = \&quot;none\&quot; &#125;&quot;,</div><div class="line">        &quot;params&quot; : &#123;</div><div class="line">            &quot;tag&quot; : &quot;green&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="通过文档来更新"><a href="#通过文档来更新" class="headerlink" title="通过文档来更新"></a>通过文档来更新</h3><p>updateAPI还支持传递一部分文档，这部分文档将会被合并到当前文档中，使用doc可以实现简单的递归合并、内部合并、替换KV以及数组。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;doc&quot; : &#123;</div><div class="line">        &quot;name&quot; : &quot;new_name&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果 doc 和 script 都被指定了，那么doc会被忽略。最好的方式是将doc的操作也放到 script 中去执行。</p>
<h3 id="更新检测"><a href="#更新检测" class="headerlink" title="更新检测"></a>更新检测</h3><p>如果doc中定义的部分与现在的文档相同，则默认不会执行任何动作。设置detect_noop=false，就会无视是否修改，强制合并到现有的文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;doc&quot; : &#123;</div><div class="line">        &quot;name&quot; : &quot;new_name&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面例子中，执行后的结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;test&quot;,</div><div class="line">  &quot;_type&quot;: &quot;type1&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 9,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 0,</div><div class="line">    &quot;successful&quot;: 0,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果请求设置了<code>&quot;detect_noop&quot;: false</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;doc&quot; : &#123;</div><div class="line">        &quot;name&quot; : &quot;new_name&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;detect_noop&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那么：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;test&quot;,</div><div class="line">  &quot;_type&quot;: &quot;type1&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 10,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Upserts"><a href="#Upserts" class="headerlink" title="Upserts"></a>Upserts</h3><p>如果文档不存在，那么upsert 元素的内容将被插入到文档中，如果文档存在，则执行脚本。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;ctx._source.counter += count&quot;,</div><div class="line">        &quot;params&quot; : &#123;</div><div class="line">            &quot;count&quot; : 4</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;upsert&quot; : &#123;</div><div class="line">        &quot;counter&quot; : 1</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="scripted-upsert"><a href="#scripted-upsert" class="headerlink" title="scripted_upsert"></a>scripted_upsert</h4><p>如果你想不管文档存不存在都执行脚本，可以设置 scripted_upsert 为 true。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">POST test/type1/1/_update</div><div class="line">&#123;</div><div class="line">	&quot;scripted_upsert&quot;:true,</div><div class="line">    &quot;script&quot; : &#123;</div><div class="line">        &quot;inline&quot;: &quot;ctx._source.counter += count&quot;,</div><div class="line">        &quot;params&quot; : &#123;</div><div class="line">            &quot;count&quot; : 4</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;upsert&quot; : &#123;</div><div class="line">        &quot;counters&quot; : 1</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样，counters不会被插入到文档中，而是只会执行脚本内容。</p>
<h4 id="doc-as-upsert"><a href="#doc-as-upsert" class="headerlink" title="doc_as_upsert"></a>doc_as_upsert</h4><p>当使用doc时，如果id为2的文档不存在，那么会报错，而如果使用doc_as_upsert，则可以在文档不存在的时候，把doc中的内容插入到文档中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST test/type1/2/_update</div><div class="line">&#123;</div><div class="line">    &quot;doc&quot; : &#123;</div><div class="line">        &quot;name&quot; : &quot;new_name&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;doc_as_upsert&quot; : true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul>
<li><p>retry_on_conflict : 当执行索引和更新的时候，有可能另一个进程正在执行更新。这个时候就会造成冲突，这个参数就是用于定义当遇到冲突时，重试的次数。</p>
</li>
<li><p>routing ： routing是用来为update请求路由到正确的分片的，并且当文档不存在时进行upsert操作。不能用来更新现有文档的路由。</p>
</li>
<li><p>parent： parent用来路由到正确的分片，并且当文档不存在时进行upsert操作。不能用来更新现有文档的 parent。如果一个index的路由被指定了，那么它会覆盖parent的路由，并且用新的路由来路由请求。</p>
</li>
<li><p>timeout ： 用来等待一个分片可用。</p>
</li>
<li><p>wait_for_active_shards ： 指定在更新操作前，分片副本可用的数量。</p>
</li>
<li><p>refresh : 当执行操作的时候，会自动刷新索引。</p>
</li>
<li><p>_source ： 控制被更新的source是否、如何返回。默认情况下，update操作是不返回source的。</p>
</li>
<li><p>version &amp; version_type ： updateAPI使用es的版本号来保证文档在update时没有被改变。可以使用 version参数来指定，只有当version号匹配当前版本号时，才能更新成功。你也可以使用 force 参数来强制指定版本号来更新，不过这一般用于版本修正。</p>
</li>
</ul>
<p>更新操作是不支持外部版本号的，因为本来外部版本号就脱离系统的版本控制，如果再执行更新操作，那就彻底乱了。如果使用了外部版本号，可以使用Index代替更新操作，重新索引文档。</p>
<h2 id="Update-By-Query-API"><a href="#Update-By-Query-API" class="headerlink" title="Update By Query API"></a>Update By Query API</h2><p>update By Query API 是一个新的功能，尚需实践检验，因此，以后可能会有所修改，并且不向后兼容。</p>
<p>这个api会更新索引中的每一个文档并且不改变它们的source。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">POST twitter/_update_by_query?conflicts=proceed</div></pre></td></tr></table></figure></p>
<p>执行结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 2549,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;total&quot;: 3,</div><div class="line">  &quot;updated&quot;: 3,</div><div class="line">  &quot;batches&quot;: 1,</div><div class="line">  &quot;version_conflicts&quot;: 0,</div><div class="line">  &quot;noops&quot;: 0,</div><div class="line">  &quot;retries&quot;: 0,</div><div class="line">  &quot;throttled_millis&quot;: 0,</div><div class="line">  &quot;requests_per_second&quot;: &quot;unlimited&quot;,</div><div class="line">  &quot;throttled_until_millis&quot;: 0,</div><div class="line">  &quot;failures&quot;: []</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>_update_by_query 会在执行时获取一个index的快照，并且用内部版本号对它找到的文档进行索引。这意味着如果在快照生成和处理索引请求时文档有所改变，你会遇到版本冲突问题。当版本号匹配时，文档会进行更新，并且版本号会增加。</p>
<p>所有的查询和更新失败都会导致_update_by_query的终止并且返回失败信息。但是已更新的数据不会被回滚。当第一条失败时，会导致程序中止，这意味着所有的更新失败，这时候会返回大量的失败元素。</p>
<p>如果你想当版本冲突时只进行简单的计数，而不中止，可以在url中设置 conflicts=proceed或者在请求内容中设置”conflicts”: “proceed”，在api中，可以只针对索引中的一个类型进行操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">POST twitter/tweet/_update_by_query?conflicts=proceed</div></pre></td></tr></table></figure></p>
<p>还可以使用Query DSL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">POST twitter/_update_by_query?conflicts=proceed</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; </div><div class="line">    &quot;term&quot;: &#123;</div><div class="line">      &quot;user&quot;: &quot;kimchy&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之前介绍的都是没有改变文档内容的，其实_update_by_query是可以在支持脚本对文档内容的更新。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">POST twitter/_update_by_query</div><div class="line">&#123;</div><div class="line">  &quot;script&quot;: &#123;</div><div class="line">    &quot;inline&quot;: &quot;ctx._source.likes++&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;term&quot;: &#123;</div><div class="line">      &quot;user&quot;: &quot;kimchy&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Multi-Get-API"><a href="#Multi-Get-API" class="headerlink" title="Multi Get API"></a>Multi Get API</h2><p>Mget api 可以获得多个文档结果，它们会以数组方式返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_mget&apos; -d &apos;&#123;</div><div class="line">    &quot;docs&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_index&quot; : &quot;test&quot;,</div><div class="line">            &quot;_type&quot; : &quot;type&quot;,</div><div class="line">            &quot;_id&quot; : &quot;1&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;_index&quot; : &quot;test&quot;,</div><div class="line">            &quot;_type&quot; : &quot;type&quot;,</div><div class="line">            &quot;_id&quot; : &quot;2&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>它也可以指定index或type：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/test/type/_mget&apos; -d &apos;&#123;</div><div class="line">    &quot;docs&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_id&quot; : &quot;1&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;_id&quot; : &quot;2&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>或者指定id:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/test/type/_mget&apos; -d &apos;&#123;</div><div class="line">    &quot;ids&quot; : [&quot;1&quot;, &quot;2&quot;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h3 id="source-过滤"><a href="#source-过滤" class="headerlink" title="_source 过滤"></a>_source 过滤</h3><p>还可以指定_source中包含的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_mget&apos; -d &apos;&#123;</div><div class="line">    &quot;docs&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_index&quot; : &quot;test&quot;,</div><div class="line">            &quot;_type&quot; : &quot;type&quot;,</div><div class="line">            &quot;_id&quot; : &quot;1&quot;,</div><div class="line">            &quot;_source&quot; : false</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;_index&quot; : &quot;test&quot;,</div><div class="line">            &quot;_type&quot; : &quot;type&quot;,</div><div class="line">            &quot;_id&quot; : &quot;2&quot;,</div><div class="line">            &quot;_source&quot; : [&quot;field3&quot;, &quot;field4&quot;]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;_index&quot; : &quot;test&quot;,</div><div class="line">            &quot;_type&quot; : &quot;type&quot;,</div><div class="line">            &quot;_id&quot; : &quot;3&quot;,</div><div class="line">            &quot;_source&quot; : &#123;</div><div class="line">                &quot;include&quot;: [&quot;user&quot;],</div><div class="line">                &quot;exclude&quot;: [&quot;user.location&quot;]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h3 id="field-过滤"><a href="#field-过滤" class="headerlink" title="field 过滤"></a>field 过滤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/test/type/_mget?stored_fields=field1,field2&apos; -d &apos;&#123;</div><div class="line">    &quot;docs&quot; : [</div><div class="line">        &#123;</div><div class="line">            &quot;_id&quot; : &quot;1&quot; </div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;_id&quot; : &quot;2&quot;,</div><div class="line">            &quot;stored_fields&quot; : [&quot;field3&quot;, &quot;field4&quot;] </div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<h2 id="Bulk-API"><a href="#Bulk-API" class="headerlink" title="Bulk API"></a>Bulk API</h2><p>bulk API 可以通过一条请求来实现多个增加、删除操作，这能很有效的提高索引速度。</p>
<p>bulk默认的json格式是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">action_and_meta_data\n</div><div class="line">optional_source\n</div><div class="line">action_and_meta_data\n</div><div class="line">optional_source\n</div><div class="line">....</div><div class="line">action_and_meta_data\n</div><div class="line">optional_source\n</div></pre></td></tr></table></figure></p>
<p>注意，它是以 \n 为每行的结束符。<br>一般，它用做index，create，delete和update操作。index和create的source放在下一行，而delete只需一行，update则是由于有script、upsert等操作，不局限于两行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -s -XPOST localhost:9200/_bulk</div><div class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</div><div class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</div></pre></td></tr></table></figure>
<p>多种操作的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</div><div class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</div><div class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</div><div class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</div><div class="line">&#123; &quot;field1&quot; : &quot;value3&quot; &#125;</div><div class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;type1&quot;, &quot;_index&quot; : &quot;index1&quot;&#125; &#125;</div><div class="line">&#123; &quot;doc&quot; : &#123;&quot;field2&quot; : &quot;value2&quot;&#125; &#125;</div></pre></td></tr></table></figure></p>
<p>在url中可以设置 index 和type ，如果在doc中也设置了，那么会覆盖掉url中的设置。</p>
<h2 id="Reindex-API"><a href="#Reindex-API" class="headerlink" title="Reindex API"></a>Reindex API</h2><p>reindex API 也是一个实验性质的，不保证向后兼容。</p>
<p>Reindex API 不会建立一个目标index，他也不会复制源索引的配置。你需要在运行_reindex之前配置好映射，分片和复制。</p>
<p>_reindex最基本的用法是将文档从一个索引拷贝到另一个索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和update_by_query 一样，_reindex从源索引得到一个快照，并且目标索引必须是不同的索引，而且也不会引起版本冲突。 dest 元素可以像 indexAPI那样配置，来执行乐观并发控制。可以不管version_type 或者设置它为internal ，这会使es直接将数据拷贝到目标索引，不管数据的并发情况:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;,</div><div class="line">    &quot;version_type&quot;: &quot;internal&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将version_type设置为external会导致es将version保存在source中，在更新文档的时候进行一个乐观的版本控制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;,</div><div class="line">    &quot;version_type&quot;: &quot;external&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>设置op_type为create将会导致_reindex仅仅只会创建没有的文档，而已经存在的文档则会导致版本冲突：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;,</div><div class="line">    &quot;op_type&quot;: &quot;create&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认情况下，版本冲突会导致_reindex进程停止，可是设置<code>&quot;conflicts&quot;: &quot;proceed&quot;</code>来计算失败的数量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;conflicts&quot;: &quot;proceed&quot;,</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;,</div><div class="line">    &quot;op_type&quot;: &quot;create&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以根据查询结果来进行拷贝：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">    &quot;type&quot;: &quot;tweet&quot;,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;term&quot;: &#123;</div><div class="line">        &quot;user&quot;: &quot;kimchy&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>指定多个index或type:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: [&quot;twitter&quot;, &quot;blog&quot;],</div><div class="line">    &quot;type&quot;: [&quot;tweet&quot;, &quot;post&quot;]</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;all_together&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还可以加上排序条件和条数限制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 10000,</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;,</div><div class="line">    &quot;sort&quot;: &#123; &quot;date&quot;: &quot;desc&quot; &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>加入script：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;twitter&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;new_twitter&quot;,</div><div class="line">    &quot;version_type&quot;: &quot;external&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;script&quot;: &#123;</div><div class="line">    &quot;inline&quot;: &quot;if (ctx._source.foo == &apos;bar&apos;) &#123;ctx._version++; ctx._source.remove(&apos;foo&apos;)&#125;&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="从远程服务器reindex"><a href="#从远程服务器reindex" class="headerlink" title="从远程服务器reindex"></a>从远程服务器reindex</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">POST _reindex</div><div class="line">&#123;</div><div class="line">  &quot;source&quot;: &#123;</div><div class="line">    &quot;remote&quot;: &#123;</div><div class="line">      &quot;host&quot;: &quot;http://otherhost:9200&quot;,</div><div class="line">      &quot;username&quot;: &quot;user&quot;,</div><div class="line">      &quot;password&quot;: &quot;pass&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;index&quot;: &quot;source&quot;,</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">      &quot;match&quot;: &#123;</div><div class="line">        &quot;test&quot;: &quot;data&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;dest&quot;: &#123;</div><div class="line">    &quot;index&quot;: &quot;dest&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Term-Vectors"><a href="#Term-Vectors" class="headerlink" title="Term Vectors"></a>Term Vectors</h2><p>返回一个带有词条信息和统计的特殊的文档。这个文档可以存在索引中，或者由用户人为提供。词条信息默认是实时的，可以通过realtime 参数设为 true 来改成非实时的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_termvectors?pretty=true&apos;</div></pre></td></tr></table></figure></p>
<p>也可以指定字段，返回这个字段的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_termvectors?fields=text,...&apos;</div></pre></td></tr></table></figure></p>
<h3 id="返回的信息"><a href="#返回的信息" class="headerlink" title="返回的信息"></a>返回的信息</h3><p>可以请求三种信息：词条信息、词条统计以及字段统计。默认情况下，会返回所有词条信息和字段统计，但不会返回词条统计。</p>
<h4 id="词条信息"><a href="#词条信息" class="headerlink" title="词条信息"></a>词条信息</h4><ul>
<li>词条在字段中的出现频率（始终返回）</li>
<li>词条位置（position:true）</li>
<li>开始和结束偏移量（offsets:true）</li>
<li>词条容量（payloads : true） ，比如base64编码的字节数。</li>
</ul>
<p>如果请求的信息不在索引中，它将尽量不计算。另外，term vectors甚至可以计算不在索引中而是由用户提供的文档。</p>
<h4 id="词条统计"><a href="#词条统计" class="headerlink" title="词条统计"></a>词条统计</h4><p>将term_statistics 设为 true 可以返回：</p>
<ul>
<li>词条整体出现频率（词条在所有文档中出现的频率）</li>
<li>文档频率（包含当前词条的文档数）</li>
</ul>
<p>默认情况下，这两个都不会返回，因为会影响系统效率。</p>
<h4 id="字段统计"><a href="#字段统计" class="headerlink" title="字段统计"></a>字段统计</h4><p>默认情况下，field_statistics ： true ， 这会返回：</p>
<ul>
<li>包含这个字段的文档数</li>
<li>所有包含这个字段的文档中这个字段包含的所有词条出现频率的总和。</li>
<li>这个字段中包含的每一个词条的出现频率总和。</li>
</ul>
<h4 id="词条过滤"><a href="#词条过滤" class="headerlink" title="词条过滤"></a>词条过滤</h4><p>通过filter参数，返回的词条可以基于它们的 tf-idf分数进行过滤。这对于为了找出一个特定的文档是很有帮助的。有以下几个参数可用：</p>
<ul>
<li>max_num_terms : 每个字段必须返回的最大词条数量，默认是25。</li>
<li>min_term_freg : 忽略在source中词语频率低于这个值的词条。默认是1.</li>
<li>max_term_freq ： 与上面相反。默认是无穷大。</li>
<li>min_doc_freq ： 忽略词条出现频率低于这个值的文档。默认是1.</li>
<li>max_doc_freq ： 与上面相反，默认是无穷大。</li>
<li>min_word_length ： 忽略长度短语这个值的短语。 默认是0。</li>
<li>max_word_length ： 与上面相反，默认是无穷大。</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>首先创建存有 term vectors ， payloads 的索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">curl -s -XPUT &apos;http://localhost:9200/twitter/&apos; -d &apos;&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;tweet&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;text&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;term_vector&quot;: &quot;with_positions_offsets_payloads&quot;,</div><div class="line">          &quot;store&quot; : true,</div><div class="line">          &quot;analyzer&quot; : &quot;fulltext_analyzer&quot;</div><div class="line">         &#125;,</div><div class="line">         &quot;fullname&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;term_vector&quot;: &quot;with_positions_offsets_payloads&quot;,</div><div class="line">          &quot;analyzer&quot; : &quot;fulltext_analyzer&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;settings&quot; : &#123;</div><div class="line">    &quot;index&quot; : &#123;</div><div class="line">      &quot;number_of_shards&quot; : 1,</div><div class="line">      &quot;number_of_replicas&quot; : 0</div><div class="line">    &#125;,</div><div class="line">    &quot;analysis&quot;: &#123;</div><div class="line">      &quot;analyzer&quot;: &#123;</div><div class="line">        &quot;fulltext_analyzer&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;custom&quot;,</div><div class="line">          &quot;tokenizer&quot;: &quot;whitespace&quot;,</div><div class="line">          &quot;filter&quot;: [</div><div class="line">            &quot;lowercase&quot;,</div><div class="line">            &quot;type_as_payload&quot;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>添加数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;http://localhost:9200/twitter/tweet/1?pretty=true&apos; -d &apos;&#123;</div><div class="line">  &quot;fullname&quot; : &quot;John Doe&quot;,</div><div class="line">  &quot;text&quot; : &quot;twitter test test test &quot;</div><div class="line">&#125;&apos;</div><div class="line"></div><div class="line">curl -XPUT &apos;http://localhost:9200/twitter/tweet/2?pretty=true&apos; -d &apos;&#123;</div><div class="line">  &quot;fullname&quot; : &quot;Jane Doe&quot;,</div><div class="line">  &quot;text&quot; : &quot;Another twitter test ...&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h4 id="查询id-1-的text字段的所有信息和统计："><a href="#查询id-1-的text字段的所有信息和统计：" class="headerlink" title="查询id=1 的text字段的所有信息和统计："></a>查询id=1 的text字段的所有信息和统计：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_termvectors?pretty=true&apos; -d &apos;&#123;</div><div class="line">  &quot;fields&quot; : [&quot;text&quot;],</div><div class="line">  &quot;offsets&quot; : true,</div><div class="line">  &quot;payloads&quot; : true,</div><div class="line">  &quot;positions&quot; : true,</div><div class="line">  &quot;term_statistics&quot; : true,</div><div class="line">  &quot;field_statistics&quot; : true</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>返回结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 1,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;took&quot;: 91,</div><div class="line">  &quot;term_vectors&quot;: &#123;</div><div class="line">    &quot;text&quot;: &#123;</div><div class="line">      &quot;field_statistics&quot;: &#123;</div><div class="line">        &quot;sum_doc_freq&quot;: 6   //该字段中词的出现频率(在所有文档中),</div><div class="line">        &quot;doc_count&quot;: 2    // 包含该字段的文档数</div><div class="line">        &quot;sum_ttf&quot;: 8      // 该字段中词的数量（包含重复的词）</div><div class="line">      &#125;,</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;test&quot;: &#123;</div><div class="line">          &quot;doc_freq&quot;: 2,   //该词出现在几个文档中</div><div class="line">          &quot;ttf&quot;: 4,		   //该词出现的次数</div><div class="line">          &quot;term_freq&quot;: 3,  //该词在这个文档中出现的频率</div><div class="line">          &quot;tokens&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 1,</div><div class="line">              &quot;start_offset&quot;: 8,</div><div class="line">              &quot;end_offset&quot;: 12,</div><div class="line">              &quot;payload&quot;: &quot;d29yZA==&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 2,</div><div class="line">              &quot;start_offset&quot;: 13,</div><div class="line">              &quot;end_offset&quot;: 17,</div><div class="line">              &quot;payload&quot;: &quot;d29yZA==&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 3,</div><div class="line">              &quot;start_offset&quot;: 18,</div><div class="line">              &quot;end_offset&quot;: 22,</div><div class="line">              &quot;payload&quot;: &quot;d29yZA==&quot;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        &quot;twitter&quot;: &#123;</div><div class="line">          &quot;doc_freq&quot;: 2,</div><div class="line">          &quot;ttf&quot;: 2,</div><div class="line">          &quot;term_freq&quot;: 1,</div><div class="line">          &quot;tokens&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 0,</div><div class="line">              &quot;start_offset&quot;: 0,</div><div class="line">              &quot;end_offset&quot;: 7,</div><div class="line">              &quot;payload&quot;: &quot;d29yZA==&quot;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="对不在索引中存储的文档进行统计"><a href="#对不在索引中存储的文档进行统计" class="headerlink" title="对不在索引中存储的文档进行统计"></a>对不在索引中存储的文档进行统计</h4><p>下面这个文档并没有在索引中，但是也可以对它进行统计：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/1/_termvectors?pretty=true&apos; -d &apos;&#123;</div><div class="line">  &quot;fields&quot; : [&quot;text&quot;, &quot;some_field_without_term_vectors&quot;],</div><div class="line">  &quot;offsets&quot; : true,</div><div class="line">  &quot;positions&quot; : true,</div><div class="line">  &quot;term_statistics&quot; : true,</div><div class="line">  &quot;field_statistics&quot; : true</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h4 id="在请求中人为定义的文档"><a href="#在请求中人为定义的文档" class="headerlink" title="在请求中人为定义的文档"></a>在请求中人为定义的文档</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/_termvectors&apos; -d &apos;&#123;</div><div class="line">  &quot;doc&quot; : &#123;</div><div class="line">    &quot;fullname&quot; : &quot;John Doe&quot;,</div><div class="line">    &quot;text&quot; : &quot;twitter test test test&quot;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>如果设置了动态mapping，那么如果文档不存在会自动添加。</p>
<h4 id="针对每一个字段分析"><a href="#针对每一个字段分析" class="headerlink" title="针对每一个字段分析"></a>针对每一个字段分析</h4><p>可以使用per_field_analyzer参数定义该字段的分析器，这样每个字段都可以使用不同的分析器，分析其词条向量的信息。如果这个字段已经经过存储，那么会重新生成它的词条向量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;http://localhost:9200/twitter/tweet/_termvectors&apos; -d &apos;&#123;</div><div class="line">  &quot;doc&quot; : &#123;</div><div class="line">    &quot;fullname&quot; : &quot;John Doe&quot;,</div><div class="line">    &quot;text&quot; : &quot;twitter test test test&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;fields&quot;: [&quot;fullname&quot;],</div><div class="line">  &quot;per_field_analyzer&quot; : &#123;</div><div class="line">    &quot;fullname&quot;: &quot;keyword&quot;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_version&quot;: 0,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;took&quot;: 178,</div><div class="line">  &quot;term_vectors&quot;: &#123;</div><div class="line">    &quot;fullname&quot;: &#123;</div><div class="line">      &quot;field_statistics&quot;: &#123;</div><div class="line">        &quot;sum_doc_freq&quot;: 4,</div><div class="line">        &quot;doc_count&quot;: 2,</div><div class="line">        &quot;sum_ttf&quot;: 4</div><div class="line">      &#125;,</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;John Doe&quot;: &#123;</div><div class="line">          &quot;term_freq&quot;: 1,</div><div class="line">          &quot;tokens&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 0,</div><div class="line">              &quot;start_offset&quot;: 0,</div><div class="line">              &quot;end_offset&quot;: 8</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;text&quot;: &#123;</div><div class="line">      &quot;field_statistics&quot;: &#123;</div><div class="line">        &quot;sum_doc_freq&quot;: 6,</div><div class="line">        &quot;doc_count&quot;: 2,</div><div class="line">        &quot;sum_ttf&quot;: 8</div><div class="line">      &#125;,</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;test&quot;: &#123;</div><div class="line">          &quot;term_freq&quot;: 3,</div><div class="line">          &quot;tokens&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 1,</div><div class="line">              &quot;start_offset&quot;: 8,</div><div class="line">              &quot;end_offset&quot;: 12</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 2,</div><div class="line">              &quot;start_offset&quot;: 13,</div><div class="line">              &quot;end_offset&quot;: 17</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 3,</div><div class="line">              &quot;start_offset&quot;: 18,</div><div class="line">              &quot;end_offset&quot;: 22</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        &quot;twitter&quot;: &#123;</div><div class="line">          &quot;term_freq&quot;: 1,</div><div class="line">          &quot;tokens&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;position&quot;: 0,</div><div class="line">              &quot;start_offset&quot;: 0,</div><div class="line">              &quot;end_offset&quot;: 7</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="过滤词条"><a href="#过滤词条" class="headerlink" title="过滤词条"></a>过滤词条</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /twitter/tweet/_termvectors</div><div class="line">&#123;</div><div class="line">    &quot;doc&quot;: &#123;</div><div class="line">      &quot;plot&quot;: &quot;When wealthy industrialist Tony Stark is forced to build an armored suit after a life-threatening incident, he ultimately decides to use its technology to fight against evil.&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;term_statistics&quot; : true,</div><div class="line">    &quot;field_statistics&quot; : true,</div><div class="line">    &quot;positions&quot;: false,</div><div class="line">    &quot;offsets&quot;: false,</div><div class="line">    &quot;filter&quot; : &#123;</div><div class="line">      &quot;max_num_terms&quot; : 3,</div><div class="line">      &quot;min_term_freq&quot; : 1,</div><div class="line">      &quot;min_doc_freq&quot; : 1</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;twitter&quot;,</div><div class="line">  &quot;_type&quot;: &quot;tweet&quot;,</div><div class="line">  &quot;_version&quot;: 0,</div><div class="line">  &quot;found&quot;: true,</div><div class="line">  &quot;took&quot;: 1324,</div><div class="line">  &quot;term_vectors&quot;: &#123;</div><div class="line">    &quot;plot&quot;: &#123;</div><div class="line">      &quot;field_statistics&quot;: &#123;</div><div class="line">        &quot;sum_doc_freq&quot;: 26,</div><div class="line">        &quot;doc_count&quot;: 1,</div><div class="line">        &quot;sum_ttf&quot;: 28</div><div class="line">      &#125;,</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;after&quot;: &#123;</div><div class="line">          &quot;doc_freq&quot;: 1,</div><div class="line">          &quot;ttf&quot;: 1,</div><div class="line">          &quot;term_freq&quot;: 1,</div><div class="line">          &quot;score&quot;: 0.30685282</div><div class="line">        &#125;,</div><div class="line">        &quot;against&quot;: &#123;</div><div class="line">          &quot;doc_freq&quot;: 1,</div><div class="line">          &quot;ttf&quot;: 1,</div><div class="line">          &quot;term_freq&quot;: 1,</div><div class="line">          &quot;score&quot;: 0.30685282</div><div class="line">        &#125;,</div><div class="line">        &quot;to&quot;: &#123;</div><div class="line">          &quot;doc_freq&quot;: 1,</div><div class="line">          &quot;ttf&quot;: 3,</div><div class="line">          &quot;term_freq&quot;: 3,</div><div class="line">          &quot;score&quot;: 0.92055845</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Multi-termvectors-API"><a href="#Multi-termvectors-API" class="headerlink" title="Multi termvectors API"></a>Multi termvectors API</h2><p>这个API可以进行一次获得多个termvectors。可以通过指定索引、类型或者id来实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_mtermvectors&apos; -d &apos;&#123;</div><div class="line">   &quot;docs&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot;: &quot;testidx&quot;,</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;_id&quot;: &quot;2&quot;,</div><div class="line">         &quot;term_statistics&quot;: true</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot;: &quot;testidx&quot;,</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;_id&quot;: &quot;1&quot;,</div><div class="line">         &quot;fields&quot;: [</div><div class="line">            &quot;text&quot;</div><div class="line">         ]</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>参数方面，和termvectors一致，具体参照termvectors。</p>
<p>指定index的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/testidx/_mtermvectors&apos; -d &apos;&#123;</div><div class="line">   &quot;docs&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;_id&quot;: &quot;2&quot;,</div><div class="line">         &quot;fields&quot;: [</div><div class="line">            &quot;text&quot;</div><div class="line">         ],</div><div class="line">         &quot;term_statistics&quot;: true</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;_id&quot;: &quot;1&quot;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>指定type的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/testidx/test/_mtermvectors&apos; -d &apos;&#123;</div><div class="line">   &quot;docs&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;_id&quot;: &quot;2&quot;,</div><div class="line">         &quot;fields&quot;: [</div><div class="line">            &quot;text&quot;</div><div class="line">         ],</div><div class="line">         &quot;term_statistics&quot;: true</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_id&quot;: &quot;1&quot;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>如果所有的文档都是同一个index和type，那么就简单很多：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/testidx/test/_mtermvectors&apos; -d &apos;&#123;</div><div class="line">    &quot;ids&quot; : [&quot;1&quot;, &quot;2&quot;],</div><div class="line">    &quot;parameters&quot;: &#123;</div><div class="line">        &quot;fields&quot;: [</div><div class="line">                &quot;text&quot;</div><div class="line">        ],</div><div class="line">        &quot;term_statistics&quot;: true,</div><div class="line">        …</div><div class="line">    &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>和termvectors一样，也能够使用用户自己定义的文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_mtermvectors&apos; -d &apos;&#123;</div><div class="line">   &quot;docs&quot;: [</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot;: &quot;testidx&quot;,</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;doc&quot; : &#123;</div><div class="line">            &quot;fullname&quot; : &quot;John Doe&quot;,</div><div class="line">            &quot;text&quot; : &quot;twitter test test test&quot;</div><div class="line">         &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot;: &quot;testidx&quot;,</div><div class="line">         &quot;_type&quot;: &quot;test&quot;,</div><div class="line">         &quot;doc&quot; : &#123;</div><div class="line">           &quot;fullname&quot; : &quot;Jane Doe&quot;,</div><div class="line">           &quot;text&quot; : &quot;Another twitter test ...&quot;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/22/Elasticsearch学习笔记：二、基本设置/" itemprop="url">
                  Elasticsearch学习笔记：二、基本设置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-22T09:49:19+08:00" content="2016-09-22">
              2016-09-22
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="JAVA版本"><a href="#JAVA版本" class="headerlink" title="JAVA版本"></a>JAVA版本</h3><p>es是由java开发的，运行也需要java环境。需要保证jdk至少是1.7及以上的。且仅支持Oracle’sJava和OpenJDK。在es的所有节点和客户端中，jdk的版本号应该是一致的。<br>官方推荐安装jdk8 update20及以后或者jdk8 update 55及以后。之前的版本有bug因此会容易丢失数据。es也会自动判断，如果是不好的版本，它会拒绝启动。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>在<a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="external">下载</a>最新的版本后，解压压缩包，然后就可以启动了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/elasticsearch</div></pre></td></tr></table></figure></p>
<h3 id="作为守护进程启动"><a href="#作为守护进程启动" class="headerlink" title="作为守护进程启动"></a>作为守护进程启动</h3><p>在*nix系统中，还可以作为守护进程启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/elasticsearch -d</div></pre></td></tr></table></figure></p>
<h3 id="指定PID"><a href="#指定PID" class="headerlink" title="指定PID"></a>指定PID</h3><p>为了维护方便，还可以指定es的pid:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ bin/elasticsearch -d -p pid </div><div class="line">$ kill `cat pid`</div></pre></td></tr></table></figure></p>
<ul>
<li>PID应该被写在名为pid的文件中。</li>
<li>kill命令会发送一个term信号给pid文件中的PID。</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>通过脚本，es可以向JVM传递JAVA_OPT参数。其中，最重要的参数是-Xms和-Xmx，它们用来控制进程的内存大小。<br>大多数情况下，最好用ES_JAVA_OPTS环境变量来替代JAVA_OPTS，这样可以不影响其它jvm项目的运行。<br>ES_HEAP_SIZE环境变量用来设置分配给esjava进程的堆内存大小。它会吧最大值和最小值设为同一个值。当然，也可以自己指定最大值和最小值，使用ES_MIN_MEM(默认是256m) 和 ES_MAX_MEM(默认是1G)。<br>值得推荐的做法是将最大值和最小值设为相同的值，并且开启mlockall（之后会有介绍）。</p>
<h3 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a>系统设置</h3><h4 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h4><p>确保要增加服务器中打开文件描述符的数量。设置为32K或者64是比较推荐的做法。<br>可以使用Nodes API查看文件描述符的大小：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl localhost:9200/_nodes/stats/process?pretty</div></pre></td></tr></table></figure></p>
<h4 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h4><p>es默认使用 hybrid mmapfs / niofs 目录来存储index。默认情况下，os的限制的mmap数量可能过小，有可能会引起内存溢出。在Linux中，可以通过指令增加这个限制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl -w vm.max_map_count=262144</div></pre></td></tr></table></figure></p>
<p>或者为了让这个设置永久生效，可以在/etc/sysctl.conf设置vm.max_map_count 这个参数。</p>
<h4 id="内存设置"><a href="#内存设置" class="headerlink" title="内存设置"></a>内存设置</h4><p>大多数os会使用尽可能大的内存来做文件缓存，并将不用的应用程序内存换出，这就有可能将es的进程换出去了。换出这个动作对于es是非常影响效率的，并引起节点的不稳定，因此，应该尽量避免换出。<br>有以下三个解决方案：</p>
<ul>
<li><p>禁止换出<br>最简单的方案就是完全禁止换出操作。<br>在Linux系统中，如果暂时禁止换出，可以使用 sudo swapoff -a 命令。如果想永久生效，可以在 /etc/fstab 文件中将带有 swap的行通通注释掉。<br>在Windows中，可以通过 System Properties → Advanced → Performance → Advanced → Virtual memory 禁止分页文件来实现。</p>
</li>
<li><p>设置 swappiness<br>第二个方案是将sysctl 中 vm.swappiness设为0。这个操作会降低内核换出操作的频率。除非系统处于不得不换出的状态，一般情况下都不会执行换出操作。<br>注意，在内核版本 3.5-rc1及以上，swappiness为0会导致OOM杀掉进程而不是换出。你需要将swappiness设为1来允许在紧急情况下的换出。</p>
</li>
<li><p>mlockall<br>第三个方案是，在Linux中使用mlockall或者在Windows中使用VirtualLock，来锁住RAM中的进程地址空间，防止es内存被换出去，这个可以在 config/elasticsearch.yml 文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bootstrap.memory_lock: true</div></pre></td></tr></table></figure>
<p>在启动后，可以查看mlockall状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:9200/_nodes/process?pretty</div></pre></td></tr></table></figure>
<p>如果你看到mlockall是false，它意味着mlockall失败了。在Linuxl/Unix中，一般是因为es没有权限锁内存。这个在启动es前可以通过<code>ulimit -l unlimited as root</code> 来授权。<br>另一个可能的原因是临时目录（一般是/tmp）被安装了noexec 选项，这可以通过指定一个新的临时文件目录来解决:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/elasticsearch -Djna.tmpdir=/path/to/new/dir</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Elasticsearch设置"><a href="#Elasticsearch设置" class="headerlink" title="Elasticsearch设置"></a>Elasticsearch设置</h3><p>es配置文件可以在 ES_HOME/config 文件夹中找到。它包括两个文件，elasticsearch.yml 用于es的不同模块的设置，logging.yml 用于配置es的日志。</p>
<h4 id="路径"><a href="#路径" class="headerlink" title="路径"></a>路径</h4><p>在生产环境中，一般会设置两个路径来存储数据和日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">path:</div><div class="line">  logs: /var/log/elasticsearch</div><div class="line">  data: /var/data/elasticsearch</div></pre></td></tr></table></figure></p>
<h4 id="集群名称"><a href="#集群名称" class="headerlink" title="集群名称"></a>集群名称</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cluster:</div><div class="line">  name: &lt;NAME OF YOUR CLUSTER&gt;</div></pre></td></tr></table></figure>
<p>要保证你不会在不同的环境使用相同的集群名称，否则节点有可能加入到错误的集群中。你可以在生产环境用 logging-prod ，开发环境 logging-dev，分支环境使用 loggin-stage。</p>
<h4 id="节点名称"><a href="#节点名称" class="headerlink" title="节点名称"></a>节点名称</h4><p>你可以为每个节点修改他们的节点名称以便于管理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node:</div><div class="line">  name: &lt;NAME OF YOUR NODE&gt;</div></pre></td></tr></table></figure></p>
<p>hostname一般存在于服务器的HOSTNAME环境变量中，如果你的机器对于集群运行一个单独的es节点，你可以设置节点名称为hostname<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node:</div><div class="line">  name: $&#123;HOSTNAME&#125;</div></pre></td></tr></table></figure></p>
<h4 id="设置配置文件格式"><a href="#设置配置文件格式" class="headerlink" title="设置配置文件格式"></a>设置配置文件格式</h4><p>在es中，所有的设置都被包围在 anmespaced中。例如，上面这些设置都在node.name中。这意味着可以支持其他格式的配置文件，比如JSON。如果使用JSON，可以将elasticsearch.yml修改为elasticsearch.json。相应的，里面的设置格式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;network&quot; : &#123;</div><div class="line">        &quot;host&quot; : &quot;10.0.0.4&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Index设置"><a href="#Index设置" class="headerlink" title="Index设置"></a>Index设置</h3><p>集群中的index可以维护自己的设置。例如，可以将创建index的刷新间隔时间设置为5s。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -XPUT http://localhost:9200/kimchy/ -d \</div><div class="line">&apos;</div><div class="line">index:</div><div class="line">    refresh_interval: 5s</div><div class="line">&apos;</div></pre></td></tr></table></figure></p>
<p>Index级别的设置也可以在node级别中设置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">index :</div><div class="line">    refresh_interval: 5s</div></pre></td></tr></table></figure></p>
<p>如果index和node都设置了，那么指定的index会覆盖node的设置。</p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>es内部使用了log4j。配置文件是config/logging.yml。也支持JSON和properties文件。</p>
<h4 id="过期行为的日志"><a href="#过期行为的日志" class="headerlink" title="过期行为的日志"></a>过期行为的日志</h4><p>除了常规的日志，es还能记录过期行为的日志。这对于迁移是一个很大的优势。默认它是关闭的，在 config/logging.yml 开启：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">deprecation: DEBUG, deprecation_log_file</div></pre></td></tr></table></figure></p>
<p>它会在日志目录下创建一个每天滚动的日志文件。定期检查这个文件，针对于当你想要升级到一个新的大版本。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/21/Elasticsearch学习笔记：一、入门/" itemprop="url">
                  Elasticsearch学习笔记：一、入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-21T11:59:46+08:00" content="2016-09-21">
              2016-09-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Elasticsearch是一个分布式的开源的全文分析搜索引擎，它基于Lucene，提供一个接近实时的搜索。</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Near-Realtine-NRT"><a href="#Near-Realtine-NRT" class="headerlink" title="Near Realtine(NRT)"></a>Near Realtine(NRT)</h3><p>Es是一个接近实时的搜索平台。这意味着，当你index一个文档到能搜索到它，需要花费一些很少的时间（通常是一秒）。</p>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p>cluster是一个由一个或多个服务节点组成的集合，它包含了你所有的数据并提供了对所有节点的索引和搜索。一个cluster会被一个名称唯一标识，默认名称是“elasticsearch”。这个名字非常重要，因为节点会通过集群的名字来确定加入的集群。</p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>一个节点是你cluster中一个独立的服务，存储数据，组成cluster的index，提供搜索的能力。在一个cluster中，它的节点会被节点名称唯一标识，默认是一个随机的Marvel人物的名称。节点名称对于管理节点是非常重要的。<br>一个节点可以cluster名称来决定参加哪个cluster。默认情况下，在你网络中又多个节点，并且它们可以互相连通，那么它们会自动组成并加入一个名字为”elasticsearch”的cluster。<br>在一个cluster中，如果只有一个节点，那么它会自动形成一个名叫“elasticsearch”的单节点cluster。</p>
<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><p>index是有相同特征的文档的集合。例如，你可以有一个用户数据的index，或者产品目录的index。一个index被一个名称表示，名称必须是小写字母，这个名称可以用来对文档执行索引、创建，搜索，更新和删除等操作。</p>
<h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>在index中，你可以定义一个或多个type。type是一个逻辑类别还是index的一部分，这些都取决于你的定义。一般来说，一个type是具有相同field的文档。例如，我们假设你运行一个blog平台，并且存储所有的数据在一个单独的index中。在这个index中，你可能会定义一个type为user数据，另一个type为blog数据，还有其它type为评论数据等等。</p>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>document是被索引的基本数据单位。例如，你可能有一个文档是针对单个用户，另一个文档是某个商品等。document用JSON来存储。<br>在index/type类型中，你可以存储很多document。</p>
<h3 id="Shards-amp-Replicas"><a href="#Shards-amp-Replicas" class="headerlink" title="Shards &amp; Replicas"></a>Shards &amp; Replicas</h3><p>一个index能够存储非常大量的数据，有时可能会超过单个节点硬件的限制。例如。一个index存储一超过1TB的数据，这对于单个节点有可能是负担不起的。为了解决这个问题，es可以讲index分片到不同的shards中。当你创建一个index，你可以定义你想要的shards数量。每一个shard对于自己来说都是一个拥有所有功能并且有独立的index，可以被放到任何node上。<br>分片有两个重要的优势：</p>
<ul>
<li>它允许你水平 分割/扩展 你的内容。</li>
<li>它允许你并行处理不同分片上的数据来提高效率。 为了保证高可用性，可以为每个分片节点设置备份节点。</li>
</ul>
<p>对于如何进行分片以及进行聚合操作时文档是怎样merge的，es都自动管理了，并且对用户是透明的。</p>
<p>在网络环境中，当某个服务失效了，failover机制是非常有效的高可用保障。es也提供了对于index分片的复制。<br>复制机制有两个重要特点：</p>
<ul>
<li>它提供了高可用性以防一个shard/node失效。值得注意的是，一个shard复制不要和它本身放在同一个节点。</li>
<li>它通过对所有复制shard的并行搜索来提高你系统的吞吐量。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>es运行环境需要jdk1.7及以上，下载jdk直接去oracle官网下。然后<a href="http://www.elastic.co/downloads" target="_blank" rel="external">下载es </a>。<br>解压后，启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ elasticsearch-2.4.0/bin/elasticsearch</div></pre></td></tr></table></figure></p>
<p>之前提到过，我们可以覆盖cluster和node名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./elasticsearch --cluster.name my_cluster_name --node.name my_node_name</div></pre></td></tr></table></figure></p>
<h2 id="探索集群和Index"><a href="#探索集群和Index" class="headerlink" title="探索集群和Index"></a>探索集群和Index</h2><p>现在我们已经让节点和集群运行起来了，下一步怎么和es进行沟通交流呢？幸运的是，es提供了一个非常好用的restAPI。通过api我们可以做这些事情：</p>
<ul>
<li>检查集群，节点和index的健康状况，状态和统计数据。</li>
<li>管理集群、节点和index的数据和元数据。</li>
<li>执行CRUD和一些针对index的搜索操作。</li>
<li>执行高级的搜索操作，例如分页，排序，过滤，脚本，聚合以及其他。</li>
</ul>
<h3 id="集群的健康监测"><a href="#集群的健康监测" class="headerlink" title="集群的健康监测"></a>集群的健康监测</h3><p>接下来，我们对集群进行一个基本的简单的健康监测。前文提到了，因为es通过restAPI来进行操作，所以可以使用curl或者postman等。<br>检测cluster的健康状况，我们可以使用_cat API。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_cat/health?v&apos;</div></pre></td></tr></table></figure></p>
<p>返回的结果是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign</div><div class="line">1394735289 14:28:09  elasticsearch green           1         1      0   0    0    0        0</div></pre></td></tr></table></figure></p>
<p>其中status显示了当前的健康状况。<br>status的定义如下： </p>
<ul>
<li>green ： everything is ok。 </li>
<li>yellow： 所有数据可用，但是一些备份节点的数据尚未被分配。 </li>
<li>red ： 一些数据不可用。</li>
</ul>
<p>还可以查看节点的状况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_cat/nodes?v&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">host         ip        heap.percent ram.percent load node.role master name</div><div class="line">mwubuntu1    127.0.1.1            8           4 0.00 d         *      New Goblin</div></pre></td></tr></table></figure></p>
<h3 id="查询所有的index"><a href="#查询所有的index" class="headerlink" title="查询所有的index"></a>查询所有的index</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_cat/indices?v&apos;</div></pre></td></tr></table></figure>
<p>返回为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">health status index   pri rep docs.count docs.deleted store.size pri.store.size </div><div class="line">yellow open   secilog   5   1          1            0      4.2kb          4.2kb </div><div class="line">green  open   twitter   1   0          2            0      7.2kb          7.2kb</div></pre></td></tr></table></figure></p>
<p>上面显示了，我有两个index，一个secilog，还有一个twitter，当然，这些都是我后来自己建的，新安装的es是没有的，它会返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">health index pri rep docs.count docs.deleted store.size pri.store.size</div></pre></td></tr></table></figure></p>
<h3 id="创建一个Index"><a href="#创建一个Index" class="headerlink" title="创建一个Index"></a>创建一个Index</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;localhost:9200/customer?pretty&apos;</div></pre></td></tr></table></figure>
<p>返回：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"acknowledged"</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/_cat/indices?v&apos;</div><div class="line">health index    pri rep docs.count docs.deleted store.size pri.store.size</div><div class="line">yellow customer   5   1          0            0       495b           495b</div></pre></td></tr></table></figure></p>
<p>这里status是yellow，是因为默认情况下，es默认会为每一个shards创建一个replica，但是由于目前我们只是一个单节点的，所以replica没有地方进行分配，所以就是yellow了。</p>
<h3 id="索引并查询一个文档"><a href="#索引并查询一个文档" class="headerlink" title="索引并查询一个文档"></a>索引并查询一个文档</h3><p>下面我们放一些数据到刚才定义的index中。还记得之前提到过的type么，我们必须为文档指定type。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;localhost:9200/customer/external/1?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;John Doe&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;customer&quot;,</div><div class="line">  &quot;_type&quot;: &quot;external&quot;,</div><div class="line">  &quot;_id&quot;: &quot;1&quot;,</div><div class="line">  &quot;_version&quot;: 1,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;created&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面显示创建成功了。不过，值得注意的是，如果上面的customer之前不存在，那么es会自动创建一个名为customer的index。</p>
<p>然后我们就可以搜索到了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XGET &apos;localhost:9200/customer/external/1?pretty&apos;</div></pre></td></tr></table></figure></p>
<p>返回结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot; : &quot;customer&quot;,</div><div class="line">  &quot;_type&quot; : &quot;external&quot;,</div><div class="line">  &quot;_id&quot; : &quot;1&quot;,</div><div class="line">  &quot;_version&quot; : 1,</div><div class="line">  &quot;found&quot; : true,</div><div class="line">  &quot;_source&quot; : &#123;</div><div class="line">    &quot;name&quot; : &quot;John Doe&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="删除一个Index"><a href="#删除一个Index" class="headerlink" title="删除一个Index"></a>删除一个Index</h3><p>现在我们可以删除刚刚创建的index：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XDELETE &apos;localhost:9200/customer?pretty&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;acknowledged&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据上面的操作，不难看出，es针对index的操作一般遵循这个格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -X&lt;REST Verb&gt; &lt;Node&gt;:&lt;Port&gt;/&lt;Index&gt;/&lt;Type&gt;/&lt;ID&gt;</div></pre></td></tr></table></figure></p>
<h2 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h2><p>es提供对于数据的修改以及接近实时的搜索功能。在你index/update/delete数据后，到你可以搜索到这些改变，一般需要1秒钟的延迟。这对于其他平台比如SQL来说，是一个非常大的区别。</p>
<h3 id="创建-替换索引文档"><a href="#创建-替换索引文档" class="headerlink" title="创建/替换索引文档"></a>创建/替换索引文档</h3><p>之前我们已经看到了如何对一个文档进行索引，让我们回顾一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;localhost:9200/customer/external/1?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;John Doe&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>接着，上面的操作会为customer创建一个文档，type是external，id是1.如果我们执行同样的操作但是使用不同的数据，es会覆盖之前已经存在的数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPUT &apos;localhost:9200/customer/external/1?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;Jane Doe&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>如果我们不指定ID，es会为自动生成一个id并用它来索引文档。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/external?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;Jane Doe&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot;: &quot;customer&quot;,</div><div class="line">  &quot;_type&quot;: &quot;external&quot;,</div><div class="line">  &quot;_id&quot;: &quot;AVdLq7nyMju-ZsxkZnGp&quot;,</div><div class="line">  &quot;_version&quot;: 1,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;successful&quot;: 1,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;created&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<font color="red"><strong>值得注意的是，在不指定ID时，我们应该使用的是POST请求。</strong></font>

<h3 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h3><p>为了创建/替换索引文档，我们还可以更新文档的内容。但是，es并不进行就地的更新。当我们执行一个update，es会删除旧的文档然后在桶中索引一个新的文档。</p>
<p>接下来更新之前的id=1的文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/external/1/_update?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;doc&quot;: &#123; &quot;name&quot;: &quot;Jane Doe&quot;, &quot;age&quot;: 20 &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>也可以使用script来进行更新：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/external/1/_update?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;script&quot; : &quot;ctx._source.age += 5&quot;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>有时可能会返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;error&quot;: &#123;</div><div class="line">    &quot;root_cause&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;type&quot;: &quot;remote_transport_exception&quot;,</div><div class="line">        &quot;reason&quot;: &quot;[Witchfire][127.0.0.1:9300][indices:data/write/update[s]]&quot;</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;type&quot;: &quot;illegal_argument_exception&quot;,</div><div class="line">    &quot;reason&quot;: &quot;failed to execute script&quot;,</div><div class="line">    &quot;caused_by&quot;: &#123;</div><div class="line">      &quot;type&quot;: &quot;script_exception&quot;,</div><div class="line">      &quot;reason&quot;: &quot;scripts of type [inline], operation [update] and lang [groovy] are disabled&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;status&quot;: 400</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这是由于es基于安全考虑，将脚本功能禁用了，可以在config/elasticsearch.yml文件添加以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">script.inline: on</div><div class="line">script.indexed: on</div><div class="line">script.file: on</div></pre></td></tr></table></figure></p>
<p>配置后，重启Elasticsearch。</p>
<p>再执行上面的操作，就可以了。</p>
<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XDELETE &apos;localhost:9200/customer/external/2?pretty&apos;</div></pre></td></tr></table></figure>
<h3 id="批量处理"><a href="#批量处理" class="headerlink" title="批量处理"></a>批量处理</h3><p>es对于index/uodate/delete等操作也可以进行批量处理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/external/_bulk?pretty&apos; -d &apos;</div><div class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</div><div class="line">&#123;&quot;name&quot;: &quot;John Doe&quot; &#125;</div><div class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</div><div class="line">&#123;&quot;name&quot;: &quot;Jane Doe&quot; &#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure></p>
<p>也可以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/external/_bulk?pretty&apos; -d &apos;</div><div class="line">&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</div><div class="line">&#123;&quot;doc&quot;: &#123; &quot;name&quot;: &quot;John Doe becomes Jane Doe&quot; &#125; &#125;</div><div class="line">&#123;&quot;delete&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</div><div class="line">&apos;</div></pre></td></tr></table></figure></p>
<p>bulkAPI 会按顺序执行请求。如果某个请求失败了，不管是什么原因，它都会继续执行接下来的请求。当返回结果时，它会告诉你哪些成功哪些失败。</p>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><h3 id="Search-API"><a href="#Search-API" class="headerlink" title="Search API"></a>Search API</h3><p>下面我们来进行一些简单的查询操作。es提供了两种基本的查询方式：</p>
<ul>
<li>REST request URI</li>
<li>REST request body</li>
</ul>
<p>顾名思义，request body就是在请求体中添加参数，而URI则是在 URI中写明参数。<br>下面，用URI方式进行查询请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl &apos;localhost:9200/customer/_search?q=*&amp;pretty&apos;</div></pre></td></tr></table></figure></p>
<p>来分析一下查询请求，我们使用了_search 在customer index中，q=*说明了es要查询index中所有的文档。preety参数说明返回结果打印的时候打印一个规范的json格式。</p>
<p>返回结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 109,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 3,</div><div class="line">    &quot;max_score&quot;: 1,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;customer&quot;,</div><div class="line">        &quot;_type&quot;: &quot;external&quot;,</div><div class="line">        &quot;_id&quot;: &quot;2&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;Jane Doe&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;customer&quot;,</div><div class="line">        &quot;_type&quot;: &quot;external&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AVdLq7nyMju-ZsxkZnGp&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;Jane Doe&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;customer&quot;,</div><div class="line">        &quot;_type&quot;: &quot;external&quot;,</div><div class="line">        &quot;_id&quot;: &quot;1&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;name&quot;: &quot;John Doe becomes Jane Doe&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>针对返回结果，我们可以看到这些部分：</p>
<ul>
<li>took - es用于执行查询所用的时间，单位为毫秒。</li>
<li>time_out - 告诉我们查询是否超时了。</li>
<li>_shards - 告诉我们以供查询了多少shards，以及它们成功与否。</li>
<li>hits - 查询的命中结果。</li>
<li>hits.total - 符合我们查询规则的文档总数。</li>
<li>hits.hits - 查询结果数组，默认为前10个文档。</li>
<li>_score和max_score - 先忽略它们。</li>
</ul>
<p>使用request body查询方式来达到相同的效果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/bank/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>非常重要的一点，一旦你的搜索结果返回了，那么，es不会保留任何的服务端资源或者在你结果集上的游标。这和其他的平台形成了鲜明的对比，比如SQL，你可能在一开始只是获取到你查询结果的子集，之后还需要向服务器使用某些服务端有状态的游标来抓取剩下的结果集。</p>
<h3 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h3><p>首先，我们来看一下返回的文档字段。默认情况下，会返回文档的所有字段，我们可以指定返回的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</div><div class="line">  &quot;_source&quot;: [&quot;name&quot;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>接下来，我们看一下query部分，之前，我们都是使用的match_all，会返回所有的文档。下面我们加一些限制条件，查询name包含Jane 或者 Doe的文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d&apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123;&quot;name&quot; : &quot;Jane Doe&quot;&#125; &#125;,</div><div class="line">  &quot;_source&quot;: [&quot;name&quot;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>查询name同时包含“Jane Doe”短语的文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d&apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123; &quot;match_phrase&quot;: &#123;&quot;name&quot; : &quot;Jane Doe&quot;&#125; &#125;,</div><div class="line">  &quot;_source&quot;: [&quot;name&quot;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>下面是布尔类型的query，表示and：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Jane&quot; &#125; &#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Doe&quot; &#125; &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>表示OR：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;should&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Jane&quot; &#125; &#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Doe&quot; &#125; &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>表示都为false:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must_not&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Jane&quot; &#125; &#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Doe&quot; &#125; &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>也可以自由组合：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Jane&quot; &#125; &#125;</div><div class="line">      ],</div><div class="line">	  &quot;must_not&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; &quot;name&quot;: &quot;Doe&quot; &#125; &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<h3 id="使用过滤器"><a href="#使用过滤器" class="headerlink" title="使用过滤器"></a>使用过滤器</h3><p>之前提到的score是一个数字，它用来评价当前返回的文档和我们需要的文档的匹配程度。分数越高的匹配程度越好。<br>但是查询并不是总需要产生score，尤其是它们只是用来过滤文档的时候。es能够自动的优化查询并不计算这些无用的score。<br>上文中的bool query也支持filter语句。filter语句可以在不改变score的情况下使用查询语句来限定文档。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;range&quot;: &#123;</div><div class="line">          &quot;age&quot;: &#123;</div><div class="line">            &quot;gte&quot;: 20000,</div><div class="line">            &quot;lte&quot;: 30000</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>由此可知，有的时候我们不需要关注score，那么久可以用filter来进行查询过滤，因为filter不会去计算score，那么它的效率相应会更高一些。</p>
<h3 id="执行聚合"><a href="#执行聚合" class="headerlink" title="执行聚合"></a>执行聚合</h3><p>聚合可以对数据进行分组并对分组进行数据统计。类似于SQL中的group by。在es中，可以一次性返回查询结果和局和结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/customer/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;group_by_name&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;name&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>返回结果为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 159,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 3,</div><div class="line">    &quot;max_score&quot;: 0,</div><div class="line">    &quot;hits&quot;: []</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;group_by_state&quot;: &#123;</div><div class="line">      &quot;doc_count_error_upper_bound&quot;: 0,</div><div class="line">      &quot;sum_other_doc_count&quot;: 0,</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;doe&quot;,</div><div class="line">          &quot;doc_count&quot;: 3</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;jane&quot;,</div><div class="line">          &quot;doc_count&quot;: 3</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;becomes&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key&quot;: &quot;john&quot;,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>比如按官网上的例子，统计不同银行账户下的平均余额：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/bank/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;group_by_state&quot;: &#123;</div><div class="line">      &quot;terms&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;state&quot;,</div><div class="line">        &quot;order&quot;: &#123;</div><div class="line">          &quot;average_balance&quot;: &quot;desc&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;average_balance&quot;: &#123;</div><div class="line">          &quot;avg&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;balance&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>或者对聚合进行嵌套，先按年龄范围分组，再统计不同性别的账户平均余额：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/bank/_search?pretty&apos; -d &apos;</div><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 0,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;group_by_age&quot;: &#123;</div><div class="line">      &quot;range&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;age&quot;,</div><div class="line">        &quot;ranges&quot;: [</div><div class="line">          &#123;</div><div class="line">            &quot;from&quot;: 20,</div><div class="line">            &quot;to&quot;: 30</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;from&quot;: 30,</div><div class="line">            &quot;to&quot;: 40</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            &quot;from&quot;: 40,</div><div class="line">            &quot;to&quot;: 50</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      &quot;aggs&quot;: &#123;</div><div class="line">        &quot;group_by_gender&quot;: &#123;</div><div class="line">          &quot;terms&quot;: &#123;</div><div class="line">            &quot;field&quot;: &quot;gender&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;aggs&quot;: &#123;</div><div class="line">            &quot;average_balance&quot;: &#123;</div><div class="line">              &quot;avg&quot;: &#123;</div><div class="line">                &quot;field&quot;: &quot;balance&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/21/Nginx学习笔记：六、访问限制/" itemprop="url">
                  Nginx学习笔记：六、访问限制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-21T13:57:22+08:00" content="2016-07-21">
              2016-07-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="限制访问HTTP代理资源"><a href="#限制访问HTTP代理资源" class="headerlink" title="限制访问HTTP代理资源"></a>限制访问HTTP代理资源</h2><h3 id="控制访问"><a href="#控制访问" class="headerlink" title="控制访问"></a>控制访问</h3><p>可以通过客户端IP地址或使用基于HTTP的身份认证。<br>使用IP地址控制访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    deny  192.168.1.2;</div><div class="line">    allow 192.168.1.1/24;</div><div class="line">    allow 127.0.0.1;</div><div class="line">    deny  all;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>开启身份验证，可以使用 auth_basic指令。然后用户必须加入他们的有效用户名和密码来获取网站访问权。用户名和密码必须在auth_basic_user_file指定的文件中列举出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    auth_basic &quot;closed website&quot;;</div><div class="line">    auth_basic_user_file conf/htpasswd;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以设置某些URL不需要身份认证。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    auth_basic &quot;closed website&quot;;</div><div class="line">    auth_basic_user_file conf/htpasswd;</div><div class="line"></div><div class="line">    location /public/ &#123;</div><div class="line">        auth_basic off;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以使用satisfy指令来控制访问，如果需要某一个条件，则使用any ， 如果都需要满足，则使用all。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    satisfy any;</div><div class="line"></div><div class="line">    allow 192.168.1.0/24;</div><div class="line">    deny  all;</div><div class="line"></div><div class="line">    auth_basic           &quot;closed site&quot;;</div><div class="line">    auth_basic_user_file conf/htpasswd;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="限制访问"><a href="#限制访问" class="headerlink" title="限制访问"></a>限制访问</h3><ul>
<li>限制访问的连接数<br>首先，使用 limit_conn_zone 指令定义key和共享的内存<br><code>limit_conn_zone $binary_remote_address zone=addr:10m;</code><br>第二步，使用limit_conn 指令指定使用的http 、 server 或者location。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /download/ &#123;</div><div class="line">    limit_conn addr 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这里可以基于IP限制连接数，因为使用了$binary_remote_address 变量当做key。连接数也可以通过 server 名称来限制，通过使用$server_name变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    limit_conn_zone $server_name zone=servers:10m;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        limit_conn servers 1000;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>限制访问率<br>限制访问率，首先使用 limit_req_zone 指令设置key和共享内存区域来供计数器使用。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>rate参数可以设置为每秒请求(r/s)或者每分钟请求 (r/m)。比如30r/m。<br>当设置了共享内存，使用limit_req指令在server 或 location中来限制速率。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /search/ &#123;</div><div class="line">    limit_req zone=one burst=5;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里，nginx不会再每秒处理多于一个请求在指定的location中。如果速率超过了请求限制，那么会将请求放入队列中延迟处理。burst参数设置了每秒处理请求的最大值，当超过了这个最大值，会返回503.<br>如果不想在设置了burst后有延迟处理，添加nodelay参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">limit_req zone=one burst=5 nodelay;</div></pre></td></tr></table></figure></p>
<ul>
<li>限制带宽<br>限制每个链接的带宽，可以使用limit_rate指令。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /download/ &#123;</div><div class="line">    limit_rate 50k;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>通过这个设置，客户端最多能够下载50k内容通过一个单独的链接。然而，客户端能够开几个链接。所以如果想要更好的控制链接带宽，可以配合限制连接数使用。例如，一个IP一个连接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /download/ &#123;</div><div class="line">    limit_conn addr 1;</div><div class="line">    limit_rate 50k;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以允许客户端在下载一定量的数据后再进行限速：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">limit_rate_after 500k;</div><div class="line">limit_rate 20k;</div></pre></td></tr></table></figure></p>
<p>下面是一个完整的例子，限制了连接数和带宽<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    limit_conn_zone $binary_remote_address zone=addr:10m</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        root /www/data;</div><div class="line">        limit_conn addr 5;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /download/ &#123;</div><div class="line">            limit_conn addr 1;</div><div class="line">            limit_rate 1m;</div><div class="line">            limit_rate 50k;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="限制访问TCP代理资源"><a href="#限制访问TCP代理资源" class="headerlink" title="限制访问TCP代理资源"></a>限制访问TCP代理资源</h2><h3 id="通过IP地址限制访问"><a href="#通过IP地址限制访问" class="headerlink" title="通过IP地址限制访问"></a>通过IP地址限制访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    server &#123;</div><div class="line">        listen 12345;</div><div class="line">        deny   192.168.1.2;</div><div class="line">        allow  192.168.1.1/24;</div><div class="line">        allow  2001:0db8::/32;</div><div class="line">        deny   all;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="限制TCP连接数"><a href="#限制TCP连接数" class="headerlink" title="限制TCP连接数"></a>限制TCP连接数</h3><p>可以有效的防止DOS攻击。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>大致和HTTP的配置方式差不多。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        ...</div><div class="line">        limit_conn ip_addr 1;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="限制带宽"><a href="#限制带宽" class="headerlink" title="限制带宽"></a>限制带宽</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    proxy_download_rate 100k;</div><div class="line">    proxy_upload_rate   50k;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是一个完整的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        ...</div><div class="line">        limit_conn ip_addr 1;</div><div class="line">        proxy_download_rate 100k;</div><div class="line">        proxy_upload_rate   50k;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/Nginx学习笔记：五、负载均衡/" itemprop="url">
                  Nginx学习笔记：五、负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-18T11:31:02+08:00" content="2016-07-18">
              2016-07-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HTTP-负载均衡"><a href="#HTTP-负载均衡" class="headerlink" title="HTTP 负载均衡"></a>HTTP 负载均衡</h2><h3 id="负载一组服务器"><a href="#负载一组服务器" class="headerlink" title="负载一组服务器"></a>负载一组服务器</h3><p>在nginx中使用一组服务器之前，需要先定义一组服务器，在http块中使用upstream指令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    upstream backend &#123;</div><div class="line">        server backend1.example.com weight=5;</div><div class="line">        server backend2.example.com;</div><div class="line">        server 192.0.0.1 backup;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>想要将请求发送到一组后端服务器，还需要指定这组服务器的名称，使用 proxy_pass ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://backend;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="选择一个负载均衡的方法"><a href="#选择一个负载均衡的方法" class="headerlink" title="选择一个负载均衡的方法"></a>选择一个负载均衡的方法</h3><ol>
<li><p>轮询<br>根据服务器的权重将请求均匀的分布到所有服务器上。这个是默认的策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">   server backend1.example.com;</div><div class="line">   server backend2.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>连接数最小<br>将请求发送到目前连接数最小的服务器上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    least_conn;</div><div class="line"></div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ip_hash<br>由客户端IP决定发送到哪个服务器上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    ip_hash;</div><div class="line"></div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果哪个服务器需要暂时停止服务，可以使用down指令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">    server backend3.example.com down;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li><p>一致性hash<br>通过用户定义的key来决定请求分发到哪台服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    hash $request_uri consistent;</div><div class="line"></div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>最低延迟和最小连接数<br>选取最低延迟和最小连接数的服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    least_time header;</div><div class="line"></div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>header : 从服务器接收到第一个字节所用的时间。<br>last_byte ： 从服务器接收全部响应所用的时间。</p>
<h3 id="服务器权重"><a href="#服务器权重" class="headerlink" title="服务器权重"></a>服务器权重</h3><p>默认情况下，nginx根据服务器的权重来进行轮训的分发。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com weight=5;</div><div class="line">    server backend2.example.com;</div><div class="line">    server 192.0.0.1 backup;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第三个服务器设为 backup，只有当前两个服务器不可用时，它才能接收请求。</p>
<h3 id="服务器慢启动"><a href="#服务器慢启动" class="headerlink" title="服务器慢启动"></a>服务器慢启动</h3><p>服务器的慢启动能够保护从刚刚连接超时或者其他的原因不可用的状态恢复的服务器被连接淹没。<br>nginx慢启动可以逐步恢复服务器，一开始将服务器的权重设为0，然后逐步成为设置的权重。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com slow_start=30s;</div><div class="line">    server backend2.example.com;</div><div class="line">    server 192.0.0.1 backup;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="session持久化"><a href="#session持久化" class="headerlink" title="session持久化"></a>session持久化</h3><p>session持久化意味着Nginx标识用户session并将请求发送到与之前相同的服务器上。<br>session支持三种session持久化方法：</p>
<ol>
<li>sticky cookie<br>使用这个方法，nginx会为第一个响应的upstream组添加一个session的cookie，并标识响应请求的服务器。当下次请求时，它会携带一个cookie的值，然后nginx将请求路由到相同的服务器上：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line"></div><div class="line">    sticky cookie srv_id expires=1h domain=.example.com path=/;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>例子中，srv_id参数设置了cookie的名称。可选的expire参数设置了浏览器保持cookie的时间。可选的参数domian定义了一个设置cookie的domain。可选参数path定义了cookie设置的访问路径。这是最简单的session持久化方法。</p>
<ol>
<li><p>sticky route<br>nginx为第一次接受请求的客户端设置了一个route。所有后续请求将与server指令中识别服务器的route参数进行比较。<br>路由信息取自cookie或者URI。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com route=a;</div><div class="line">    server backend2.example.com route=b;</div><div class="line"></div><div class="line">    sticky route $route_cookie $route_uri;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>cookie learn<br>首先，nginx通过检查请求和响应来发现session标识。然后，nginx“学习”哪个upstream 服务器组和哪个session标识相关联。举荐的，这些标识被传进HTTPcookie。如果请求包含的session已经被“学习”，nginx将会直接将请求发送到关联的服务器上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">   server backend1.example.com;</div><div class="line">   server backend2.example.com;</div><div class="line"></div><div class="line">   sticky learn </div><div class="line">       create=$upstream_cookie_examplecookie</div><div class="line">       lookup=$cookie_examplecookie</div><div class="line">       zone=client_sessions:1m</div><div class="line">       timeout=1h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>例子中，upstream的服务器在响应中通过设置cookie “EXAMPLECOOKIE”来创建了一个session。<br>必填的 create 参数指定了怎么创建一个新的session。在例子中，新的session是由upstream服务器发送的cookie “EXAMPLECOOKIE”创建的。<br>必填的参数 lookup 指定了怎么搜索已经存在的session。在例子中，从客户端发送的cookie “EXAMPLECOOKIE” 中查询已经存在的session。<br>必填的参数 zone 指定了一个保存所有session信息的共享内存。<br>这个策略不需要客户端保存任何cookie，所有信息保存在服务器端的共享内存中。</p>
<h3 id="限制连接数"><a href="#限制连接数" class="headerlink" title="限制连接数"></a>限制连接数</h3><p>如果MAX_CONNS已达到限制，该请求可以被放置到队列为提供该队列指令指定其进一步处理。该指令集，可以在队列中同时请求的最大数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com  max_conns=3;</div><div class="line">    server backend2.example.com;</div><div class="line"></div><div class="line">    queue 100 timeout=70;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果有其它worker进程打开了空闲时keepalive，max_conn限制将会被忽略。结果是，连接到服务器的总数将会超过max_conns。</p>
<h3 id="被动的健康监测"><a href="#被动的健康监测" class="headerlink" title="被动的健康监测"></a>被动的健康监测</h3><p>当nginx认为一个服务器不可用时，它会暂时停止发送请求到这台服务器知道服务器被认为可用。<br>max_fails和fail_timeout —— 这俩是关联的，如果某台服务器在fail_timeout时间内出现了max_fails次连接失败，那么nginx就会认为那个服务器已经挂掉，从而在 fail_timeout时间内不再去查询它，fail_timeout的默认值是10s，max_fails的默认值是1（这意味着一发生错误就认为服务器挂掉），如果把max_fails设为0则表示把这个检查取消。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;                </div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com max_fails=3 fail_timeout=30s;</div><div class="line">    server backend3.example.com max_fails=2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="主动的健康监测"><a href="#主动的健康监测" class="headerlink" title="主动的健康监测"></a>主动的健康监测</h3><p>预先发送一个指定的请求到每个服务器，并检测响应信息是否符合检测中的可用条件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    upstream backend &#123;</div><div class="line">        zone backend 64k;</div><div class="line"></div><div class="line">        server backend1.example.com;</div><div class="line">        server backend2.example.com;</div><div class="line">        server backend3.example.com;</div><div class="line">        server backend4.example.com;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://backend;</div><div class="line">            health_check;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>zone 指令定义了被worker进程共享的并用来存储服务器组配置的内存区域。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    proxy_pass http://backend;</div><div class="line">    health_check interval=10 fails=3 passes=2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>健康监测的时间间隔是10s，在失败3次后会认为是不可用的，以后需要两次通过监测才能认为是可用的。<br>也可以指定URI进行监测：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    proxy_pass http://backend;</div><div class="line">    health_check uri=/some/path;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还可以设置macth块来指定健康监测的响应结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    match server_ok &#123;</div><div class="line">        status 200-399;</div><div class="line">        body !~ &quot;maintenance mode&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        ...</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://backend;</div><div class="line">            health_check match=server_ok;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以定义返回头中的信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">match welcome &#123;</div><div class="line">    status 200;</div><div class="line">    header Content-Type = text/html;</div><div class="line">    body ~ &quot;Welcome to nginx!&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>用!可以定义非的条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">match not_redirect &#123;</div><div class="line">    status ! 301-303 307;</div><div class="line">    header ! Refresh;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="使用DNS配置HTTP负载均衡"><a href="#使用DNS配置HTTP负载均衡" class="headerlink" title="使用DNS配置HTTP负载均衡"></a>使用DNS配置HTTP负载均衡</h3><p>服务器组的配置可以在运行时使用DNS修改。<br>nginx可以监控IP地址对应的域名服务器的变化，并自动将变化应用于nginx，且不用重启。这可以通过在http块中使用resolver指令，和server指令后的 resolver参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    resolver 10.0.0.1 valid=300s ipv6=off;</div><div class="line">    resolver_timeout 10s;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://backend;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    upstream backend &#123;</div><div class="line">        zone backend 32k;</div><div class="line">        least_conn;</div><div class="line">        ...</div><div class="line">        server backend1.example.com resolve;</div><div class="line">        server backend2.example.com resolve;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个示例中,服务器的resolve参数指令将定期通过IP地址重新解析 backend1.example.com和backend2.example.com服务器。默认情况下,NGINX基于TTL重新解析DNS记录,但TTL值可以覆盖resolve指令的valid参数,在我们的示例中是5分钟。<br>如果一个域名对应多个IP地址，那么IP地址会被存到upstream配置中并被负载均衡。在例子中，服务器会使用least_conn来负载均衡。如果一个活多个IP地址被修改、添加或删除，那么这些服务器也会被重新负载。</p>
<h3 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h3><p>nginx的服务器组可以通过HTTP接口来动态配置。配置指令可以用来查看所有服务器或者服务器组，修改服务器参数或者添加删除服务器。</p>
<ul>
<li><p>设置动态配置</p>
<ol>
<li><p>将zone指令放入upstream块中。zone 指令配置了一个区域来共享内存，并设置zone 的名称和大小。服务器组的配置被存放到这个zone中，所有的worker进程都使用同样的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">  		upstream appservers &#123;</div><div class="line">      		zone appservers 64k;</div><div class="line">      		server appserv1.example.com      weight=5;</div><div class="line">      		server appserv2.example.com:8080 fail_timeout=5s;</div><div class="line">      		server reserve1.example.com:8080 backup;</div><div class="line">      		server reserve2.example.com:8080 backup;</div><div class="line">  		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>配置 upstream_conf指令到location块中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">  		location /upstream_conf &#123;</div><div class="line">      		upstream_conf;</div><div class="line">      		...</div><div class="line">  		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为其设置访问白名单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">   	location /upstream_conf &#123;</div><div class="line">   	    upstream_conf;</div><div class="line">   	    allow 127.0.0.1;</div><div class="line">   	    deny  all;</div><div class="line">   	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>一个完整的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">   	...</div><div class="line">   	# Configuration of the server group</div><div class="line">   	upstream appservers &#123;</div><div class="line">       	zone appservers 64k;</div><div class="line"></div><div class="line">       	server appserv1.example.com      weight=5;</div><div class="line">       	server appserv2.example.com:8080 fail_timeout=5s;</div><div class="line"></div><div class="line">       	server reserve1.example.com:8080 backup;</div><div class="line">       	server reserve2.example.com:8080 backup;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	server &#123;</div><div class="line">       	# Location that proxies requests to the group</div><div class="line">       	location / &#123;</div><div class="line">           	proxy_pass http://appservers;</div><div class="line">           	health_check;</div><div class="line">       	&#125;</div><div class="line"></div><div class="line">       	# Location for configuration requests</div><div class="line">        location /upstream_conf &#123;</div><div class="line">   	        upstream_conf;</div><div class="line">   	        allow 127.0.0.1;</div><div class="line">   	        deny  all;</div><div class="line">   	    &#125;</div><div class="line">   	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>动态配置持久化<br>上面的动态配置会随着nginx配置文件的reload而失效，为了让它继续能有效果，需要将upstream服务器从upstream块移动到一个指定的文件中，能够保持upstream服务器的状态。文件的路径要在 state指令中设置。在Linux中，比较推荐的路径是/var/lib/nginx/state/。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    upstream appservers &#123;</div><div class="line">        zone appservers 64k;</div><div class="line">        state /var/lib/nginx/state/appservers.conf;</div><div class="line"></div><div class="line">        # All these servers should be moved to the file using the upstream_conf API:</div><div class="line">        # server appserv1.example.com      weight=5;</div><div class="line">        # server appserv2.example.com:8080 fail_timeout=5s;</div><div class="line">        # server reserve1.example.com:8080 backup;</div><div class="line">        # server reserve2.example.com:8080 backup;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>需要注意的是，文件只能被 upstream_conf API来修改，应该避免直接修改文件。</p>
<ul>
<li>动态配置Upstream服务器<br>使用HTTP请求来将配置命令传递给nginx。请求需要有一个合适的URI来获取到location中的upstream_conf指令。请求需要包含upstream参数来确定修改的服务器组。<br>查看所有backup的服务器<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/upstream_conf?upstream=appservers&amp;backup=</div></pre></td></tr></table></figure>
</li>
</ul>
<p>添加一个新的服务器到组里：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/upstream_conf?add=&amp;upstream=appservers&amp;server=appserv3.example.com:8080&amp;weight=2&amp;max_fails=3</div></pre></td></tr></table></figure></p>
<p>删除一个服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/upstream_conf?remove=&amp;upstream=appservers&amp;id=2</div></pre></td></tr></table></figure></p>
<p>修改一个服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/upstream_conf?upstream=appservers&amp;id=2&amp;down=</div></pre></td></tr></table></figure></p>
<h2 id="TCP-UDP负载均衡"><a href="#TCP-UDP负载均衡" class="headerlink" title="TCP/UDP负载均衡"></a>TCP/UDP负载均衡</h2><h3 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h3><p>首先，需要额皮质一个反向代理来使nginx通过TCP连接或者UDP报文将客户端数据发送到upstream组或者一个代理服务器。</p>
<ol>
<li><p>在顶级目录创建一个stream块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在stream块中定义一个或多个server块</p>
</li>
<li><p>在server块中定义listen指令来监听ip和端口。对于UDP，还需要包含udp参数。TCP在stream块中是默认的，所以listen没有tcp参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    server &#123;</div><div class="line">        listen 12345;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    server &#123;</div><div class="line">        listen 53 udp;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>通过proxy_pass指令来定义将要跳转的代理服务器或者upstream组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    server &#123;</div><div class="line">        listen     12345;</div><div class="line"></div><div class="line">        #TCP traffic will be proxied to the &quot;stream_backend&quot; upstream group</div><div class="line">        proxy_pass stream_backend;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen     12346;</div><div class="line"></div><div class="line">        #TCP traffic will be proxied a proxied server</div><div class="line">        proxy_pass backend.example.com:12346;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen     53 udp;</div><div class="line"></div><div class="line">        #UDP traffic will be proxied to the &quot;dns_servers&quot; upstream group</div><div class="line">        proxy_pass dns_servers;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果你的代理服务器有多个网络接口，你可以配置nginx选一个源ip地址来连接到upstream服务器。这对于后端服务器仅接受指定IP地址访问是有用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    server &#123;</div><div class="line">        listen     127.0.0.1:12345;</div><div class="line">        proxy_pass backend.example.com:12345;</div><div class="line">        proxy_bind 127.0.0.1:12345;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>可以调整两个缓冲区的大小，这两个缓冲区用于nginx缓存客户端和upstream的连接中的数据。如果数据比较小，buffer会自动缩小来节省存储资源。如果有大量的数据,可以通过减少socket的读/写操作次数来增加buffer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    ...</div><div class="line">    server &#123;</div><div class="line">        listen            127.0.0.1:12345;</div><div class="line">        proxy_pass        backend.example.com:12345;</div><div class="line">        proxy_buffer_size 16k;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="配置TCP-UDP负载均衡"><a href="#配置TCP-UDP负载均衡" class="headerlink" title="配置TCP/UDP负载均衡"></a>配置TCP/UDP负载均衡</h3><p>创建一组服务器或upstream组。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    upstream stream_backend &#123;</div><div class="line">        ...    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    upstream dns_servers &#123;</div><div class="line">        ...    </div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>剩下和HTTP差不多，如有疑问：<a href="https://www.nginx.com/resources/admin-guide/tcp-load-balancing/" target="_blank" rel="external">https://www.nginx.com/resources/admin-guide/tcp-load-balancing/</a></p>
<h2 id="设置代理协议"><a href="#设置代理协议" class="headerlink" title="设置代理协议"></a>设置代理协议</h2><p>代理协议允许nginx接受客户端连接信息并通过HAproy等发送给代理服务器。</p>
<p>通过代理协议发送的信息包括客户端IP地址、代理服务器IP和它们的端口号。知道原始的IP地址有助于网站的语言设置、访问黑名单或一些简单的log和静态资源。</p>
<p>通过代理协议，nginx可以获取到原始的ip地址通过SSL, HTTP/2, SPDY, WebSocket, 和 TCP。</p>
<h3 id="使用SSL-HTTP-2-SPDY-和-WebSocket-代理协议"><a href="#使用SSL-HTTP-2-SPDY-和-WebSocket-代理协议" class="headerlink" title="使用SSL, HTTP/2, SPDY, 和 WebSocket 代理协议"></a>使用SSL, HTTP/2, SPDY, 和 WebSocket 代理协议</h3><ol>
<li><p>配置nginx接受代理协议报文头。在listen中添加proxy_protocol参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80   proxy_protocol;</div><div class="line">    listen 443  ssl proxy_protocol;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在set_real_ip_from 指令中，指定ip地址或者TCP代理的CIDR地址范围或者负载均衡器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    set_real_ip_from 192.168.1.0/24;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在real_ip_header指令中，添加proxy_protocol参数来保持客户端IP地址和端口号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    real_ip_header proxy_protocol;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>通过proxy_set_header directive 和 $proxy_protocol_addr变量从nginx传递IP地址到upstream服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proxy_set_header X-Real-IP       $proxy_protocol_addr;</div><div class="line">proxy_set_header X-Forwarded-For $proxy_protocol_addr;</div></pre></td></tr></table></figure>
</li>
<li><p>在http层添加 $proxy_protocol_addr 变量到  log_format指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    log_format combined &apos;$proxy_protocol_addr - $remote_user [$time_local] &apos;</div><div class="line">                        &apos;&quot;$request&quot; $status $body_bytes_sent &apos;</div><div class="line">                        &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&apos;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="在TCP流上使用代理协议"><a href="#在TCP流上使用代理协议" class="headerlink" title="在TCP流上使用代理协议"></a>在TCP流上使用代理协议</h3><p>nginx能够就在TCP流上传递代理协议数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    server &#123;</div><div class="line">        listen 12345;</div><div class="line">        proxy_pass example.com:12345;</div><div class="line">        proxy_protocol on;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="完整的样例"><a href="#完整的样例" class="headerlink" title="完整的样例"></a>完整的样例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    log_format combined &apos;$proxy_protocol_addr - $remote_user [$time_local] &apos;</div><div class="line">                        &apos;&quot;$request&quot; $status $body_bytes_sent &apos;</div><div class="line">                        &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&apos;;</div><div class="line">    ...</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        server_name localhost;</div><div class="line"></div><div class="line">        listen 80   proxy_protocol;</div><div class="line">        listen 443  ssl proxy_protocol;</div><div class="line"></div><div class="line">        ssl_certificate      /etc/nginx/ssl/public.example.com.pem;</div><div class="line">        ssl_certificate_key  /etc/nginx/ssl/public.example.com.key;</div><div class="line"></div><div class="line">        set_real_ip_from 192.168.1.0/24;</div><div class="line">        real_ip_header   proxy_protocol;</div><div class="line"></div><div class="line">        location /app/ &#123;</div><div class="line">            proxy_pass       http://backend1;</div><div class="line">            proxy_set_header Host            $host;</div><div class="line">            proxy_set_header X-Real-IP       $proxy_protocol_addr;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_protocol_addr;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; </div><div class="line"></div><div class="line">stream &#123;</div><div class="line">...</div><div class="line">    server &#123;</div><div class="line">        listen         12345;</div><div class="line">        proxy_pass     example.com:12345;</div><div class="line">        proxy_protocol on;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/Nginx学习笔记：四、配置SSL/" itemprop="url">
                  Nginx学习笔记：四、配置SSL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-18T09:30:57+08:00" content="2016-07-18">
              2016-07-18
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="通过HTTPS传递Web内容"><a href="#通过HTTPS传递Web内容" class="headerlink" title="通过HTTPS传递Web内容"></a>通过HTTPS传递Web内容</h2><h3 id="配置一个HTTPS服务"><a href="#配置一个HTTPS服务" class="headerlink" title="配置一个HTTPS服务"></a>配置一个HTTPS服务</h3><p>建立一个HTTPS的nginx服务器，在nginx.conf中指定服务器的ssl参数与listen指令，然后设置服务器证书和私钥文件的位置:</p>
<p>x509证书一般会用到三类文，key，csr，crt。</p>
<p>Key 是私用密钥openssl格，通常是rsa算法。</p>
<p>Csr 是证书请求文件，用于申请证书。在制作csr文件的时，必须使用自己的私钥来签署申，还可以设定一个密钥。</p>
<p>crt是CA认证后的证书文，（windows下面的，其实是crt），签署人用自己的key给你签署的凭证。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen              443 ssl;</div><div class="line">    server_name         www.example.com;</div><div class="line">    ssl_certificate     www.example.com.crt;</div><div class="line">    ssl_certificate_key www.example.com.key;</div><div class="line">    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers         HIGH:!aNULL:!MD5;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>服务器证书是一个公共实体。它被发送到每一个连接到服务器的客户端。私钥是一个安全的实体，并应被存储在与限制访问的文件。然而，Nginx的的master进程必须能够读取该文件。私钥也可以和公钥存储在同一个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssl_certificate xxx.cert;</div><div class="line">ssl_certificate_key xxx.cert;</div></pre></td></tr></table></figure></p>
<p>在这种情况下，文件的访问权限也需要被限制。虽然公钥和私钥在一个文件中，但是只有公钥会被发送到客户端。</p>
<p>ssl_protocols 和 ssl_ciphers 指令可以用来限制连接的版本和SSL/TLS的加密方式。</p>
<h3 id="https服务优化"><a href="#https服务优化" class="headerlink" title="https服务优化"></a>https服务优化</h3><p>SSL会给CPU带来额外的开销。最耗CPU的是SSL的握手过程。下面有两个方法能够减少每个客户端操作的数量：</p>
<ul>
<li>使keepalive连接通过一个连接发送多个请求</li>
<li>重用SSL会话参数来避免并行和随后的SSL握手连接</li>
</ul>
<p>session存储在SSL的 session缓存中，并被worker进程共享，这个可以用ssl_session_cache 配置。1M的cache可以包含大约4000个session。默认情况下，cache的超时时间是5分钟。超时时间可以用 ssl_session_timeout 来设置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">worker_processes auto;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    ssl_session_cache   shared:SSL:10m;</div><div class="line">    ssl_session_timeout 10m;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen              443 ssl;</div><div class="line">        server_name         www.example.com;</div><div class="line">        keepalive_timeout   70;</div><div class="line"></div><div class="line">        ssl_certificate     www.example.com.crt;</div><div class="line">        ssl_certificate_key www.example.com.key;</div><div class="line">        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">        ssl_ciphers         HIGH:!aNULL:!MD5;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="SSL证书链"><a href="#SSL证书链" class="headerlink" title="SSL证书链"></a>SSL证书链</h3><p>一些浏览器会报出证书不是由权威机构颁发的，而其他的浏览器则不会有这个问题。这是由于发行机构的证书不是由权威机构的中级证书签发的。这种情况下，发行机构应该提供一个证书链来和服务器证书绑定。在绑定文件中，公钥证书应该在证书链之前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cat www.example.com.crt bundle.crt &gt; www.example.com.chained.crt</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen              443 ssl;</div><div class="line">    server_name         www.example.com;</div><div class="line">    ssl_certificate     www.example.com.chained.crt;</div><div class="line">    ssl_certificate_key www.example.com.key;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="基于名称的HTTPS服务"><a href="#基于名称的HTTPS服务" class="headerlink" title="基于名称的HTTPS服务"></a>基于名称的HTTPS服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen          443 ssl;</div><div class="line">    server_name     www.example.com;</div><div class="line">    ssl_certificate www.example.com.crt;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen          443 ssl;</div><div class="line">    server_name     www.example.org;</div><div class="line">    ssl_certificate www.example.org.crt;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基于IP：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen          192.168.1.1:443 ssl;</div><div class="line">    server_name     www.example.com;</div><div class="line">    ssl_certificate www.example.com.crt;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen          192.168.1.2:443 ssl;</div><div class="line">    server_name     www.example.org;</div><div class="line">    ssl_certificate www.example.org.crt;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="使用HTTPS建立TCP连接"><a href="#使用HTTPS建立TCP连接" class="headerlink" title="使用HTTPS建立TCP连接"></a>使用HTTPS建立TCP连接</h2><p>nginx负责https的认证等操作，并把数据返回给后端的服务器处理，后端服务器是http服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    upstream stream_backend &#123;</div><div class="line">         server backend1.example.com:12345;</div><div class="line">         server backend2.example.com:12345;</div><div class="line">         server backend3.example.com:12345;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    server &#123;</div><div class="line">        listen                12345 ssl;</div><div class="line">        proxy_pass            stream_backend;</div><div class="line"> </div><div class="line">        ssl_certificate       /etc/ssl/certs/server.crt;</div><div class="line">        ssl_certificate_key   /etc/ssl/certs/server.key;</div><div class="line">        ssl_protocols         SSLv3 TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">        ssl_ciphers           HIGH:!aNULL:!MD5;</div><div class="line">        ssl_session_cache     shared:SSL:20m;</div><div class="line">        ssl_session_timeout   4h;</div><div class="line">        ssl_handshake_timeout 30s;</div><div class="line">		ssl_session_tickets on;</div><div class="line">    …</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>session Ticket 是另一种session缓存。session信息存储在客户端，减少了服务端存储session的压力。当客户端恢复与服务端的交互后，它会提供session并且可以不用再进行握手之类的操作。</p>
<h2 id="为nginx和后端服务器的HTTP连接加密"><a href="#为nginx和后端服务器的HTTP连接加密" class="headerlink" title="为nginx和后端服务器的HTTP连接加密"></a>为nginx和后端服务器的HTTP连接加密</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    upstream backend.example.com &#123;</div><div class="line">        server backend1.example.com:443;</div><div class="line">        server backend2.example.com:443;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      80;</div><div class="line">        server_name www.example.com;</div><div class="line">        ...</div><div class="line"></div><div class="line">        location /upstream &#123;</div><div class="line">            proxy_pass                    https://backend.example.com;</div><div class="line">            proxy_ssl_certificate         /etc/nginx/client.pem;</div><div class="line">            proxy_ssl_certificate_key     /etc/nginx/client.key</div><div class="line">            proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">            proxy_ssl_ciphers             HIGH:!aNULL:!MD5;</div><div class="line">            proxy_ssl_trusted_certificate /etc/nginx/trusted_ca_cert.crt;</div><div class="line"></div><div class="line">            proxy_ssl_verify        on;</div><div class="line">            proxy_ssl_verify_depth  2;</div><div class="line">            proxy_ssl_session_reuse on;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      443 ssl;</div><div class="line">        server_name backend1.example.com;</div><div class="line"></div><div class="line">        ssl_certificate        /etc/ssl/certs/server.crt;</div><div class="line">        ssl_certificate_key    /etc/ssl/certs/server.key;</div><div class="line">        ssl_client_certificate /etc/ssl/certs/ca.crt;</div><div class="line">        ssl_verify_client      off;</div><div class="line"></div><div class="line">        location /yourapp &#123;</div><div class="line">            proxy_pass http://url_to_app.com;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      443 ssl;</div><div class="line">        server_name backend2.example.com;</div><div class="line"></div><div class="line">        ssl_certificate        /etc/ssl/certs/server.crt;</div><div class="line">        ssl_certificate_key    /etc/ssl/certs/server.key;</div><div class="line">        ssl_client_certificate /etc/ssl/certs/ca.crt;</div><div class="line">        ssl_verify_client      off;</div><div class="line"></div><div class="line">        location /yourapp &#123;</div><div class="line">            proxy_pass http://url_to_app.com;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="为nginx和后端服务器的TCP连接加密"><a href="#为nginx和后端服务器的TCP连接加密" class="headerlink" title="为nginx和后端服务器的TCP连接加密"></a>为nginx和后端服务器的TCP连接加密</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    upstream backend.example.com &#123;</div><div class="line">        server backend1.example.com:443;</div><div class="line">        server backend2.example.com:443;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      80;</div><div class="line">        server_name www.example.com;</div><div class="line">        ...</div><div class="line"></div><div class="line">        location /upstream &#123;</div><div class="line">            proxy_pass                    https://backend.example.com;</div><div class="line">            proxy_ssl_certificate         /etc/nginx/client.pem;</div><div class="line">            proxy_ssl_certificate_key     /etc/nginx/client.key</div><div class="line">            proxy_ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">            proxy_ssl_ciphers             HIGH:!aNULL:!MD5;</div><div class="line">            proxy_ssl_trusted_certificate /etc/nginx/trusted_ca_cert.crt;</div><div class="line"></div><div class="line">            proxy_ssl_verify        on;</div><div class="line">            proxy_ssl_verify_depth  2;</div><div class="line">            proxy_ssl_session_reuse on;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      443 ssl;</div><div class="line">        server_name backend1.example.com;</div><div class="line"></div><div class="line">        ssl_certificate        /etc/ssl/certs/server.crt;</div><div class="line">        ssl_certificate_key    /etc/ssl/certs/server.key;</div><div class="line">        ssl_client_certificate /etc/ssl/certs/ca.crt;</div><div class="line">        ssl_verify_client      off;</div><div class="line"></div><div class="line">        location /yourapp &#123;</div><div class="line">            proxy_pass http://url_to_app.com;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      443 ssl;</div><div class="line">        server_name backend2.example.com;</div><div class="line"></div><div class="line">        ssl_certificate        /etc/ssl/certs/server.crt;</div><div class="line">        ssl_certificate_key    /etc/ssl/certs/server.key;</div><div class="line">        ssl_client_certificate /etc/ssl/certs/ca.crt;</div><div class="line">        ssl_verify_client      off;</div><div class="line"></div><div class="line">        location /yourapp &#123;</div><div class="line">            proxy_pass http://url_to_app.com;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/11/Nginx学习笔记：三、基本功能/" itemprop="url">
                  Nginx学习笔记：三、基本功能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-11T15:59:00+08:00" content="2016-07-11">
              2016-07-11
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Web服务"><a href="#Web服务" class="headerlink" title="Web服务"></a>Web服务</h2><h3 id="设置虚拟服务器"><a href="#设置虚拟服务器" class="headerlink" title="设置虚拟服务器"></a>设置虚拟服务器</h3><p>nginx配置文件中至少需要一个定义了虚拟服务器的server块。当nginx处理请求时，它会首先选择虚拟服务器来处理请求。<br>虚拟服务器定义在http上下文的server块中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    server &#123;</div><div class="line">        # Server configuration</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以在http上下文中定义多个server块。<br>server块通常包含一个listen指令来监听指定的ip的端口。支持ipv4/ipv6，ipv6的地址需要用（）包裹起来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 127.0.0.1:8080;</div><div class="line">    # The rest of server configuration</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果省略端口号，则使用标准端口号。如果省略ip，那么服务器将监听所有地址。如果省略listen指令，那么标准的端口号是80/tcp，默认的端口号是8000/tcp这取决于root的权限。</p>
<p>server_name 参数用来指定接受访问的host头中的相应参数。它的值可以是一个通配符。如果没有匹配的，那么将路由到默认的服务器上来处理。</p>
<h3 id="配置location"><a href="#配置location" class="headerlink" title="配置location"></a>配置location</h3><p>nginx可以将请求路由到不同的代理或者服务器上，基于请求的uri。这些都是依靠定义在server块中的localtion块来决定的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    root html;</div><div class="line">    index  index.html  index.htm;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有两种类型的参数：前缀字符串和正则表达式。对于一个请求URI，他必须满足匹配前缀字符串。</p>
<p>正则表达式前面增加 ~ 表示区分大小写，~* 表示不区分大小写。下面的例子匹配所有带有.html或者.htm的URI。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location ~ \.html? &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>为了找到最匹配URI的location，nginx会首先搜索前缀字符串，然后再搜索正则表达式。</strong></p>
<p>nginx的处理逻辑为：</p>
<ol>
<li>尝试匹配所有前缀字符串。</li>
<li>= 修饰符定义了一个URI和前缀字符串的精确匹配。如果发现精确匹配,搜索停止。</li>
<li>如果有^~修饰符，则最先考虑最长前缀字符串匹配,正则表达式不检查。</li>
<li>存储最长前缀匹配字符串。</li>
<li>尝试匹配正则表达式。</li>
<li>从第一个匹配的正则表达式跳出递归，并使用相应的location。</li>
<li>如果没有匹配的正则表达式，使用存储的最长匹配的前缀表达式（第4步）的location。</li>
</ol>
<p>location块中包含如何处理的逻辑，要么转到一个静态文件，要么将请求转给一个代理服务器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    location /images/ &#123;</div><div class="line">        root /data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://www.example.com;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h3><p>nginx允许在配置文件中使用自定义的变量。<br><code>set $variable value</code><br><code>map string $variable { ... }</code><br><code>geo [$address] $variable { ... }</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line"> geo $arg_boy $ttlsa_com &#123;</div><div class="line">        default 0;</div><div class="line">        127.0.0.1/24 24;</div><div class="line">        127.0.0.1/32 32;</div><div class="line">        8.8.8.8 2;</div><div class="line">&#125;</div><div class="line"> server &#123;</div><div class="line">        listen       8080;</div><div class="line">        server_name  test.ttlsa.com;</div><div class="line"> </div><div class="line">        location /hello &#123;</div><div class="line"> default_type text/plain;</div><div class="line"> echo $ttlsa_com;</div><div class="line"> echo $arg_boy;</div><div class="line"> &#125;</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"># curl 127.0.0.1:8080/hello?boy=127.0.0.1</div><div class="line">32</div><div class="line">127.0.0.1</div><div class="line"># curl 127.0.0.1:8080/hello?boy=127.0.0.12</div><div class="line">24</div><div class="line">127.0.0.12</div></pre></td></tr></table></figure>
<h3 id="返回指定状态码"><a href="#返回指定状态码" class="headerlink" title="返回指定状态码"></a>返回指定状态码</h3><p>一些网站URI需要立即返回指定的错误代码或重定向代码，例如，如果一个页面被暂时或永久的移除，那么，最简单的方法是直接返回相应的代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /wrong/url &#123;</div><div class="line">    return 404;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>return 的用法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">return code [text];</div><div class="line">return code URL;</div><div class="line">return URL;</div></pre></td></tr></table></figure></p>
<p>return 指令可以存在于location和server块中。</p>
<h3 id="重写URI请求"><a href="#重写URI请求" class="headerlink" title="重写URI请求"></a>重写URI请求</h3><p>一个请求的URI可以在处理请求过程中被重写多次，它包括一个可选的和两个必须的参数。第一个必须的参数是请求URI必须满足的正则表达式。第二个参数是用来替换请求URI的URI。可选的参数是一个标志位，它能停止进一步的重写处理或者发送重定向（301或302）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /users/ &#123;</div><div class="line">    rewrite ^/users/(.*)$ /show?user=$1 break;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>rewrite指令可以存在于server和location块中。在server块中，如果server的上下文被选中，那么server块中的rewrite只会执行一次。</p>
<p>rewrite指令用法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rewrite regex replacement [flag];</div></pre></td></tr></table></figure></p>
<p>flag 有以下可选值：<br>last: 重新请求搜索是否还有匹配的locaton。<br>break: 不再搜索是否还有匹配的location。<br>redirect：返回一个暂时的重定向代码 ， 302，使用一个不以”<a href="http://&quot;或&quot;https://&quot;开头的代替的字符串。" target="_blank" rel="external">http://&quot;或&quot;https://&quot;开头的代替的字符串。</a><br>permanent： 返回一个永久的重定向代码，301.</p>
<h3 id="重写HTTP返回"><a href="#重写HTTP返回" class="headerlink" title="重写HTTP返回"></a>重写HTTP返回</h3><p>有时候你需要重写或者修改HTTP返回中的内容，把一个字符串替换成其它的。那么，你需要使用sub_filter指令来定义重写。这个指令支持变量和链操作来使复杂的操作变得简单。<br>sub_filter的替换匹配是不区分大小写的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  www.github.com;</div><div class="line"> </div><div class="line">    root /data/site/www.github.com;    </div><div class="line"> </div><div class="line">    location / &#123;</div><div class="line">        sub_filter  github &apos;GIT&apos;;</div><div class="line">        sub_filter_types text/html;</div><div class="line">        sub_filter_once on;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子将返回数据中的github替换为GIT，然后由于sub_filter_once on ， 所以只替换了一次。结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># curl www.github.com/2013/10/20131001_sub1.html           </div><div class="line">welcome to GIT!</div><div class="line">github TEAM!</div></pre></td></tr></table></figure></p>
<p>sub_filter 可以存在于 http, server, location 块。</p>
<h3 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h3><p>使用error_page 指令，可以为特定的错误码自定义错误页面。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error_page 404 /404.html;</div></pre></td></tr></table></figure></p>
<p>下面的例子中，将404转换为301，并重定向到http:/example.com/new/path.html。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /old/path.html &#123;</div><div class="line">    error_page 404 =301 http:/example.com/new/path.html;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="静态文件服务"><a href="#静态文件服务" class="headerlink" title="静态文件服务"></a>静态文件服务</h2><h3 id="Root目录和索引文件"><a href="#Root目录和索引文件" class="headerlink" title="Root目录和索引文件"></a>Root目录和索引文件</h3><p>root指令制定了将要去搜索文件的根目录。为了获得文件路径，nginx为请求的URI添加了指定的root路径。root指令可以在http、server和location块中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    root /www/data;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /images/ &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location ~ \.(mp3|mp4) &#123;</div><div class="line">        root /www/media;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子中，如果URI以/images/开始，那么，搜索的路径为/www/data/images/目录。如果URI以.mp3或者.mp4结尾，那么搜索的路径为/www/media/。</p>
<p>如果请求是以/结尾，那么，nginx将其认为是请求目录结构并查找目录里面的索引文件。index命令定义了索引文件名（默认名称为index.html）。接着上面的例子，如果请求是 /images/some/path/ ， nginx将传送文件/www/data/images/some/path/index.html，如果存在的话。如果不存在，nginx返回404。为了让NGINX返回一个自动生成的目录清单,加入autoindex指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /images/ &#123;</div><div class="line">    autoindex on;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可以列举不只一个文件名在index指令下。nginx以指定的顺序搜索文件并返回第一个。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    index index.$geo.html index.htm index.html;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的$geo变量是一个自定义的geo。它的值取决于客户端的ip地址。</p>
<p>autoindex_exact_size on | off 表示是否显示大小。<br>autoindex_format html | xml | json | jsonp 输出格式<br>autoindex_localtime on | off  显示本地时间或UTC</p>
<h3 id="其它的命令"><a href="#其它的命令" class="headerlink" title="其它的命令"></a>其它的命令</h3><p>try_files 用来检查指定的文件或者目录是否存在，并设置一个重定向或者返回一个指定的状态码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    root /www/data;</div><div class="line"></div><div class="line">    location /images/ &#123;</div><div class="line">        try_files $uri /images/default.gif;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后一个参数可以是状态码或者位置。在下面的例子中，如果try_files的参数中的文件或目录不存在，则返回404。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    try_files $uri $uri/ $uri.html =404;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在下面的例子中，如果原始的URI和URI后面加上/的目录均不存在，那么请求会被重定向到一个代理服务器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    try_files $uri $uri/ @backend;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location @backend &#123;</div><div class="line">    proxy_pass http://backend.example.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="提高nginx内容服务速度"><a href="#提高nginx内容服务速度" class="headerlink" title="提高nginx内容服务速度"></a>提高nginx内容服务速度</h3><p>加载速度是重要的考虑因素。做一些小幅的优化配置可能会大幅提高效率甚至达到最佳性能。</p>
<ul>
<li><p>开启sendfile<br>默认情况下，nginx自己控制文件传输，并在发送前把它拷贝到buffer中。使用sendfile命令可以减少拷贝到buffer的步骤，并且直接将一个文件描述符拷贝到另一个。另外,防止一个快速连接完全占用worker进程,可以在sendfile()调用sendfile_max_chunk指令限制传输的数据量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /mp3 &#123;</div><div class="line">    sendfile           on;</div><div class="line">    sendfile_max_chunk 1m;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>开启tcp_nopush<br>配合sendfile一起使用tcp_nopush。一般情况下，在tcp交互的过程中，当应用程序接收到数据包后马上传送出去，不等待，而tcp_cork选项是数据包不会马上传送出去，等到数据包最大时，一次性的传输出去，这样有助于解决网络堵塞，已经是默认了,tcp_nopush = on 会设置调用tcp_cork方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /mp3 &#123;</div><div class="line">    sendfile   on;</div><div class="line">    tcp_nopush on;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>开启tcp_nodelay<br>与tcp_nopush 是互斥的，有数据的话会立即将数据包发送出去，有可能会造成网络拥堵。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /mp3  &#123;</div><div class="line">    tcp_nodelay       on;</div><div class="line">    keepalive_timeout 65;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>优化Backlog Queue<br>nginx处理连接请求也是一个非常重要的优化点。一般情况下，当一个连接建立后，它会被放入listen socket的listen队列。在普通负载下，这是一个小的甚至不存在的队列。但是高负载时，队列会显著增长，这可能导致连接断开或者高延迟。<br><strong>检查listen queue</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -lan</div></pre></td></tr></table></figure>
</li>
</ul>
<p>结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Current listen queue sizes (qlen/incqlen/maxqlen)</div><div class="line">Listen         Local Address         </div><div class="line">0/0/128        *.12345            </div><div class="line">10/0/128        *.80       </div><div class="line">0/0/128        *.8080</div></pre></td></tr></table></figure></p>
<p>说明有10个在80端口的连接未被处理。<br><strong>设置OS</strong><br>设置 net.core.somaxconn 来增大OS的负载能力。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi   /etc/sysctl.conf</div><div class="line">net.core.somaxconn = 4096</div></pre></td></tr></table></figure></p>
<p><strong>设置nginx</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80 backlog 4096;</div><div class="line">    # The rest of server configuration</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="发送请求到代理服务器"><a href="#发送请求到代理服务器" class="headerlink" title="发送请求到代理服务器"></a>发送请求到代理服务器</h3><p>当使用nginx代理时，会发送请求到代理服务器，获取相应，然后返回给客户端。它可以代理HTTP请求也可以代理非HTTP请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    proxy_pass http://www.example.com/link/;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="发送请求头到代理服务器"><a href="#发送请求头到代理服务器" class="headerlink" title="发送请求头到代理服务器"></a>发送请求头到代理服务器</h3><p>默认情况下，nginx会重新定义请求头中的两个域，Host和Connection，Host被设置为$proxy_host变量，Connection被设置为 close。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    proxy_set_header Host $host;</div><div class="line">    proxy_set_header X-Real-IP $remote_addr;</div><div class="line">    proxy_pass http://localhost:8000;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>防止某个域传递到代理服务器，可以将其设置为空：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    proxy_set_header Accept-Encoding &quot;&quot;;</div><div class="line">    proxy_pass http://localhost:8000;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="设置Buffer"><a href="#设置Buffer" class="headerlink" title="设置Buffer"></a>设置Buffer</h3><p>一般情况下，nginx缓冲代理服务器的相应，直到收到整个相应信息才发送给客户端。缓冲机制能够优化慢客户端，因为如果对于慢客户端nginx同步响应，那么会浪费代理服务器时间。<br><strong>proxy_buffering</strong>，该指令设置缓冲区的大小和数量,从被代理的后端服务器取得的响应内容,会放置到这里. 默认情况下,一个缓冲区的大小等于内存页面大小,可能是4K也可能是8K,这取决于平台。proxy_buffers 8  4k/8k。<br><strong>proxy_buffer_size</strong>，该指令设置缓冲区大小,从代理后端服务器取得的第一部分的响应内容,会放到这里.小的响应header通常位于这部分响应内容里边.默认来说,该缓冲区大小等于指令 proxy_buffers所设置的;但是,你可以把它设置得更小。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    proxy_buffers 16 4k;</div><div class="line">    proxy_buffer_size 2k;</div><div class="line">    proxy_pass http://localhost:8000;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果关闭buffer：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /some/path/ &#123;</div><div class="line">    proxy_buffering off;</div><div class="line">    proxy_pass http://localhost:8000;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="绑定出口IP"><a href="#绑定出口IP" class="headerlink" title="绑定出口IP"></a>绑定出口IP</h3><p>如果你的代理服务器有多个网络接口，有时需要选择其中一个进行绑定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">location /app1/ &#123;</div><div class="line">    proxy_bind 127.0.0.1;</div><div class="line">    proxy_pass http://example.com/app1/;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location /app2/ &#123;</div><div class="line">    proxy_bind 127.0.0.2;</div><div class="line">    proxy_pass http://example.com/app2/;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以使用变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /app3/ &#123;</div><div class="line">    proxy_bind $server_addr;</div><div class="line">    proxy_pass http://example.com/app3/;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="压缩和解压缩"><a href="#压缩和解压缩" class="headerlink" title="压缩和解压缩"></a>压缩和解压缩</h2><p>亚索形影数据对于减小传输数据是非常重要的。然而，在运行时进行压缩还有可能对系统有负面影响。nginx在发送相应数据前进行压缩，但是不会对已经压缩过的数据进行二次压缩（例如，对于代理服务器的）。</p>
<h3 id="开启压缩"><a href="#开启压缩" class="headerlink" title="开启压缩"></a>开启压缩</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gzip on;</div></pre></td></tr></table></figure>
<p>通常情况下，nginx仅对MIME类型为text/html的相应进行压缩。为了添加压缩的类型，可以使用gzip_types命令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gzip_types text/plain application/xml;</div></pre></td></tr></table></figure></p>
<p>指定压缩响应的最小长度，使用gzip_min_length指令。默认是20bytes。（这里设置为1000）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gzip_min_length 1000;</div></pre></td></tr></table></figure></p>
<p>一般情况下，nginx不会压缩代理服务器的请求响应。该请求来自代理服务器的事实是由Via头字段的请求中的存在来确定。使用gzip_proxied指令来配置这些响应的压缩。这个指令有很多参数，来确定哪种代理请求nginx需要压缩。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gzip_proxied no-cache no-store private expired auth;</div></pre></td></tr></table></figure></p>
<p>一个完整的例子是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    gzip on;</div><div class="line">    gzip_types      text/plain application/xml;</div><div class="line">    gzip_proxied    no-cache no-store private expired auth;</div><div class="line">    gzip_min_length 1000;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="开启解压缩"><a href="#开启解压缩" class="headerlink" title="开启解压缩"></a>开启解压缩</h3><p>一些客户端不支持gzip编码算法。同时，它又想要存储压缩数据或者压缩相应数据并存入缓存。为了成功发送到客户端，nginx支持在发送到最终客户端时解压缩数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /storage/ &#123;</div><div class="line">    gunzip on;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="发送压缩文件"><a href="#发送压缩文件" class="headerlink" title="发送压缩文件"></a>发送压缩文件</h3><p>使用gzip_static 命令可以发送一个压缩版本的文件到客户端，若要使用它需要在编译的时候把gzip_static模块编译进去：<br><code>./configure --with-http_gzip_static_module</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    gzip_static on;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当请求 /path/to/file，nginx会查找并发送/path/to/file.gz。如果文件不存在或者客户端不支持gzip，nginx会发送未压缩版本。<br>注意，gzip_static指令不支持实时压缩。它只是使用压缩工具预先压缩文件。要压缩在运行时的内容（不仅是静态内容），使用gzip的指令。</p>
<h2 id="页面内容缓存"><a href="#页面内容缓存" class="headerlink" title="页面内容缓存"></a>页面内容缓存</h2><p>nginx支持缓存，当开启缓存后，nginx缓存从代理服务器返回的数据，并将其缓存到硬盘上，当有请求过来时，先去缓存查找响应。</p>
<h3 id="开启响应缓存"><a href="#开启响应缓存" class="headerlink" title="开启响应缓存"></a>开启响应缓存</h3><p>将 proxy_cache_path 放到http块中来开启缓存。第一个参数是存放缓存文件的路径。keys_zone定义了用于存储缓存条目元数据的共享存储空间名称和大小。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    proxy_cache_path /data/nginx/cache keys_zone=one:10m;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将proxy_cache放入想进行缓存的协议类型、server块或者location块中。并指定proxy_cache_path中的key_zone。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    proxy_cache_path /data/nginx/cache keys_zone=one:10m;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        proxy_cache one;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://localhost:8000;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>值得注意的是，key_zone定义的大小并不限制缓存相应数据的总量。缓存的响应数据本身存储为元数据的一个备份，存在指定的file上。为了限制缓存的数量，可以使用proxy_cache_path的max_size参数，缓存数量可以暂时超过max_size。</p>
<h3 id="控制缓存"><a href="#控制缓存" class="headerlink" title="控制缓存"></a>控制缓存</h3><p>缓存管理器会定期检查缓存的状态。如果缓存大小超过proxy_cache_path中 max_size参数设定的限制,缓存管理器删除最近最少访问的数据。正如前面提到的,缓存数据的数量可以暂时超过限制缓存管理器激活的时间期间。<br>缓存加载器仅会在nginx启动后启动一次。它会将之前缓存的数据加载进来。加载一次缓存可能会消耗大量资源，影响nginx启动后几分钟内的性能。下面有proxy_cacahe_path的几个参数来避免这一情况：</p>
<ul>
<li>loader_threshold ： 加载时间上限，单位是毫秒，默认为200毫秒。</li>
<li>loader_files： 一次迭代的最多条目数，默认是100。</li>
<li>loader_sleeps ： 迭代的间隔，单位是毫秒，默认50。</li>
</ul>
<p><code>proxy_cache_path /data/nginx/cache keys_zone=one:10m loader_threshold=300 loader_files=200;</code></p>
<h3 id="指定对哪个请求进行缓存"><a href="#指定对哪个请求进行缓存" class="headerlink" title="指定对哪个请求进行缓存"></a>指定对哪个请求进行缓存</h3><p>一般情况下，nginx缓存http的get和head方法响应的数据。nginx将请求字符串作为请求的key。如果缓存中存在和请求相同的key，nginx会直接用缓存来响应。可以在http，server，location的上下文中控制哪些进行缓存。</p>
<p>为了改变请求的单词来计算key，可以使用proxy_cache_key:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_key &quot;$host$request_uri$cookie_user&quot;;</div></pre></td></tr></table></figure></p>
<p>定义在必须在请求指定的最低次数以后，响应才会被缓存起来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_min_uses 5;</div></pre></td></tr></table></figure></p>
<p>缓存除了GET和HEAD的其他请求，get和head也需要被列举出来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_methods GET HEAD POST;</div></pre></td></tr></table></figure></p>
<h3 id="限制或绕过缓存"><a href="#限制或绕过缓存" class="headerlink" title="限制或绕过缓存"></a>限制或绕过缓存</h3><p>默认情况下，响应数据会一直在缓存中。它们只有在缓存超过最大值时，并且它们是最少命中的，才会被淘汰。nginx可以设置淘汰策略：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proxy_cache_valid 200 302 10m;</div><div class="line">proxy_cache_valid 404      1m;</div></pre></td></tr></table></figure></p>
<p>上面的例子中，返回200或者302都被认为是在10分钟以内有效的。返货404在1分钟以内也是有效的。也可以使用<code>any</code>来设置第一个参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_valid any 5m;</div></pre></td></tr></table></figure></p>
<p>可以定义proxy_cache_bypass指令来决定是否使用cache响应请求。每个参数定义了一个条件并且由变量组成。如果至少有一个参数为空并且不等于0，nginx不会从cache查找响应，会直接去后端服务器请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_bypass $cookie_nocache $arg_nocache$arg_comment;</div></pre></td></tr></table></figure></p>
<p><code>proxy_cache_bypass string ...;</code></p>
<p>控制哪些请求不进行缓存<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_no_cache $http_pragma $http_authorization;</div></pre></td></tr></table></figure></p>
<h3 id="从缓存中清除内容"><a href="#从缓存中清除内容" class="headerlink" title="从缓存中清除内容"></a>从缓存中清除内容</h3><p>NGINX可以从缓存中删除过期的缓存文件。这是非常必要的,删除过期的缓存内容,防止同时提供新老版本的web页面。清除缓存时，nginx会收到一个特别的“清除”请求包含一个自定义HTTP头,或“清除”的HTTP方法。</p>
<ul>
<li>配置缓存清除<br>下面配置一个清除的HTTP方法并删除匹配的URL。<br>在http块中，新建一个变量，如下面的 $purge_method ， 它依赖于$request_method变量。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    map $request_method $purge_method &#123;</div><div class="line">        PURGE 1;</div><div class="line">        default 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在location块中已经定义了cache，在 proxy_cache_purge 指令中，指定了会被清除cache的条件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen      80;</div><div class="line">    server_name www.example.com;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass  https://localhost:8002;</div><div class="line">        proxy_cache mycache;</div><div class="line"></div><div class="line">        proxy_cache_purge $purge_method;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当 $request_method 为PURGE，则清除。否则不清除。</p>
<ul>
<li>发送清除指令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl -X PURGE -D – &quot;https://www.example.com/*&quot;</div><div class="line">HTTP/1.1 204 No Content</div><div class="line">Server: nginx/1.5.7</div><div class="line">Date: Sat, 01 Dec 2015 16:33:04 GMT</div><div class="line">Connection: keep-alive</div></pre></td></tr></table></figure>
</li>
</ul>
<p>上例中，指定的URI中的缓存文件并不删除，它们还会继续存储在磁盘上，直到nginx来操作处理。</p>
<ul>
<li><p>限制访问清除指令<br>比较推荐的是通过设置IP白名单来限制访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">geo $purge_allowed &#123;</div><div class="line">   default         0;  # deny from other</div><div class="line">   10.0.0.1        1;  # allow from localhost</div><div class="line">   192.168.0.0/24  1;  # allow from 10.0.0.0/24</div><div class="line">&#125;</div><div class="line"></div><div class="line">map $request_method $purge_method &#123;</div><div class="line">   PURGE   $purge_allowed;</div><div class="line">   default 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>完全删除cache文件<br><code>proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=mycache:10m purger=on;</code><br>在 proxy_cache_path 加上 purger=on参数。</p>
</li>
<li>完整的例子<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=mycache:10m purger=on;</div><div class="line"></div><div class="line">    map $request_method $purge_method &#123;</div><div class="line">        PURGE 1;</div><div class="line">        default 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen      80;</div><div class="line">        server_name www.example.com;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            proxy_pass        https://localhost:8002;</div><div class="line">            proxy_cache       mycache;</div><div class="line">            proxy_cache_purge $purge_method;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    geo $purge_allowed &#123;</div><div class="line">       default         0;</div><div class="line">       10.0.0.1        1;</div><div class="line">       192.168.0.0/24  1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    map $request_method $purge_method &#123;</div><div class="line">       PURGE   $purge_allowed;</div><div class="line">       default 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Byte范围的缓存"><a href="#Byte范围的缓存" class="headerlink" title="Byte范围的缓存"></a>Byte范围的缓存</h3><p>有时候，将数据放入缓存中是一个很费时的操作，特别是大文件。当第一次请求开始下载一个大文件时，下一次请求必须等待整个文件下载并放入缓存后才能被服务。<br>nginx可以使用cache slice module 来处理。文件被分成较小的“片”。每个请求范围选择特定的片,如果这个范围没有被缓存,那么将会把它放到缓存中。然后其它所有请求这个片数据的请求都会被这个缓存响应。<br>开启范围级别的缓存：</p>
<ol>
<li>为nginx编译进slice模块。</li>
<li><p>指定每个片的大小。片大小应足以使切片快速下载。设置太小可能会导致过度的内存使用和大量的文件描述符,过大的值可能会导致延迟。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    slice  1m;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在cache key中加入$slice_range<br><code>proxy_cache_key $uri$is_args$args$slice_range;</code></p>
</li>
<li>开启响应的206代码<br><code>proxy_cache_valid 200 206 1h;</code></li>
<li>在发往代理服务器的HTTP头的Range里面加入$slice_range。<br><code>proxy_set_header  Range $slice_range;</code></li>
<li>综合样例<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    slice             1m;</div><div class="line">    proxy_cache       cache;</div><div class="line">    proxy_cache_key   $uri$is_args$args$slice_range;</div><div class="line">    proxy_set_header  Range $slice_range;</div><div class="line">    proxy_cache_valid 200 206 1h;</div><div class="line">    proxy_pass        http://localhost:8000;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="ChenPeng" />
          <p class="site-author-name" itemprop="name">ChenPeng</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/chenpeng89" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ChenPeng</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
